(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();class P{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return new P(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new P(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return new P(this.x*t,this.y*t,this.z*t)}len(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){const t=this.len()||1;return new P(this.x/t,this.y/t,this.z/t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new P(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}clone(){return new P(this.x,this.y,this.z)}}class v{constructor(){this.m=new Float64Array(16),this.m[0]=this.m[5]=this.m[10]=this.m[15]=1}static identity(){return new v}static perspective(t,e,s,i){const a=new v,n=a.m,o=1/Math.tan(t/2),h=1/(s-i);return n.fill(0),n[0]=o/e,n[5]=o,n[10]=(i+s)*h,n[11]=-1,n[14]=2*i*s*h,a}static translation(t,e,s){const i=new v;return i.m[12]=t,i.m[13]=e,i.m[14]=s,i}static rotationX(t){const e=new v,s=Math.cos(t),i=Math.sin(t);return e.m[5]=s,e.m[6]=i,e.m[9]=-i,e.m[10]=s,e}static rotationY(t){const e=new v,s=Math.cos(t),i=Math.sin(t);return e.m[0]=s,e.m[2]=-i,e.m[8]=i,e.m[10]=s,e}static rotationZ(t){const e=new v,s=Math.cos(t),i=Math.sin(t);return e.m[0]=s,e.m[1]=i,e.m[4]=-i,e.m[5]=s,e}static scaling(t,e,s){const i=new v;return i.m[0]=t,i.m[5]=e,i.m[10]=s,i}multiply(t){const e=new v,s=this.m,i=t.m,a=e.m;for(let n=0;n<4;n++)for(let o=0;o<4;o++)a[o*4+n]=s[n]*i[o*4]+s[4+n]*i[o*4+1]+s[8+n]*i[o*4+2]+s[12+n]*i[o*4+3];return e}invert(){const t=this.m,e=new v,s=e.m,i=t[0],a=t[1],n=t[2],o=t[3],h=t[4],c=t[5],u=t[6],r=t[7],d=t[8],p=t[9],g=t[10],_=t[11],k=t[12],w=t[13],y=t[14],x=t[15],E=i*c-a*h,C=i*u-n*h,A=i*r-o*h,M=a*u-n*c,B=a*r-o*c,D=n*r-o*u,R=d*w-p*k,G=d*y-g*k,$=d*x-_*k,Y=p*y-g*w,I=p*x-_*w,N=g*x-_*y;let f=E*N-C*I+A*Y+M*$-B*G+D*R;return f&&(f=1/f,s[0]=(c*N-u*I+r*Y)*f,s[1]=(n*I-a*N-o*Y)*f,s[2]=(w*D-y*B+x*M)*f,s[3]=(g*B-p*D-_*M)*f,s[4]=(u*$-h*N-r*G)*f,s[5]=(i*N-n*$+o*G)*f,s[6]=(y*A-k*D-x*C)*f,s[7]=(d*D-g*A+_*C)*f,s[8]=(h*I-c*$+r*R)*f,s[9]=(a*$-i*I-o*R)*f,s[10]=(k*B-w*A+x*E)*f,s[11]=(p*A-d*B-_*E)*f,s[12]=(c*G-h*Y-u*R)*f,s[13]=(i*Y-a*G+n*R)*f,s[14]=(w*C-k*M-y*E)*f,s[15]=(d*M-p*C+g*E)*f),e}toCSS(){const t=this.m;return`matrix3d(${t[0]},${t[1]},${t[2]},${t[3]},${t[4]},${t[5]},${t[6]},${t[7]},${t[8]},${t[9]},${t[10]},${t[11]},${t[12]},${t[13]},${t[14]},${t[15]})`}transformPoint(t){const e=this.m,s=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15]||1;return new P((e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12])/s,(e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13])/s,(e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14])/s)}}const z=Math.PI/180;class at{constructor(t="orbit"){this.mode=t,this.state={position:new P(0,5,10),rotationX:-25,rotationY:45,distance:20,target:new P(0,0,0)}}getViewMatrix(t=1){const e=t;if(this.mode==="orbit"){const n=v.rotationX(this.state.rotationX*z),o=v.rotationY(this.state.rotationY*z),h=v.translation(-this.state.target.x*e,this.state.target.y*e,-this.state.target.z*e);return v.translation(0,0,-this.state.distance*e).multiply(n).multiply(o).multiply(h)}const s=v.rotationX(-this.state.rotationX*z),i=v.rotationY(-this.state.rotationY*z),a=v.translation(-this.state.position.x*e,this.state.position.y*e,-this.state.position.z*e);return s.multiply(i).multiply(a)}orbit(t,e){this.state.rotationY+=t,this.state.rotationX=Math.max(-89,Math.min(89,this.state.rotationX+e))}zoom(t){this.state.distance=Math.max(2,Math.min(100,this.state.distance+t))}moveLocal(t,e,s){const i=this.state.rotationY*z,a=Math.sin(i),n=Math.cos(i);this.state.position.x+=e*n-t*a,this.state.position.y+=s,this.state.position.z+=e*a+t*n}}class nt{constructor(t,e,s=800,i=20){this.camera=e,this._perspectivePx=s,this._voxelSize=i,this.root=document.createElement("div"),this.root.className="voxel-world",Object.assign(this.root.style,{position:"relative",width:"100%",height:"100%",overflow:"hidden",contain:"strict",perspective:`${s}px`,perspectiveOrigin:"50% 50%"}),this.world=document.createElement("div"),Object.assign(this.world.style,{position:"absolute",left:"50%",top:"50%",transformStyle:"preserve-3d",willChange:"transform"}),this.root.appendChild(this.world),t.appendChild(this.root)}get voxelSize(){return this._voxelSize}get perspectivePx(){return this._perspectivePx}render(){const t=this.camera.getViewMatrix(this._voxelSize);this.world.style.transform=t.toCSS()}destroy(){this.root.remove()}}class ht{constructor(t){this.state={keys:new Set,pointerDown:!1,pointerX:0,pointerY:0,deltaX:0,deltaY:0,pinchDelta:0},this._listeners=[],this._lastTouchDist=0,this._el=t,this._bind()}onVoxelClick(t){this._onVoxelClick=t}resetDeltas(){this.state.deltaX=0,this.state.deltaY=0,this.state.pinchDelta=0}_on(t,e,s,i){t.addEventListener(e,s,i),this._listeners.push([t,e,s])}_bind(){this._on(window,"keydown",t=>{this.state.keys.add(t.code)}),this._on(window,"keyup",t=>{this.state.keys.delete(t.code)}),this._on(this._el,"mousedown",t=>{this.state.pointerDown=!0;const e=t;this.state.pointerX=e.clientX,this.state.pointerY=e.clientY}),this._on(window,"mouseup",()=>{this.state.pointerDown=!1}),this._on(window,"mousemove",t=>{const e=t;this.state.pointerDown&&(this.state.deltaX+=e.clientX-this.state.pointerX,this.state.deltaY+=e.clientY-this.state.pointerY),this.state.pointerX=e.clientX,this.state.pointerY=e.clientY}),this._on(this._el,"wheel",t=>{t.preventDefault(),this.state.pinchDelta+=t.deltaY*.01},{passive:!1}),this._on(this._el,"touchstart",t=>{t.preventDefault();const e=t;e.touches.length===1&&(this.state.pointerDown=!0,this.state.pointerX=e.touches[0].clientX,this.state.pointerY=e.touches[0].clientY),e.touches.length===2&&(this._lastTouchDist=this._touchDist(e))},{passive:!1}),this._on(this._el,"touchmove",t=>{t.preventDefault();const e=t;if(e.touches.length===1&&this.state.pointerDown){const s=e.touches[0].clientX,i=e.touches[0].clientY;this.state.deltaX+=s-this.state.pointerX,this.state.deltaY+=i-this.state.pointerY,this.state.pointerX=s,this.state.pointerY=i}if(e.touches.length===2){const s=this._touchDist(e);this.state.pinchDelta+=(this._lastTouchDist-s)*.05,this._lastTouchDist=s}},{passive:!1}),this._on(this._el,"touchend",()=>{this.state.pointerDown=!1}),this._on(this._el,"click",t=>{const e=t.target;e.dataset.vx!==void 0&&this._onVoxelClick&&this._onVoxelClick({x:Number(e.dataset.vx),y:Number(e.dataset.vy),z:Number(e.dataset.vz),normal:e.dataset.normal||""})})}_touchDist(t){const e=t.touches[0].clientX-t.touches[1].clientX,s=t.touches[0].clientY-t.touches[1].clientY;return Math.sqrt(e*e+s*s)}destroy(){for(const[t,e,s]of this._listeners)t.removeEventListener(e,s);this._listeners.length=0}}class ct{constructor(t){this._nodes=[],this._worldEl=t}add(t){this._nodes.push(t),this._worldEl.appendChild(t.el),t.update()}remove(t){const e=this._nodes.indexOf(t);e>=0&&this._nodes.splice(e,1),t.destroy()}clear(){for(const t of this._nodes)t.destroy();this._nodes.length=0}update(){for(const t of this._nodes)t.update()}get nodes(){return this._nodes}}class dt{constructor(t){this._running=!1,this._paused=!1,this._rafId=0,this._lastTime=0,this._updateCbs=[],this._tick=s=>{if(!this._running)return;if(this._rafId=requestAnimationFrame(this._tick),this._paused){this._lastTime=s;return}const i=Math.min((s-this._lastTime)/1e3,.1);this._lastTime=s;for(const a of this._updateCbs)a(i);this.scene.update(),this.renderer.render(),this.input.resetDeltas()};const e=typeof t.container=="string"?document.querySelector(t.container):t.container;if(!e)throw new Error("VoxelDOM: container not found");this.camera=new at("orbit"),this.renderer=new nt(e,this.camera,t.perspective??800,t.voxelSize??16),this.scene=new ct(this.renderer.world),this.input=new ht(this.renderer.root)}get voxelSize(){return this.renderer.voxelSize}get running(){return this._running}get paused(){return this._paused}onUpdate(t){this._updateCbs.push(t)}clearCallbacks(){this._updateCbs.length=0}onVoxelClick(t){this.input.onVoxelClick(t)}start(){this._running||(this._running=!0,this._paused=!1,this._lastTime=performance.now(),this._tick(this._lastTime))}stop(){this._running=!1,cancelAnimationFrame(this._rafId)}pause(){this._paused=!0}resume(){this._paused=!1,this._lastTime=performance.now()}destroy(){this.stop(),this.scene.clear(),this.input.destroy(),this.renderer.destroy()}}const ut=[{normal:"top",axis:1,u:0,v:2,dir:1},{normal:"bottom",axis:1,u:0,v:2,dir:-1},{normal:"right",axis:0,u:2,v:1,dir:1},{normal:"left",axis:0,u:2,v:1,dir:-1},{normal:"front",axis:2,u:0,v:1,dir:1},{normal:"back",axis:2,u:0,v:1,dir:-1}];function pt(l,t,e=32){const s=[],i=e*e;function a(c,u,r){return c+u*e+r*i}function n(c,u,r){return c<0||c>=e||u<0||u>=e||r<0||r>=e?!1:l[a(c,u,r)]!==0}function o(c,u,r){return c<0||c>=e||u<0||u>=e||r<0||r>=e?0:l[a(c,u,r)]}const h=new Int32Array(e*e);for(const c of ut)for(let u=0;u<e;u++){h.fill(0);for(let r=0;r<e;r++)for(let d=0;d<e;d++){const p=[0,0,0];p[c.axis]=u,p[c.u]=d,p[c.v]=r;const g=o(p[0],p[1],p[2]);if(g===0)continue;const _=[0,0,0];_[c.axis]=u+c.dir,_[c.u]=d,_[c.v]=r,!n(_[0],_[1],_[2])&&(h[r*e+d]=g)}for(let r=0;r<e;r++)for(let d=0;d<e;){const p=h[r*e+d];if(p===0){d++;continue}let g=1;for(;d+g<e&&h[r*e+d+g]===p;)g++;let _=1,k=!1;for(;r+_<e&&!k;){for(let y=0;y<g;y++)if(h[(r+_)*e+d+y]!==p){k=!0;break}k||_++}for(let y=0;y<_;y++)for(let x=0;x<g;x++)h[(r+y)*e+d+x]=0;const w=[0,0,0];w[c.axis]=u,w[c.u]=d,w[c.v]=r,s.push({x:w[0],y:w[1],z:w[2],w:g,h:_,normal:c.normal,color:t[p]||"#ff00ff"}),d+=g}}return s}const _t={top:1,front:.85,back:.7,right:.8,left:.75,bottom:.6};class rt{constructor(t=16){this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.scale={x:1,y:1,z:1},this._faceEls=[],this._faceCount=0,this._voxelSize=t,this.el=document.createElement("div"),this.el.style.position="absolute",this.el.style.transformStyle="preserve-3d",this.el.style.willChange="transform"}get faceCount(){return this._faceCount}rebuildFromGrid(t,e,s=32){const i=pt(t,e,s);this._faceCount=i.length;for(const n of this._faceEls)n.remove();this._faceEls.length=0;const a=this._voxelSize;for(const n of i){const o=document.createElement("div"),h=n.w*a,c=n.h*a;o.className="vf",o.style.cssText=`position:absolute;width:${h}px;height:${c}px;backface-visibility:hidden;transform-origin:0 0;image-rendering:pixelated;pointer-events:auto;background:${n.color};filter:brightness(${_t[n.normal]})`,o.style.transform=gt(n,a),o.dataset.n=n.normal,o.dataset.x=String(n.x),o.dataset.y=String(n.y),o.dataset.z=String(n.z),this.el.appendChild(o),this._faceEls.push(o)}}update(){const t=this._voxelSize,e=v.translation(this.position.x*t,-this.position.y*t,this.position.z*t),s=v.rotationY(this.rotation.y*z);this.el.style.transform=e.multiply(s).toCSS()}destroy(){for(const t of this._faceEls)t.remove();this._faceEls.length=0,this.el.remove()}}function gt(l,t){const e=l.x,s=l.y,i=l.z;switch(l.normal){case"top":return`translate3d(${e*t}px,${-(s+1)*t}px,${i*t}px) rotateX(90deg)`;case"bottom":return`translate3d(${e*t}px,${-s*t}px,${(i+l.h)*t}px) rotateX(-90deg)`;case"front":return`translate3d(${e*t}px,${-(s+l.h)*t}px,${(i+1)*t}px)`;case"back":return`translate3d(${(e+l.w)*t}px,${-(s+l.h)*t}px,${i*t}px) rotateY(180deg)`;case"right":return`translate3d(${(e+1)*t}px,${-(s+l.h)*t}px,${(i+l.w)*t}px) rotateY(90deg)`;case"left":return`translate3d(${e*t}px,${-(s+l.h)*t}px,${i*t}px) rotateY(-90deg)`}}var T=(l=>(l[l.SOLID=0]="SOLID",l[l.DEADLY=1]="DEADLY",l[l.BOUNCY=2]="BOUNCY",l[l.PICKUP=3]="PICKUP",l[l.SPAWN=4]="SPAWN",l[l.FINISH=5]="FINISH",l[l.MOVER=6]="MOVER",l[l.PORTAL=7]="PORTAL",l))(T||{});const J=["solid","deadly","bouncy","pickup","spawn","finish","mover","portal"],ot=32,m=ot,Z=m*m,F=m*m*m,mt=["","#4CAF50","#795548","#9E9E9E","#F44336","#2196F3","#FFEB3B","#FF9800","#9C27B0","#FFFFFF","#212121","#E91E63","#00BCD4","#8BC34A","#FF5722","#607D8B"];class ft{constructor(){this.triggers=[],this.moverPaths={},this.portalTargets={},this.name="Untitled",this._spawnPos=[16,20,16],this.grid=new Uint8Array(F),this.roles=new Uint8Array(F),this.palette=[...mt]}_idx(t,e,s){return t+e*m+s*Z}get(t,e,s){return t<0||t>=m||e<0||e>=m||s<0||s>=m?0:this.grid[this._idx(t,e,s)]}getRole(t,e,s){return t<0||t>=m||e<0||e>=m||s<0||s>=m?0:this.roles[this._idx(t,e,s)]}set(t,e,s,i,a=T.SOLID){if(t<0||t>=m||e<0||e>=m||s<0||s>=m)return;const n=this._idx(t,e,s);this.grid[n]=i,this.roles[n]=a,a===T.SPAWN&&(this._spawnPos=[t,e+1,s])}clear(t,e,s){if(t<0||t>=m||e<0||e>=m||s<0||s>=m)return;const i=this._idx(t,e,s);this.grid[i]=0,this.roles[i]=0}isSolid(t,e,s){return this.get(Math.floor(t),Math.floor(e),Math.floor(s))!==0}roleAt(t,e,s){return this.getRole(Math.floor(t),Math.floor(e),Math.floor(s))}get spawnPos(){return[...this._spawnPos]}findSpawn(){for(let t=0;t<F;t++)if(this.roles[t]===T.SPAWN){const e=t%m,s=Math.floor(t/m)%m,i=Math.floor(t/Z);return[e,s+1,i]}return[16,20,16]}reset(){this.grid.fill(0),this.roles.fill(0),this.triggers=[],this.moverPaths={},this.portalTargets={},this._spawnPos=[16,20,16]}generateDefault(){this.reset();for(let t=0;t<m;t++)for(let e=0;e<m;e++)this.set(t,0,e,1),(t===0||t===m-1||e===0||e===m-1)&&this.set(t,0,e,3);this.set(4,1,4,6,T.SPAWN);for(let t=4;t<20;t++)this.set(4,0,t,3),this.set(5,0,t,3);this._placeWheelchairPerson(14,1,14)}_placeWheelchairPerson(t,e,s){const r=(p,g,_,k)=>this.set(t+p,e+g,s+_,k),d=(p,g,_,k,w,y)=>{for(let x=p;x<=g;x++)for(let E=k;E<=w;E++)r(x,_,E,y)};r(0,0,1,10),r(0,0,2,10),r(0,0,3,10),r(0,0,4,10),r(5,0,1,10),r(5,0,2,10),r(5,0,3,10),r(5,0,4,10),r(2,0,5,10),r(3,0,5,10),r(0,1,0,10),r(0,1,5,10),r(5,1,0,10),r(5,1,5,10),d(1,4,1,3,3,3),r(1,1,4,3),r(1,1,5,3),r(4,1,4,3),r(4,1,5,3),r(0,2,0,10),r(0,2,5,10),r(5,2,0,10),r(5,2,5,10),d(1,4,2,1,4,3),r(0,3,1,10),r(0,3,2,10),r(0,3,3,10),r(0,3,4,10),r(5,3,1,10),r(5,3,2,10),r(5,3,3,10),r(5,3,4,10),d(1,4,3,1,4,4),r(2,4,2,15),r(2,4,3,15),r(2,4,4,15),r(3,4,2,15),r(3,4,3,15),r(3,4,4,15),r(2,4,5,10),r(3,4,5,10),d(1,4,4,0,0,3),r(0,4,1,3),r(0,4,2,3),r(0,4,3,3),r(5,4,1,3),r(5,4,2,3),r(5,4,3,3),d(1,4,5,0,0,3),r(1,5,1,5),r(2,5,1,5),r(3,5,1,5),r(4,5,1,5),d(1,4,6,0,0,3),d(1,4,6,1,1,5),r(0,6,2,7),r(5,6,2,7),d(1,4,7,1,2,5),r(0,7,1,7),r(5,7,1,7),r(2,8,1,7),r(3,8,1,7),d(1,4,9,0,2,7),r(2,9,2,9),r(3,9,2,9),d(1,4,10,0,2,7),d(1,4,10,0,0,10),d(1,4,11,0,1,10)}serialize(){return{v:1,size:m,grid:Q(this.grid),roles:Q(this.roles),palette:this.palette,triggers:this.triggers,moverPaths:this.moverPaths,portalTargets:this.portalTargets,name:this.name}}deserialize(t){this.reset(),tt(t.grid,this.grid),tt(t.roles,this.roles),this.palette=t.palette,this.triggers=t.triggers||[],this.moverPaths=t.moverPaths||{},this.portalTargets=t.portalTargets||{},this.name=t.name||"Untitled",this._spawnPos=this.findSpawn()}}function Q(l){const t=[];let e=0;for(;e<l.length;){const s=l[e];let i=1;for(;e+i<l.length&&l[e+i]===s&&i<255;)i++;t.push(i,s),e+=i}return t}function tt(l,t){let e=0;for(let s=0;s<l.length;s+=2){const i=l[s],a=l[s+1];for(let n=0;n<i&&e<t.length;n++)t[e++]=a}}const vt=25,yt=9,et=6,X=1.6,wt=.3;class bt{constructor(t){this._pickedUp=new Set,this._world=t;const[e,s,i]=t.findSpawn();this.state={x:e+.5,y:s,z:i+.5,vx:0,vy:0,vz:0,yaw:0,grounded:!1,alive:!0,score:0,won:!1}}respawn(){const[t,e,s]=this._world.findSpawn();this.state.x=t+.5,this.state.y=e,this.state.z=s+.5,this.state.vx=0,this.state.vy=0,this.state.vz=0,this.state.grounded=!1,this.state.alive=!0,this.state.won=!1}move(t,e,s,i){if(!this.state.alive||this.state.won)return null;const a=this.state,n=Math.sin(a.yaw),o=Math.cos(a.yaw),h=(-t*n+e*o)*et,c=(t*o+e*n)*et;if(a.vx=h,a.vz=c,a.vy-=vt*i,s&&a.grounded)return a.vy=yt,a.grounded=!1,"jump";let u=null;return u=this._integrate(i),u}_integrate(t){const e=this.state,s=this._world;let i=null;const a=e.x+e.vx*t;this._collidesAt(a,e.y,e.z)?e.vx=0:e.x=a;const n=e.z+e.vz*t;this._collidesAt(e.x,e.y,n)?e.vz=0:e.z=n;const o=e.y+e.vy*t;if(!this._collidesAt(e.x,o,e.z))e.y=o,e.grounded=!1;else{e.vy<0&&(e.y=Math.floor(e.y)+.001,e.grounded=!0);const g=e.vy<0?Math.floor(e.y-.1):Math.floor(e.y+X);s.roleAt(Math.floor(e.x),g,Math.floor(e.z))===T.BOUNCY?(e.vy=-e.vy*1.3,e.grounded=!1,i="jump"):e.vy=0}const h=Math.floor(e.x),c=Math.floor(e.y),u=Math.floor(e.z),r=s.roleAt(h,c,u),d=s.roleAt(h,c+1,u),p=r||d;if(p===T.DEADLY)e.alive=!1,i="hit";else if(p===T.PICKUP){const g=r===T.PICKUP?c:c+1,_=`${h},${g},${u}`;this._pickedUp.has(_)||(this._pickedUp.add(_),s.clear(h,g,u),e.score++,i="pickup")}else if(p===T.FINISH)e.won=!0,i="win";else if(p===T.PORTAL){const g=`${h},${c},${u}`,_=s.portalTargets[g];_&&(e.x=_[0]+.5,e.y=_[1],e.z=_[2]+.5,i="pickup")}return e.y<-5&&(e.alive=!1,i="hit"),i}_collidesAt(t,e,s){const i=this._world,a=wt;for(let n=0;n<X;n+=.8){const o=e+n;if(i.isSolid(t-a,o,s-a)||i.isSolid(t+a,o,s-a)||i.isSolid(t-a,o,s+a)||i.isSolid(t+a,o,s+a))return!0}return!!i.isSolid(t,e+X,s)}}class St{constructor(){this._fired=new Set,this._timers=new Map}reset(){this._fired.clear(),this._timers.clear()}evaluate(t,e,s,i){const a=[];for(const n of t){if(this._fired.has(n.id))continue;let o=!1;switch(n.type){case"touch":if(n.target){const h=Math.floor(e.x),c=Math.floor(e.y),u=Math.floor(e.z),[r,d,p]=n.target;o=h===r&&(c===d||c+1===d)&&u===p}break;case"click":break;case"timer":{const h=(this._timers.get(n.id)??0)+i;this._timers.set(n.id,h),o=h>=(n.params.seconds??10);break}case"score_gte":o=e.score>=(n.params.score??1);break}if(o){this._fired.add(n.id);const h=this._executeAction(n,e,s);h&&a.push(h)}}return a}checkClick(t,e,s,i,a,n){const o=[];for(const h of t)if(!(h.type!=="click"||this._fired.has(h.id))&&h.target&&h.target[0]===e&&h.target[1]===s&&h.target[2]===i){this._fired.add(h.id);const c=this._executeAction(h,a,n);c&&o.push(c)}return o}_executeAction(t,e,s){switch(t.action){case"text":return{type:"text",text:t.params.text??""};case"sound":return{type:"sound",sound:t.params.sound??"pickup"};case"win":return e.won=!0,{type:"win"};case"lose":return e.alive=!1,{type:"lose"};case"teleport":return t.params.x!=null?(e.x=t.params.x+.5,e.y=t.params.y,e.z=t.params.z+.5,{type:"teleport",x:t.params.x,y:t.params.y,z:t.params.z}):null;case"destroy":return t.target&&s.clear(t.target[0],t.target[1],t.target[2]),{type:"sound",sound:"explode"};case"spawn_block":return t.params.x!=null&&s.set(t.params.x,t.params.y,t.params.z,t.params.blockId??1),{type:"sound",sound:"pickup"}}return null}}const st=.12;class kt{constructor(){this.enabled=!1,this._baseAlpha=0,this._baseBeta=0,this._targetYaw=0,this._targetPitch=0,this._hasPermission=!1,this._handler=null}async requestPermission(){const t=DeviceOrientationEvent;if(typeof t.requestPermission=="function")try{const e=await t.requestPermission();this._hasPermission=e==="granted"}catch{this._hasPermission=!1}else this._hasPermission=!0;return this._hasPermission}start(){!this._hasPermission||this._handler||(this.enabled=!0,this._handler=t=>{t.alpha==null||t.beta==null||(this._targetYaw=(t.alpha-this._baseAlpha)*.4,this._targetPitch=(t.beta-this._baseBeta)*.4)},window.addEventListener("deviceorientation",this._handler))}stop(){this.enabled=!1,this._handler&&(window.removeEventListener("deviceorientation",this._handler),this._handler=null)}calibrate(){this._baseAlpha+=this._targetYaw/.4,this._baseBeta+=this._targetPitch/.4,this._targetYaw=0,this._targetPitch=0}update(t){this.enabled&&(t.state.rotationY+=(this._targetYaw-t.state.rotationY)*st,t.state.rotationX+=(Math.max(-89,Math.min(89,this._targetPitch))-t.state.rotationX)*st)}destroy(){this.stop()}}class xt{constructor(){this._toastTimer=0,this._moveState={u:!1,d:!1,l:!1,r:!1},this.el=document.createElement("div"),this.el.className="hud",this.el.innerHTML='<div class="hud-top"><span class="hud-score">0</span></div><div class="hud-crosshair">+</div><div class="hud-msg"></div><div class="hud-toast"></div><div class="hud-dpad"><button class="dp dp-u" data-d="u">&#9650;</button><button class="dp dp-l" data-d="l">&#9664;</button><button class="dp dp-r" data-d="r">&#9654;</button><button class="dp dp-d" data-d="d">&#9660;</button><button class="dp dp-j" data-d="j">&#8679;</button></div><button class="hud-shoot">&#9678;</button>',this._msg=this.el.querySelector(".hud-msg"),this._toast=this.el.querySelector(".hud-toast"),this._dpad=this.el.querySelector(".hud-dpad"),this._shootBtn=this.el.querySelector(".hud-shoot"),this._crosshair=this.el.querySelector(".hud-crosshair"),this._bindDpad(),this._shootBtn.addEventListener("touchstart",t=>{var e;t.preventDefault(),(e=this.onShoot)==null||e.call(this)},{passive:!1}),this._shootBtn.addEventListener("mousedown",t=>{var e;t.preventDefault(),(e=this.onShoot)==null||e.call(this)})}_bindDpad(){const t=s=>{var a;s.preventDefault();const i=s.target.dataset.d;if(i){if(i==="j"){(a=this.onJump)==null||a.call(this);return}this._moveState[i]=!0}},e=s=>{s.preventDefault();const i=s.target.dataset.d;i&&i!=="j"&&(this._moveState[i]=!1)};this._dpad.addEventListener("touchstart",t,{passive:!1}),this._dpad.addEventListener("touchend",e,{passive:!1}),this._dpad.addEventListener("mousedown",t),this._dpad.addEventListener("mouseup",e),this._dpad.addEventListener("mouseleave",e)}getMoveInput(){const t=this._moveState;return{forward:(t.u?1:0)-(t.d?1:0),right:(t.r?1:0)-(t.l?1:0)}}setScore(t){}showMessage(t){this._msg.textContent=t,this._msg.style.display=t?"block":"none"}toast(t,e=2e3){this._toast.textContent=t,this._toast.classList.add("show"),clearTimeout(this._toastTimer),this._toastTimer=window.setTimeout(()=>{this._toast.classList.remove("show")},e)}setDpadVisible(t){this._dpad.style.display=t?"flex":"none",this._shootBtn.style.display=t?"flex":"none",this._crosshair.style.display=t?"block":"none"}destroy(){this.el.remove()}}let j=null;function Lt(){return j||(j=new AudioContext),j.state==="suspended"&&j.resume(),j}function b(l){try{const t=Lt(),e=t.currentTime;switch(l){case"jump":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.setValueAtTime(250,e),s.frequency.linearRampToValueAtTime(600,e+.12),i.gain.setValueAtTime(.15,e),i.gain.linearRampToValueAtTime(0,e+.15),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.15);break}case"hit":{const s=t.createBuffer(1,t.sampleRate*.2|0,t.sampleRate),i=s.getChannelData(0);for(let o=0;o<i.length;o++)i[o]=(Math.random()*2-1)*(1-o/i.length);const a=t.createBufferSource(),n=t.createGain();a.buffer=s,n.gain.setValueAtTime(.2,e),n.gain.linearRampToValueAtTime(0,e+.2),a.connect(n).connect(t.destination),a.start(e);break}case"pickup":{const s=t.createOscillator(),i=t.createOscillator(),a=t.createGain();s.type="square",s.frequency.value=523,i.type="square",i.frequency.value=659,a.gain.setValueAtTime(.08,e),a.gain.linearRampToValueAtTime(0,e+.2),s.connect(a),i.connect(a),a.connect(t.destination),s.start(e),s.stop(e+.1),i.start(e+.08),i.stop(e+.2);break}case"explode":{const s=t.createBuffer(1,t.sampleRate*.4|0,t.sampleRate),i=s.getChannelData(0);for(let h=0;h<i.length;h++)i[h]=(Math.random()*2-1)*(1-h/i.length)**.5;const a=t.createBufferSource(),n=t.createGain(),o=t.createBiquadFilter();o.type="lowpass",o.frequency.value=400,a.buffer=s,n.gain.setValueAtTime(.3,e),n.gain.linearRampToValueAtTime(0,e+.4),a.connect(o).connect(n).connect(t.destination),a.start(e);break}case"win":{[523,659,784,1047].forEach((i,a)=>{const n=t.createOscillator(),o=t.createGain();n.type="square",n.frequency.value=i,o.gain.setValueAtTime(.08,e+a*.12),o.gain.linearRampToValueAtTime(0,e+a*.12+.15),n.connect(o).connect(t.destination),n.start(e+a*.12),n.stop(e+a*.12+.15)});break}case"lose":{const s=t.createOscillator(),i=t.createGain();s.type="sawtooth",s.frequency.setValueAtTime(400,e),s.frequency.linearRampToValueAtTime(100,e+.4),i.gain.setValueAtTime(.12,e),i.gain.linearRampToValueAtTime(0,e+.5),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.5);break}case"click":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.value=800,i.gain.setValueAtTime(.05,e),i.gain.linearRampToValueAtTime(0,e+.05),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.05);break}case"place":{const s=t.createOscillator(),i=t.createGain();s.type="triangle",s.frequency.value=300,i.gain.setValueAtTime(.1,e),i.gain.linearRampToValueAtTime(0,e+.08),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.08);break}}}catch{}}const Tt=["draw","erase","role","triggers","play","save","share","undo","redo","layer","of","settings","language","you_died","you_win","tap_retry","score","saved","save_fail","link_copied","shoot"],q=["en","ru","es","zh","ar","pt","fr","de","ja","ko","hi","it","tr","pl","nl","uk","vi","th","id","ms","sv","cs","ro","el","hu","da","fi","no","sk","bg","hr","sr","lt","lv","et","sl","ka","he","fa","bn"],Pt={en:"English",ru:"Русский",es:"Español",zh:"中文",ar:"العربية",pt:"Português",fr:"Français",de:"Deutsch",ja:"日本語",ko:"한국어",hi:"हिन्दी",it:"Italiano",tr:"Türkçe",pl:"Polski",nl:"Nederlands",uk:"Українська",vi:"Tiếng Việt",th:"ไทย",id:"Bahasa",ms:"Melayu",sv:"Svenska",cs:"Čeština",ro:"Română",el:"Ελληνικά",hu:"Magyar",da:"Dansk",fi:"Suomi",no:"Norsk",sk:"Slovenčina",bg:"Български",hr:"Hrvatski",sr:"Srpski",lt:"Lietuvių",lv:"Latviešu",et:"Eesti",sl:"Slovenščina",ka:"ქართული",he:"עברית",fa:"فارسی",bn:"বাংলা"},it=[["Draw","Erase","Role","Triggers","Play","Save","Share","Undo","Redo","Layer","of","Settings","Language","You Died!","You Win!","Tap to retry","Score","Saved!","Save failed","Link copied!","Shoot"],["Рисовать","Стереть","Роль","Триггеры","Играть","Сохранить","Поделиться","Отменить","Вернуть","Слой","из","Настройки","Язык","Ты погиб!","Победа!","Нажми для повтора","Счёт","Сохранено!","Ошибка","Ссылка скопирована!","Стрелять"],["Dibujar","Borrar","Rol","Disparadores","Jugar","Guardar","Compartir","Deshacer","Rehacer","Capa","de","Ajustes","Idioma","¡Moriste!","¡Ganaste!","Toca para reintentar","Puntos","¡Guardado!","Error al guardar","¡Enlace copiado!","Disparar"],["绘制","擦除","角色","触发器","开始","保存","分享","撤销","重做","层","共","设置","语言","你死了！","你赢了！","点击重试","分数","已保存！","保存失败","链接已复制！","射击"],["رسم","مسح","دور","مشغلات","لعب","حفظ","مشاركة","تراجع","إعادة","طبقة","من","إعدادات","لغة","لقد مت!","فزت!","انقر للمحاولة","نقاط","تم الحفظ!","فشل الحفظ","تم نسخ الرابط!","إطلاق"],["Desenhar","Apagar","Papel","Gatilhos","Jogar","Salvar","Compartilhar","Desfazer","Refazer","Camada","de","Config.","Idioma","Morreu!","Venceu!","Toque para tentar","Pontos","Salvo!","Erro ao salvar","Link copiado!","Atirar"],["Dessiner","Effacer","Rôle","Déclencheurs","Jouer","Sauver","Partager","Annuler","Rétablir","Couche","de","Paramètres","Langue","Tu es mort!","Victoire!","Touche pour réessayer","Score","Sauvegardé!","Échec","Lien copié!","Tirer"],["Zeichnen","Löschen","Rolle","Auslöser","Spielen","Speichern","Teilen","Rückgängig","Wiederherstellen","Ebene","von","Einstellungen","Sprache","Gestorben!","Gewonnen!","Tippen zum Wiederholen","Punkte","Gespeichert!","Fehler","Link kopiert!","Schießen"],["描く","消す","役割","トリガー","プレイ","保存","共有","元に戻す","やり直す","レイヤー","の","設定","言語","死亡！","勝利！","タップしてリトライ","スコア","保存済み！","保存失敗","リンクコピー済み！","撃つ"],["그리기","지우기","역할","트리거","플레이","저장","공유","실행취소","다시실행","레이어","중","설정","언어","사망!","승리!","탭하여 재시도","점수","저장됨!","저장 실패","링크 복사됨!","발사"],["बनाएं","मिटाएं","भूमिका","ट्रिगर","खेलें","सेव","शेयर","अनडू","रीडू","परत","का","सेटिंग","भाषा","आप मारे गए!","आप जीते!","फिर से टैप करें","स्कोर","सेव हुआ!","सेव विफल","लिंक कॉपी!","गोली"],["Disegna","Cancella","Ruolo","Trigger","Gioca","Salva","Condividi","Annulla","Ripeti","Livello","di","Impostazioni","Lingua","Sei morto!","Hai vinto!","Tocca per riprovare","Punteggio","Salvato!","Errore","Link copiato!","Spara"],["Çiz","Sil","Rol","Tetikleyiciler","Oyna","Kaydet","Paylaş","Geri al","Yinele","Katman","/","Ayarlar","Dil","Öldün!","Kazandın!","Tekrar dene","Puan","Kaydedildi!","Hata","Link kopyalandı!","Ateş"],["Rysuj","Wymaż","Rola","Wyzwalacze","Graj","Zapisz","Udostępnij","Cofnij","Ponów","Warstwa","z","Ustawienia","Język","Zginąłeś!","Wygrałeś!","Dotknij aby ponowić","Wynik","Zapisano!","Błąd zapisu","Link skopiowany!","Strzelaj"],["Teken","Wis","Rol","Triggers","Speel","Opslaan","Delen","Ongedaan","Opnieuw","Laag","van","Instellingen","Taal","Je bent dood!","Je wint!","Tik om opnieuw","Score","Opgeslagen!","Opslaan mislukt","Link gekopieerd!","Schieten"],["Малювати","Стерти","Роль","Тригери","Грати","Зберегти","Поділитися","Скасувати","Повернути","Шар","з","Налаштування","Мова","Ти загинув!","Перемога!","Натисни знову","Рахунок","Збережено!","Помилка","Посилання скопійовано!","Стріляти"],["Vẽ","Xóa","Vai trò","Kích hoạt","Chơi","Lưu","Chia sẻ","Hoàn tác","Làm lại","Lớp","của","Cài đặt","Ngôn ngữ","Bạn chết!","Bạn thắng!","Chạm để thử lại","Điểm","Đã lưu!","Lỗi lưu","Đã sao chép!","Bắn"],["วาด","ลบ","บทบาท","ทริกเกอร์","เล่น","บันทึก","แชร์","เลิกทำ","ทำซ้ำ","ชั้น","จาก","ตั้งค่า","ภาษา","คุณตาย!","คุณชนะ!","แตะเพื่อลองใหม่","คะแนน","บันทึกแล้ว!","บันทึกล้มเหลว","คัดลอกลิงก์แล้ว!","ยิง"],["Gambar","Hapus","Peran","Pemicu","Main","Simpan","Bagikan","Undo","Redo","Lapisan","dari","Pengaturan","Bahasa","Kamu mati!","Kamu menang!","Ketuk untuk coba lagi","Skor","Tersimpan!","Gagal simpan","Link disalin!","Tembak"],["Lukis","Padam","Peranan","Pencetus","Main","Simpan","Kongsi","Buat asal","Buat semula","Lapisan","dari","Tetapan","Bahasa","Anda mati!","Anda menang!","Ketuk untuk cuba lagi","Skor","Disimpan!","Gagal","Pautan disalin!","Tembak"],["Rita","Radera","Roll","Utlösare","Spela","Spara","Dela","Ångra","Gör om","Lager","av","Inställningar","Språk","Du dog!","Du vann!","Tryck för att försöka","Poäng","Sparat!","Misslyckades","Länk kopierad!","Skjut"],["Kreslit","Smazat","Role","Spouště","Hrát","Uložit","Sdílet","Zpět","Znovu","Vrstva","z","Nastavení","Jazyk","Zemřel jsi!","Vyhrál jsi!","Klepni znovu","Skóre","Uloženo!","Chyba","Odkaz zkopírován!","Střelba"],["Desenează","Șterge","Rol","Declanșatoare","Joacă","Salvează","Partajează","Anulează","Refă","Strat","din","Setări","Limbă","Ai murit!","Ai câștigat!","Atinge pentru a reîncerca","Scor","Salvat!","Eroare","Link copiat!","Trage"],["Σχεδίασε","Σβήσε","Ρόλος","Ενεργοποιητές","Παίξε","Αποθήκευση","Κοινοποίηση","Αναίρεση","Επανάληψη","Επίπεδο","από","Ρυθμίσεις","Γλώσσα","Πέθανες!","Κέρδισες!","Πάτα ξανά","Σκορ","Αποθηκεύτηκε!","Αποτυχία","Αντιγράφηκε!","Πυροβόλησε"],["Rajzolj","Törlés","Szerep","Triggerek","Játék","Mentés","Megosztás","Visszavonás","Újra","Réteg","ból","Beállítások","Nyelv","Meghaltál!","Nyertél!","Koppints újra","Pont","Mentve!","Hiba","Link másolva!","Lövés"],["Tegn","Slet","Rolle","Udløsere","Spil","Gem","Del","Fortryd","Gentag","Lag","af","Indstillinger","Sprog","Du døde!","Du vandt!","Tryk for at prøve igen","Score","Gemt!","Fejl","Link kopieret!","Skyd"],["Piirrä","Pyyhi","Rooli","Liipaisimet","Pelaa","Tallenna","Jaa","Kumoa","Tee uudelleen","Kerros","/","Asetukset","Kieli","Kuolit!","Voitit!","Napauta uudelleen","Pisteet","Tallennettu!","Virhe","Linkki kopioitu!","Ammu"],["Tegn","Slett","Rolle","Utløsere","Spill","Lagre","Del","Angre","Gjør om","Lag","av","Innstillinger","Språk","Du døde!","Du vant!","Trykk for å prøve igjen","Poeng","Lagret!","Feil","Lenke kopiert!","Skyt"],["Kresli","Vymaž","Rola","Spúšťače","Hraj","Ulož","Zdieľaj","Späť","Znova","Vrstva","z","Nastavenia","Jazyk","Zomrel si!","Vyhral si!","Klepni znova","Skóre","Uložené!","Chyba","Odkaz skopírovaný!","Streľ"],["Рисувай","Изтрий","Роля","Тригери","Играй","Запази","Сподели","Отмени","Повтори","Слой","от","Настройки","Език","Умря!","Победи!","Натисни отново","Точки","Запазено!","Грешка","Линкът е копиран!","Стреляй"],["Crtaj","Obriši","Uloga","Okidači","Igraj","Spremi","Podijeli","Poništi","Ponovi","Sloj","od","Postavke","Jezik","Umro si!","Pobijedio si!","Dodirni za ponovni pokušaj","Bodovi","Spremljeno!","Greška","Link kopiran!","Pucaj"],["Цртај","Обриши","Улога","Тригери","Играј","Сачувај","Подели","Поништи","Понови","Слој","од","Подешавања","Језик","Умро си!","Победио си!","Додирни поново","Бодови","Сачувано!","Грешка","Линк копиран!","Пуцај"],["Piešk","Trink","Rolė","Trigeriai","Žaisk","Išsaugok","Dalinkis","Atšaukti","Pakartoti","Sluoksnis","iš","Nustatymai","Kalba","Žuvai!","Laimėjai!","Bakstelėk pakartoti","Taškai","Išsaugota!","Klaida","Nuoroda nukopijuota!","Šauk"],["Zīmē","Dzēst","Loma","Trigeri","Spēlē","Saglabāt","Dalīties","Atsaukt","Atkārtot","Slānis","no","Iestatījumi","Valoda","Tu nomiri!","Tu uzvarēji!","Pieskaries vēlreiz","Punkti","Saglabāts!","Kļūda","Saite nokopēta!","Šaut"],["Joonista","Kustuta","Roll","Päästikud","Mängi","Salvesta","Jaga","Võta tagasi","Tee uuesti","Kiht","/","Seaded","Keel","Sa surid!","Sa võitsid!","Puuduta uuesti","Skoor","Salvestatud!","Viga","Link kopeeritud!","Tulista"],["Riši","Izbriši","Vloga","Sprožilci","Igraj","Shrani","Deli","Razveljavi","Ponovi","Plast","od","Nastavitve","Jezik","Umrl si!","Zmagal si!","Tapni za ponovitev","Točke","Shranjeno!","Napaka","Povezava kopirana!","Streljaj"],["ხატვა","წაშლა","როლი","ტრიგერები","თამაში","შენახვა","გაზიარება","გაუქმება","გამეორება","ფენა","დან","პარამეტრები","ენა","მოკვდი!","გაიმარჯვე!","შეეხე ხელახლა","ქულა","შენახულია!","შეცდომა","ბმული კოპირებულია!","სროლა"],["צייר","מחק","תפקיד","טריגרים","שחק","שמור","שתף","בטל","שחזר","שכבה","מתוך","הגדרות","שפה","מתת!","ניצחת!","הקש לנסות שוב","ניקוד","נשמר!","שגיאה","הקישור הועתק!","ירה"],["ترسیم","پاک","نقش","محرک‌ها","بازی","ذخیره","اشتراک","واگرد","بازگرد","لایه","از","تنظیمات","زبان","مردی!","بردی!","لمس برای تلاش مجدد","امتیاز","ذخیره شد!","خطا","لینک کپی شد!","شلیک"],["আঁকুন","মুছুন","ভূমিকা","ট্রিগার","খেলুন","সেভ","শেয়ার","পূর্বাবস্থা","পুনরায়","স্তর","এর","সেটিংস","ভাষা","আপনি মারা গেছেন!","আপনি জিতেছেন!","আবার চেষ্টা করুন","স্কোর","সেভ হয়েছে!","সেভ ব্যর্থ","লিংক কপি হয়েছে!","গুলি"]];let V=0;function lt(l){const t=q.indexOf(l);t>=0&&(V=t),localStorage.setItem("vd_lang",l)}function Et(){return q[V]}function S(l){var e;const t=Tt.indexOf(l);return t<0?l:((e=it[V])==null?void 0:e[t])??it[0][t]??l}function zt(){return q.map(l=>({code:l,name:Pt[l]||l}))}function Ct(){var s;const l=localStorage.getItem("vd_lang");if(l){lt(l);return}const t=((s=navigator.language)==null?void 0:s.slice(0,2))||"en",e=q.indexOf(t);e>=0&&(V=e)}const L=ot,O=10;class At{constructor(t){this._layer=0,this._canvasSize=L*O,this._world=t,this.el=document.createElement("div"),this.el.className="layer-panel edit-only",this.el.innerHTML='<div class="layer-header"><button class="ly-dn">&darr;</button><span class="ly-label">Layer 0 / 31</span><button class="ly-up">&uarr;</button></div><div class="layer-canvas-wrap"><canvas></canvas></div>',this._layerLabel=this.el.querySelector(".ly-label"),this._canvas=this.el.querySelector("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvas.width=this._canvasSize,this._canvas.height=this._canvasSize,this._canvas.style.width="100%",this._canvas.style.height="100%",this._canvas.style.objectFit="contain",this._canvas.style.maxWidth="400px",this._canvas.style.maxHeight="100%",this.el.querySelector(".ly-up").addEventListener("click",()=>this.setLayer(this._layer+1)),this.el.querySelector(".ly-dn").addEventListener("click",()=>this.setLayer(this._layer-1)),this._bindCanvas(),this.draw()}get layer(){return this._layer}setLayer(t){this._layer=Math.max(0,Math.min(L-1,t)),this.updateLabel(),this.draw()}updateLabel(){this._layerLabel.textContent=`${S("layer")} ${this._layer} ${S("of")} ${L-1}`}draw(){const t=this._ctx,e=O,s=this._world,i=this._layer,a=s.palette;t.clearRect(0,0,this._canvasSize,this._canvasSize);for(let n=0;n<L;n++)for(let o=0;o<L;o++){const h=s.get(o,i,n);if(h>0){t.fillStyle=a[h]||"#ff00ff",t.fillRect(o*e,(L-1-n)*e,e,e);const c=s.getRole(o,i,n);if(c>0){t.fillStyle="rgba(255,255,255,0.7)",t.font=`${e*.6}px sans-serif`,t.textAlign="center",t.textBaseline="middle";const u=["","!","~","*","S","F","M","P"];t.fillText(u[c]||"",o*e+e/2,(L-1-n)*e+e/2)}}else t.fillStyle=(o+n)%2===0?"#1a1a28":"#1f1f30",t.fillRect(o*e,(L-1-n)*e,e,e)}t.strokeStyle="rgba(255,255,255,0.06)",t.lineWidth=.5;for(let n=0;n<=L;n++)t.beginPath(),t.moveTo(n*e,0),t.lineTo(n*e,this._canvasSize),t.moveTo(0,n*e),t.lineTo(this._canvasSize,n*e),t.stroke()}_bindCanvas(){const t=i=>{const a=this._canvas.getBoundingClientRect(),n=this._canvasSize/a.width,o=this._canvasSize/a.height,h=(i.clientX-a.left)*n,c=(i.clientY-a.top)*o,u=Math.floor(h/O),r=L-1-Math.floor(c/O);return u<0||u>=L||r<0||r>=L?null:[u,r]};let e=!1;const s=i=>{var o;i.preventDefault();const a="touches"in i?i.touches[0]:i;if(!a)return;const n=t(a);n&&((o=this.onCellTap)==null||o.call(this,n[0],n[1],this._layer))};this._canvas.addEventListener("mousedown",i=>{e=!0,s(i)}),this._canvas.addEventListener("mousemove",i=>{e&&s(i)}),window.addEventListener("mouseup",()=>{e=!1}),this._canvas.addEventListener("touchstart",i=>{e=!0,s(i)},{passive:!1}),this._canvas.addEventListener("touchmove",i=>{e&&s(i)},{passive:!1}),this._canvas.addEventListener("touchend",()=>{e=!1})}destroy(){this.el.remove()}}class Mt{constructor(t){this._selected=1,this._role=T.SOLID,this._colors=t,this.el=document.createElement("div"),this.el.className="palette-bar edit-only",this._renderSwatches(),this.roleBar=document.createElement("div"),this.roleBar.className="role-bar edit-only",this._renderRoles()}get selectedColor(){return this._selected}get selectedRole(){return this._role}get colorHex(){return this._colors[this._selected]||"#ff00ff"}_renderSwatches(){this.el.innerHTML="";for(let t=1;t<this._colors.length;t++){const e=document.createElement("div");e.className="pal-swatch"+(t===this._selected?" active":""),e.style.background=this._colors[t],e.dataset.i=String(t),this.el.appendChild(e)}this.el.addEventListener("click",t=>{var s;const e=t.target.closest(".pal-swatch");e&&(this._selected=Number(e.dataset.i),this.el.querySelectorAll(".pal-swatch").forEach(i=>i.classList.toggle("active",i===e)),(s=this.onChange)==null||s.call(this,this._selected,this._role))})}_renderRoles(){this.roleBar.innerHTML="";for(let t=0;t<J.length;t++){const e=document.createElement("button");e.className="role-btn"+(t===this._role?" active":""),e.textContent=J[t],e.dataset.r=String(t),this.roleBar.appendChild(e)}this.roleBar.addEventListener("click",t=>{var s;const e=t.target.closest(".role-btn");e&&(this._role=Number(e.dataset.r),this.roleBar.querySelectorAll(".role-btn").forEach(i=>i.classList.toggle("active",i===e)),(s=this.onChange)==null||s.call(this,this._selected,this._role))})}showRoles(t){this.roleBar.classList.toggle("show",t)}destroy(){this.el.remove(),this.roleBar.remove()}}const Bt=["touch","click","timer","score_gte"],Dt=["destroy","teleport","text","sound","win","lose","spawn_block"];class Rt{constructor(){this._triggers=[],this._nextId=1,this.el=document.createElement("div"),this.el.className="trigger-panel",this.el.innerHTML='<button class="btn-close-panel">&times;</button><h3>Triggers</h3><div class="trigger-list"></div><button class="btn-add-trigger">+ Add Trigger</button>',this._list=this.el.querySelector(".trigger-list"),this.el.querySelector(".btn-close-panel").addEventListener("click",()=>this.hide()),this.el.querySelector(".btn-add-trigger").addEventListener("click",()=>this._addTrigger())}show(){this.el.classList.add("show")}hide(){this.el.classList.remove("show")}get visible(){return this.el.classList.contains("show")}load(t){this._triggers=[...t],this._nextId=t.reduce((e,s)=>Math.max(e,s.id+1),1),this._render()}_addTrigger(){this._triggers.push({id:this._nextId++,type:"touch",target:[0,0,0],action:"text",params:{text:"Hello!"}}),this._render(),this._emit()}_removeTrigger(t){this._triggers=this._triggers.filter(e=>e.id!==t),this._render(),this._emit()}_render(){this._list.innerHTML="";for(const t of this._triggers){const e=document.createElement("div");e.className="trigger-card",e.innerHTML=`<label>IF</label><select class="t-type">${Bt.map(i=>`<option value="${i}"${i===t.type?" selected":""}>${i}</option>`).join("")}</select><label>Target Block (x,y,z)</label><input class="t-target" value="${t.target?t.target.join(","):""}" placeholder="x,y,z"><label>THEN</label><select class="t-action">${Dt.map(i=>`<option value="${i}"${i===t.action?" selected":""}>${i}</option>`).join("")}</select><label>Params (JSON)</label><input class="t-params" value='${JSON.stringify(t.params)}'><button class="role-btn" style="margin-top:6px;color:#f44336">Delete</button>`;const s=t.id;e.querySelector(".t-type").addEventListener("change",i=>{t.type=i.target.value,this._emit()}),e.querySelector(".t-target").addEventListener("change",i=>{const a=i.target.value.split(",").map(Number);a.length===3&&a.every(n=>!isNaN(n))&&(t.target=a),this._emit()}),e.querySelector(".t-action").addEventListener("change",i=>{t.action=i.target.value,this._emit()}),e.querySelector(".t-params").addEventListener("change",i=>{try{t.params=JSON.parse(i.target.value)}catch{}this._emit()}),e.querySelector("button").addEventListener("click",()=>this._removeTrigger(s)),this._list.appendChild(e)}}_emit(){var t;(t=this.onChange)==null||t.call(this,this._triggers)}destroy(){this.el.remove()}}class Gt{constructor(t,e){this._tool="draw",this._previewAngle=35,this._undoStack=[],this._redoStack=[],this._swapped=!1,this._world=t,this._sidePanel=document.createElement("div"),this._sidePanel.className="side-panel edit-only",this._sidePanel.innerHTML='<button class="sp-btn sp-undo" title="Undo">&#8630;</button><button class="sp-btn sp-redo" title="Redo">&#8631;</button>',e.appendChild(this._sidePanel),this._undoBtn=this._sidePanel.querySelector(".sp-undo"),this._redoBtn=this._sidePanel.querySelector(".sp-redo"),this._undoBtn.addEventListener("click",()=>this._undo()),this._redoBtn.addEventListener("click",()=>this._redo()),this._previewWrap=document.createElement("div"),this._previewWrap.className="preview-3d edit-only",e.appendChild(this._previewWrap),this._previewCam=new at("orbit"),this._previewCam.state.distance=40,this._previewCam.state.rotationX=-30,this._previewCam.state.rotationY=35,this._previewCam.state.target.set(16,6,16),this._previewRenderer=new nt(this._previewWrap,this._previewCam,300,4),this._previewMesh=new rt(4),this._previewRenderer.world.appendChild(this._previewMesh.el),this._previewMesh.el.style.transformStyle="preserve-3d";let s=!1,i=0,a=0;this._previewWrap.addEventListener("mousedown",h=>{s=!0,i=h.clientX,a=h.clientY}),this._previewWrap.addEventListener("touchstart",h=>{s=!0,i=h.touches[0].clientX,a=h.touches[0].clientY},{passive:!0}),window.addEventListener("mousemove",h=>{s&&(this._previewCam.orbit((h.clientX-i)*.5,(h.clientY-a)*.5),i=h.clientX,a=h.clientY,this._previewAngle=this._previewCam.state.rotationY)}),window.addEventListener("touchmove",h=>{s&&(this._previewCam.orbit((h.touches[0].clientX-i)*.5,(h.touches[0].clientY-a)*.5),i=h.touches[0].clientX,a=h.touches[0].clientY,this._previewAngle=this._previewCam.state.rotationY)}),window.addEventListener("mouseup",()=>{s=!1}),window.addEventListener("touchend",()=>{s=!1}),this._previewWrap.addEventListener("wheel",h=>{h.preventDefault(),this._previewCam.zoom(h.deltaY*.02)},{passive:!1}),(async()=>{const h=DeviceOrientationEvent;if(typeof h.requestPermission=="function")try{await h.requestPermission()}catch{return}let c=0,u=0,r=!0;window.addEventListener("deviceorientation",d=>{if(!(d.alpha==null||d.beta==null)&&(r&&(c=d.alpha,u=d.beta,r=!1),!s)){const p=(d.alpha-c)*.3,g=(d.beta-u)*.3;this._previewCam.state.rotationY+=(p-this._previewCam.state.rotationY)*.08,this._previewCam.state.rotationX+=(Math.max(-89,Math.min(89,g))-this._previewCam.state.rotationX)*.08,this._previewAngle=this._previewCam.state.rotationY}})})();const o=()=>{s||(this._previewAngle+=.08,this._previewCam.state.rotationY=this._previewAngle),this._previewRenderer.render(),requestAnimationFrame(o)};requestAnimationFrame(o),this._swapBtn=document.createElement("button"),this._swapBtn.className="swap-btn",this._swapBtn.innerHTML="&#8644;",this._swapBtn.title="Swap views",this._previewWrap.appendChild(this._swapBtn),this._swapBtn.addEventListener("click",()=>this._toggleSwap()),this.layerGrid=new At(t),this.layerGrid.onCellTap=(h,c,u)=>this._onCellTap(h,c,u),e.appendChild(this.layerGrid.el),this.palette=new Mt(t.palette),e.appendChild(this.palette.el),e.appendChild(this.palette.roleBar),this.triggerEditor=new Rt,this.triggerEditor.onChange=h=>{t.triggers=h},this.triggerEditor.load(t.triggers),e.appendChild(this.triggerEditor.el),this.toolbar=document.createElement("div"),this.toolbar.className="toolbar edit-only",this._rebuildToolbar(),e.appendChild(this.toolbar),this._bindToolbar(),this._refreshPreview(),this._updateUndoButtons()}_rebuildToolbar(){this.toolbar.innerHTML=`<button class="tb-draw active" data-tool="draw">${S("draw")}</button><button class="tb-erase" data-tool="erase">${S("erase")}</button><button class="tb-role" data-tool="role">${S("role")}</button><button class="tb-triggers">${S("triggers")}</button><select class="tb-lang"></select><div class="tb-spacer"></div><button class="tb-play">${S("play")}</button><button class="tb-save">${S("save")}</button><button class="tb-share">${S("share")}</button>`;const t=this.toolbar.querySelector(".tb-lang");for(const{code:e,name:s}of zt()){const i=document.createElement("option");i.value=e,i.textContent=s,e===Et()&&(i.selected=!0),t.appendChild(i)}t.addEventListener("change",()=>{lt(t.value),this._rebuildToolbar(),this._bindToolbar(),this.layerGrid.updateLabel()})}_bindToolbar(){this.toolbar.addEventListener("click",t=>{var i,a,n;const e=t.target.closest("button");if(!e)return;const s=e.dataset.tool;if(s){this._tool=s,this.toolbar.querySelectorAll("[data-tool]").forEach(o=>o.classList.toggle("active",o===e)),this.palette.showRoles(s==="role");return}e.classList.contains("tb-triggers")?this.triggerEditor.show():e.classList.contains("tb-play")?(i=this.onPlay)==null||i.call(this):e.classList.contains("tb-save")?(a=this.onSave)==null||a.call(this):e.classList.contains("tb-share")&&((n=this.onShare)==null||n.call(this))})}_onCellTap(t,e,s){const i=this._world,a=i.get(t,s,e),n=i.getRole(t,s,e);switch(this._tool){case"draw":{const o=this.palette.selectedColor,h=this.palette.selectedRole;if(a===o&&n===h)return;i.set(t,s,e,o,h),this._pushUndo(t,s,e,a,n,o,h),b("place");break}case"erase":{if(a===0)return;i.clear(t,s,e),this._pushUndo(t,s,e,a,n,0,0),b("click");break}case"role":{if(a===0)return;const o=this.palette.selectedRole;if(n===o)return;i.set(t,s,e,a,o),this._pushUndo(t,s,e,a,n,a,o),b("click");break}case"pick":a>0&&b("click");break}this.layerGrid.draw(),this._refreshPreview()}_pushUndo(t,e,s,i,a,n,o){this._undoStack.push({x:t,y:e,z:s,oldBlock:i,oldRole:a,newBlock:n,newRole:o}),this._undoStack.length>200&&this._undoStack.shift(),this._redoStack.length=0,this._updateUndoButtons()}_undo(){const t=this._undoStack.pop();t&&(this._world.set(t.x,t.y,t.z,t.oldBlock,t.oldRole),this._redoStack.push(t),this.layerGrid.draw(),this._refreshPreview(),this._updateUndoButtons(),b("click"))}_redo(){const t=this._redoStack.pop();t&&(this._world.set(t.x,t.y,t.z,t.newBlock,t.newRole),this._undoStack.push(t),this.layerGrid.draw(),this._refreshPreview(),this._updateUndoButtons(),b("click"))}_updateUndoButtons(){this._undoBtn.classList.toggle("disabled",this._undoStack.length===0),this._redoBtn.classList.toggle("disabled",this._redoStack.length===0)}_toggleSwap(){this._swapped=!this._swapped,this._previewWrap.classList.toggle("swapped",this._swapped),this.layerGrid.el.classList.toggle("swapped",this._swapped)}_refreshPreview(){this._previewMesh.rebuildFromGrid(this._world.grid,this._world.palette)}refresh(){this.layerGrid.draw(),this._refreshPreview(),this.triggerEditor.load(this._world.triggers)}setVisible(t){const e=t?"":"none";this.layerGrid.el.style.display=e,this.palette.el.style.display=e,this.palette.roleBar.style.display="none",this.toolbar.style.display=t?"flex":"none",this._previewWrap.style.display=e,this._sidePanel.style.display=t?"flex":"none",t&&this.triggerEditor.hide()}destroy(){this.layerGrid.destroy(),this.palette.destroy(),this.triggerEditor.destroy(),this.toolbar.remove(),this._previewWrap.remove(),this._previewRenderer.destroy(),this._sidePanel.remove()}}const H="voxeldom_save";function $t(l){var t;try{const e=JSON.stringify(l);localStorage.setItem(H,e);const s=(t=window.Telegram)==null?void 0:t.WebApp;return s!=null&&s.CloudStorage&&s.CloudStorage.setItem(H,e),!0}catch{return!1}}function Yt(){try{const l=localStorage.getItem(H);if(!l)return null;const t=JSON.parse(l);return t.v!==1?null:t}catch{return null}}function It(l){const t=JSON.stringify(l);return btoa(unescape(encodeURIComponent(t)))}function Nt(l){try{const t=decodeURIComponent(escape(atob(l))),e=JSON.parse(t);return e.v===1?e:null}catch{return null}}function U(){var l;return((l=window.Telegram)==null?void 0:l.WebApp)??null}function jt(){const l=U();l&&(l.ready(),l.expand())}function K(l="light"){var t,e;(e=(t=U())==null?void 0:t.HapticFeedback)==null||e.impactOccurred(l)}function Ot(l){var e;const t=U();t?t.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(l)}`):(e=navigator.clipboard)==null||e.writeText(l)}function W(l,t){const e=U();e&&(l?(e.BackButton.show(),t&&e.BackButton.onClick(t)):e.BackButton.hide())}class qt{constructor(t){this._player=null,this._mode="edit",this._jumpPressed=!1,this._shootPressed=!1,this._health=3,this._maxHealth=3,this._damageCooldown=0,Ct(),jt();const e=document.querySelector(t);if(!e)throw new Error("Container not found");this._container=e,this._world=new ft;const s=new URLSearchParams(location.search).get("g");if(s){const i=Nt(s);i?this._world.deserialize(i):this._world.generateDefault()}else{const i=Yt();i?this._world.deserialize(i):this._world.generateDefault()}this._engine=new dt({container:e,voxelSize:16,perspective:700}),this._mesh=new rt(16),this._engine.scene.add(this._mesh),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette),this._triggers=new St,this._gyro=new kt,this._hud=new xt,e.appendChild(this._hud.el),this._editor=new Gt(this._world,e),this._editor.onPlay=()=>this.setMode("play"),this._editor.onSave=()=>this._save(),this._editor.onShare=()=>this._share(),this._hud.onJump=()=>{this._jumpPressed=!0},this._hud.onShoot=()=>{this._shootPressed=!0},this._engine.onUpdate(i=>this._update(i)),this._engine.start(),this.setMode(s?"play":"edit"),W(!1)}setMode(t){if(this._mode=t,this._container.className=t==="edit"?"mode-edit":"mode-play",t==="edit")this._editor.setVisible(!0),this._editor.refresh(),this._hud.setDpadVisible(!1),this._hud.showMessage(""),this._hud.el.style.display="none",this._player=null,this._engine.camera.mode="orbit",this._engine.renderer.root.style.display="none",this._engine.pause(),this._gyro.stop(),W(!1);else{this._editor.setVisible(!1),this._hud.el.style.display="",this._hud.setDpadVisible(!0),this._hud.showMessage(""),this._hud.setScore(0),this._engine.renderer.root.style.display="",this._engine.resume(),this._player=new bt(this._world),this._triggers.reset(),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette),this._health=this._maxHealth,this._damageCooldown=0,this._engine.camera.mode="fly",this._engine.camera.state.rotationX=0,this._engine.camera.state.rotationY=0;const e=this._world.findSpawn();this._engine.camera.state.position.set(e[0]+.5,e[1]+1.5,e[2]+.5),this._gyro.requestPermission().then(s=>{s&&this._gyro.start()}),W(!0,()=>this.setMode("edit"))}}_update(t){if(this._mode==="edit"){this._processEditInput();return}const e=this._player;if(!e)return;const s=this._engine.input.state.keys,i=this._hud.getMoveInput();let a=i.forward,n=i.right;(s.has("KeyW")||s.has("ArrowUp"))&&(a+=1),(s.has("KeyS")||s.has("ArrowDown"))&&(a-=1),(s.has("KeyA")||s.has("ArrowLeft"))&&(n-=1),(s.has("KeyD")||s.has("ArrowRight"))&&(n+=1);const o=this._jumpPressed||s.has("Space");this._jumpPressed=!1;const{deltaX:h,deltaY:c,pinchDelta:u}=this._engine.input.state;h&&this._engine.camera.orbit(h*.3,0),c&&this._engine.camera.orbit(0,c*.3),u&&this._engine.camera.zoom(u*2),this._engine.input.resetDeltas(),e.state.yaw=this._engine.camera.state.rotationY*(Math.PI/180),this._gyro.update(this._engine.camera);const r=e.move(a,n,o,t);r&&(b(r),K(r==="hit"?"heavy":"light")),this._shootPressed&&(this._shootPressed=!1,this._shoot());const d=this._triggers.evaluate(this._world.triggers,e.state,this._world,t);this._handleEvents(d);const p=this._engine.camera.state;p.position.x=e.state.x,p.position.y=e.state.y+1.5,p.position.z=e.state.z,this._damageCooldown>0&&(this._damageCooldown-=t),!e.state.alive&&this._health>0&&this._damageCooldown<=0&&(this._health--,this._damageCooldown=1,this._health>0&&(e.state.alive=!0,b("hit"),K("heavy"))),this._hud.setScore(e.state.score),this._hud.el.querySelector(".hud-top").innerHTML=`<span class="hud-score">${e.state.score}</span> &nbsp; ${"&#9829;".repeat(this._health)}${"&#9825;".repeat(this._maxHealth-this._health)}`,!e.state.alive&&this._health<=0?(this._hud.showMessage(`${S("you_died")} ${S("tap_retry")}`),this._waitForTap(()=>{e.respawn(),this._hud.showMessage(""),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette)})):e.state.won&&(this._hud.showMessage(S("you_win")),this._waitForTap(()=>this.setMode("edit")))}_shoot(){const t=this._player;if(!t)return;b("hit"),K("medium");const e=this._engine.camera.state.rotationY*(Math.PI/180),s=this._engine.camera.state.rotationX*(Math.PI/180),i=-Math.sin(e)*Math.cos(s),a=Math.sin(s),n=Math.cos(e)*Math.cos(s);let o=t.state.x,h=t.state.y+1.5,c=t.state.z;for(let u=0;u<50;u++){o+=i*.3,h+=a*.3,c+=n*.3;const r=Math.floor(o),d=Math.floor(h),p=Math.floor(c);if(this._world.isSolid(r,d,p)){this._world.clear(r,d,p),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette),b("explode");return}}}_processEditInput(){this._engine.input.resetDeltas()}_handleEvents(t){for(const e of t)switch(e.type){case"text":this._hud.toast(e.text,3e3);break;case"sound":b(e.sound);break;case"win":b("win");break;case"lose":b("lose");break;case"teleport":b("pickup");break}t.some(e=>e.type==="sound"&&e.sound==="explode")&&this._mesh.rebuildFromGrid(this._world.grid,this._world.palette)}_waitForTap(t){const e=()=>{document.removeEventListener("pointerdown",e),t()};setTimeout(()=>document.addEventListener("pointerdown",e),500)}_save(){const t=this._world.serialize(),e=$t(t);this._hud.toast(S(e?"saved":"save_fail"),1500),b("pickup")}_share(){const t=this._world.serialize(),e=It(t),s=`${location.origin}${location.pathname}?g=${e}`;Ot(s),this._hud.toast(S("link_copied"),1500)}}const Vt=new qt("#app");window.voxelApp=Vt;
