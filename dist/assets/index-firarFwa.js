(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class W{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return new W(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new W(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return new W(this.x*t,this.y*t,this.z*t)}len(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){const t=this.len()||1;return new W(this.x/t,this.y/t,this.z/t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new W(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}clone(){return new W(this.x,this.y,this.z)}}class L{constructor(){this.m=new Float64Array(16),this.m[0]=this.m[5]=this.m[10]=this.m[15]=1}static identity(){return new L}static perspective(t,e,s,i){const o=new L,n=o.m,a=1/Math.tan(t/2),l=1/(s-i);return n.fill(0),n[0]=a/e,n[5]=a,n[10]=(i+s)*l,n[11]=-1,n[14]=2*i*s*l,o}static translation(t,e,s){const i=new L;return i.m[12]=t,i.m[13]=e,i.m[14]=s,i}static rotationX(t){const e=new L,s=Math.cos(t),i=Math.sin(t);return e.m[5]=s,e.m[6]=i,e.m[9]=-i,e.m[10]=s,e}static rotationY(t){const e=new L,s=Math.cos(t),i=Math.sin(t);return e.m[0]=s,e.m[2]=-i,e.m[8]=i,e.m[10]=s,e}static rotationZ(t){const e=new L,s=Math.cos(t),i=Math.sin(t);return e.m[0]=s,e.m[1]=i,e.m[4]=-i,e.m[5]=s,e}static scaling(t,e,s){const i=new L;return i.m[0]=t,i.m[5]=e,i.m[10]=s,i}multiply(t){const e=new L,s=this.m,i=t.m,o=e.m;for(let n=0;n<4;n++)for(let a=0;a<4;a++)o[a*4+n]=s[n]*i[a*4]+s[4+n]*i[a*4+1]+s[8+n]*i[a*4+2]+s[12+n]*i[a*4+3];return e}invert(){const t=this.m,e=new L,s=e.m,i=t[0],o=t[1],n=t[2],a=t[3],l=t[4],d=t[5],h=t[6],r=t[7],u=t[8],_=t[9],p=t[10],m=t[11],f=t[12],g=t[13],y=t[14],k=t[15],A=i*d-o*l,b=i*h-n*l,v=i*r-a*l,w=o*h-n*d,x=o*r-a*d,E=n*r-a*h,O=u*g-_*f,Y=u*y-p*f,T=u*k-m*f,$=_*y-p*g,q=_*k-m*g,I=p*k-m*y;let M=A*I-b*q+v*$+w*T-x*Y+E*O;return M&&(M=1/M,s[0]=(d*I-h*q+r*$)*M,s[1]=(n*q-o*I-a*$)*M,s[2]=(g*E-y*x+k*w)*M,s[3]=(p*x-_*E-m*w)*M,s[4]=(h*T-l*I-r*Y)*M,s[5]=(i*I-n*T+a*Y)*M,s[6]=(y*v-f*E-k*b)*M,s[7]=(u*E-p*v+m*b)*M,s[8]=(l*q-d*T+r*O)*M,s[9]=(o*T-i*q-a*O)*M,s[10]=(f*x-g*v+k*A)*M,s[11]=(_*v-u*x-m*A)*M,s[12]=(d*Y-l*$-h*O)*M,s[13]=(i*$-o*Y+n*O)*M,s[14]=(g*b-f*w-y*A)*M,s[15]=(u*w-_*b+p*A)*M),e}toCSS(){const t=this.m;return`matrix3d(${t[0]},${t[1]},${t[2]},${t[3]},${t[4]},${t[5]},${t[6]},${t[7]},${t[8]},${t[9]},${t[10]},${t[11]},${t[12]},${t[13]},${t[14]},${t[15]})`}transformPoint(t){const e=this.m,s=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15]||1;return new W((e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12])/s,(e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13])/s,(e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14])/s)}}const V=Math.PI/180;function Et(c,t,e,s,i,o,n,a,l,d){const h=a*l;function r(M,H,X){return M+H*a+X*h}function u(M,H,X){return M<0||M>=a||H<0||H>=l||X<0||X>=d?!1:n[r(M,H,X)]!==0}let _=Math.floor(c),p=Math.floor(t),m=Math.floor(e);const f=s>=0?1:-1,g=i>=0?1:-1,y=o>=0?1:-1,k=Math.abs(s)<1e-8?1/0:1/Math.abs(s),A=Math.abs(i)<1e-8?1/0:1/Math.abs(i),b=Math.abs(o)<1e-8?1/0:1/Math.abs(o);let v=(f>0?_+1-c:c-_)*k,w=(g>0?p+1-t:t-p)*A,x=(y>0?m+1-e:e-m)*b;const E=k,O=A,Y=b,T=(a+l+d)*2;let $=0,q=null;const I=Math.abs(s)>=Math.abs(i)&&Math.abs(s)>=Math.abs(o)?s>0?"left":"right":Math.abs(i)>=Math.abs(o)?i>0?"bottom":"top":o>0?"back":"front";for(;$<T;){if(_>=0&&_<a&&p>=0&&p<l&&m>=0&&m<d&&u(_,p,m))return{x:_,y:p,z:m,face:q??I};v<=w&&v<=x?(_+=f,$=v,v+=E,q=f>0?"left":"right"):w<=x?(p+=g,$=w,w+=O,q=g>0?"bottom":"top"):(m+=y,$=x,x+=Y,q=y>0?"back":"front")}return null}class wt{constructor(t="orbit"){this.mode=t,this.state={position:new W(0,5,10),rotationX:-25,rotationY:45,distance:20,target:new W(0,0,0)}}getViewMatrix(t=1){const e=t;if(this.mode==="orbit"){const n=L.rotationX(this.state.rotationX*V),a=L.rotationY(this.state.rotationY*V),l=L.translation(-this.state.target.x*e,this.state.target.y*e,-this.state.target.z*e);return L.translation(0,0,-this.state.distance*e).multiply(n).multiply(a).multiply(l)}const s=L.rotationX(-this.state.rotationX*V),i=L.rotationY(-this.state.rotationY*V),o=L.translation(-this.state.position.x*e,this.state.position.y*e,-this.state.position.z*e);return s.multiply(i).multiply(o)}orbit(t,e){this.state.rotationY+=t,this.state.rotationX=Math.max(-89,Math.min(89,this.state.rotationX+e))}zoom(t){this.state.distance=Math.max(.1,Math.min(200,this.state.distance+t))}moveLocal(t,e,s){const i=this.state.rotationY*V,o=Math.sin(i),n=Math.cos(i);this.state.position.x+=e*n-t*o,this.state.position.y+=s,this.state.position.z+=e*o+t*n}}class xt{constructor(t,e,s=800,i=20){this.camera=e,this._perspectivePx=s,this._voxelSize=i,this.root=document.createElement("div"),this.root.className="voxel-world",Object.assign(this.root.style,{position:"relative",width:"100%",height:"100%",overflow:"hidden",contain:"strict",perspective:`${s}px`,perspectiveOrigin:"50% 50%"}),this.world=document.createElement("div"),Object.assign(this.world.style,{position:"absolute",left:"50%",top:"50%",transformStyle:"preserve-3d",willChange:"transform"}),this.root.appendChild(this.world),t.appendChild(this.root)}get voxelSize(){return this._voxelSize}get perspectivePx(){return this._perspectivePx}render(){const t=this.camera.getViewMatrix(this._voxelSize);this.world.style.transform=t.toCSS()}pickVoxel(t,e,s,i,o,n){const a=o??i,l=n??i,d=this.root.getBoundingClientRect(),h=d.left+d.width/2,r=d.top+d.height/2,u=t-h,_=e-r,p=-this._perspectivePx,g=this.camera.getViewMatrix(this._voxelSize).invert().m,y=g[12],k=g[13],A=g[14],b=g[0]*u+g[4]*_+g[8]*p,v=g[1]*u+g[5]*_+g[9]*p,w=g[2]*u+g[6]*_+g[10]*p,x=Math.sqrt(b*b+v*v+w*w)||1,E=this._voxelSize;return Et(y/E,k/E,A/E,b/x,v/x,w/x,s,i,a,l)}destroy(){this.root.remove()}}class kt{constructor(t){this.state={keys:new Set,pointerDown:!1,pointerX:0,pointerY:0,deltaX:0,deltaY:0,pinchDelta:0},this._listeners=[],this._lastTouchDist=0,this._el=t,this._bind()}onVoxelClick(t){this._onVoxelClick=t}resetDeltas(){this.state.deltaX=0,this.state.deltaY=0,this.state.pinchDelta=0}_on(t,e,s,i){t.addEventListener(e,s,i),this._listeners.push([t,e,s])}_bind(){this._on(window,"keydown",t=>{this.state.keys.add(t.code)}),this._on(window,"keyup",t=>{this.state.keys.delete(t.code)}),this._on(this._el,"mousedown",t=>{this.state.pointerDown=!0;const e=t;this.state.pointerX=e.clientX,this.state.pointerY=e.clientY}),this._on(window,"mouseup",()=>{this.state.pointerDown=!1}),this._on(window,"mousemove",t=>{const e=t;this.state.pointerDown&&(this.state.deltaX+=e.clientX-this.state.pointerX,this.state.deltaY+=e.clientY-this.state.pointerY),this.state.pointerX=e.clientX,this.state.pointerY=e.clientY}),this._on(this._el,"wheel",t=>{t.preventDefault(),this.state.pinchDelta+=t.deltaY*.01},{passive:!1}),this._on(this._el,"touchstart",t=>{t.preventDefault();const e=t;e.touches.length===1&&(this.state.pointerDown=!0,this.state.pointerX=e.touches[0].clientX,this.state.pointerY=e.touches[0].clientY),e.touches.length===2&&(this._lastTouchDist=this._touchDist(e))},{passive:!1}),this._on(this._el,"touchmove",t=>{t.preventDefault();const e=t;if(e.touches.length===1&&this.state.pointerDown){const s=e.touches[0].clientX,i=e.touches[0].clientY;this.state.deltaX+=s-this.state.pointerX,this.state.deltaY+=i-this.state.pointerY,this.state.pointerX=s,this.state.pointerY=i}if(e.touches.length===2){const s=this._touchDist(e);this.state.pinchDelta+=(this._lastTouchDist-s)*.05,this._lastTouchDist=s}},{passive:!1}),this._on(this._el,"touchend",()=>{this.state.pointerDown=!1}),this._on(this._el,"click",t=>{const e=t.target;e.dataset.vx!==void 0&&this._onVoxelClick&&this._onVoxelClick({x:Number(e.dataset.vx),y:Number(e.dataset.vy),z:Number(e.dataset.vz),normal:e.dataset.normal||""})})}_touchDist(t){const e=t.touches[0].clientX-t.touches[1].clientX,s=t.touches[0].clientY-t.touches[1].clientY;return Math.sqrt(e*e+s*s)}destroy(){for(const[t,e,s]of this._listeners)t.removeEventListener(e,s);this._listeners.length=0}}let ot=0,ut=0,Mt=0;function Pt(){ot++;const c=performance.now();c-ut>=1e3&&(Mt=ot,ot=0,ut=c)}function zt(){return Mt}function Lt(){return document.getElementsByTagName("*").length}const pt={FPS_MIN:30,BUNDLE_MAX_KB:500};class Ct{constructor(t){this._nodes=[],this._worldEl=t}add(t){this._nodes.push(t),this._worldEl.appendChild(t.el),t.update()}remove(t){const e=this._nodes.indexOf(t);e>=0&&this._nodes.splice(e,1),t.destroy()}clear(){for(const t of this._nodes)t.destroy();this._nodes.length=0}update(){for(const t of this._nodes)t.update()}get nodes(){return this._nodes}}class Dt{constructor(t){this._running=!1,this._paused=!1,this._rafId=0,this._lastTime=0,this._updateCbs=[],this._tick=s=>{if(!this._running)return;if(this._rafId=requestAnimationFrame(this._tick),this._paused){this._lastTime=s;return}const i=Math.min((s-this._lastTime)/1e3,.1);this._lastTime=s;for(const o of this._updateCbs)o(i);this.scene.update(),this.renderer.render(),Pt(),this.input.resetDeltas()};const e=typeof t.container=="string"?document.querySelector(t.container):t.container;if(!e)throw new Error("VoxelDOM: container not found");this.camera=new wt("orbit"),this.renderer=new xt(e,this.camera,t.perspective??800,t.voxelSize??16),this.scene=new Ct(this.renderer.world),this.input=new kt(this.renderer.root)}get voxelSize(){return this.renderer.voxelSize}get running(){return this._running}get paused(){return this._paused}onUpdate(t){this._updateCbs.push(t)}clearCallbacks(){this._updateCbs.length=0}onVoxelClick(t){this.input.onVoxelClick(t)}start(){this._running||(this._running=!0,this._paused=!1,this._lastTime=performance.now(),this._tick(this._lastTime))}stop(){this._running=!1,cancelAnimationFrame(this._rafId)}pause(){this._paused=!0}resume(){this._paused=!1,this._lastTime=performance.now()}destroy(){this.stop(),this.scene.clear(),this.input.destroy(),this.renderer.destroy()}}const At=[{normal:"top",axis:1,u:0,v:2,dir:1},{normal:"bottom",axis:1,u:0,v:2,dir:-1},{normal:"right",axis:0,u:2,v:1,dir:1},{normal:"left",axis:0,u:2,v:1,dir:-1},{normal:"front",axis:2,u:0,v:1,dir:1},{normal:"back",axis:2,u:0,v:1,dir:-1}];function Bt(c,t,e,s,i){const o=e,n=s??e,a=i??e,l=o*n,d=[],h=[o,n,a];function r(f,g,y){return f+g*o+y*l}function u(f,g,y){return f<0||f>=o||g<0||g>=n||y<0||y>=a?!1:c[r(f,g,y)]!==0}function _(f,g,y){return f<0||f>=o||g<0||g>=n||y<0||y>=a?0:c[r(f,g,y)]}const p=Math.max(o*n,o*a,n*a),m=new Int32Array(p);for(const f of At){const g=h[f.axis];for(let y=0;y<g;y++){m.fill(0);for(let b=0;b<h[f.v];b++)for(let v=0;v<h[f.u];v++){const w=[0,0,0];w[f.axis]=y,w[f.u]=v,w[f.v]=b;const x=_(w[0],w[1],w[2]);if(x===0)continue;const E=[0,0,0];E[f.axis]=y+f.dir,E[f.u]=v,E[f.v]=b,!u(E[0],E[1],E[2])&&(m[b*h[f.u]+v]=x)}const k=h[f.u],A=h[f.v];for(let b=0;b<A;b++)for(let v=0;v<k;){const w=m[b*k+v];if(w===0){v++;continue}let x=1;for(;v+x<k&&m[b*k+v+x]===w;)x++;let E=1,O=!1;for(;b+E<A&&!O;){for(let T=0;T<x;T++)if(m[(b+E)*k+v+T]!==w){O=!0;break}O||E++}for(let T=0;T<E;T++)for(let $=0;$<x;$++)m[(b+T)*k+v+$]=0;const Y=[0,0,0];Y[f.axis]=y,Y[f.u]=v,Y[f.v]=b,d.push({x:Y[0],y:Y[1],z:Y[2],w:x,h:E,normal:f.normal,color:t[w]||"#ff00ff"}),v+=x}}}return d}function Tt(c,t){const e=c.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if(!e)return c;const s=parseInt(e[1],16),i=parseInt(e[2],16),o=parseInt(e[3],16),n=r=>Math.sin(t*12.9898+r)*43758.5453%1,a=.02,l=Math.round(Math.max(0,Math.min(255,s*(1+(n(0)*2-1)*a)))),d=Math.round(Math.max(0,Math.min(255,i*(1+(n(1)*2-1)*a)))),h=Math.round(Math.max(0,Math.min(255,o*(1+(n(2)*2-1)*a))));return`#${l.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`}const Yt={top:1,front:.85,back:.7,right:.8,left:.75,bottom:.6},$t={top:"vf-top",front:"vf-front",back:"vf-back",right:"vf-right",left:"vf-left",bottom:"vf-bottom"};class St{constructor(t=16){this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.scale={x:1,y:1,z:1},this._faceEls=[],this._faceCount=0,this._voxelSize=t,this.el=document.createElement("div"),this.el.style.position="absolute",this.el.style.transformStyle="preserve-3d",this.el.style.willChange="transform"}get faceCount(){return this._faceCount}rebuildFromGrid(t,e,s,i,o){const n=Bt(t,e,s,i,o);this._faceCount=n.length;for(const d of this._faceEls)d.remove();this._faceEls.length=0;const a=this._voxelSize,l={top:0,bottom:1,front:2,back:3,left:4,right:5};for(const d of n){const h=document.createElement("div"),r=d.w*a,u=d.h*a,_=d.x*31+d.y*17+d.z*7+l[d.normal]|0,p=Tt(d.color,_),m=Yt[d.normal];h.className=`vf vf-proc vf-base ${$t[d.normal]}`,h.style.setProperty("--vf-w",`${r}px`),h.style.setProperty("--vf-h",`${u}px`),h.style.setProperty("--vf-color",p),h.style.setProperty("--vf-brightness",String(m)),h.style.transform=Rt(d,a),h.dataset.n=d.normal,h.dataset.x=String(d.x),h.dataset.y=String(d.y),h.dataset.z=String(d.z),this.el.appendChild(h),this._faceEls.push(h)}}update(){const t=this._voxelSize,e=L.translation(this.position.x*t,-this.position.y*t,this.position.z*t),s=L.rotationY(this.rotation.y*V);this.el.style.transform=e.multiply(s).toCSS()}destroy(){for(const t of this._faceEls)t.remove();this._faceEls.length=0,this.el.remove()}}const Gt=1.005;function Rt(c,t){const e=c.x,s=c.y,i=c.z;let o;switch(c.normal){case"top":o=`translate3d(${e*t}px,${-(s+1)*t}px,${i*t}px) rotateX(90deg)`;break;case"bottom":o=`translate3d(${e*t}px,${-s*t}px,${(i+c.h)*t}px) rotateX(-90deg)`;break;case"front":o=`translate3d(${e*t}px,${-(s+c.h)*t}px,${(i+1)*t}px)`;break;case"back":o=`translate3d(${(e+c.w)*t}px,${-(s+c.h)*t}px,${i*t}px) rotateY(180deg)`;break;case"right":o=`translate3d(${(e+1)*t}px,${-(s+c.h)*t}px,${(i+c.w)*t}px) rotateY(90deg)`;break;case"left":o=`translate3d(${e*t}px,${-(s+c.h)*t}px,${i*t}px) rotateY(-90deg)`;break;default:o=""}return o+` scale(${Gt})`}var G=(c=>(c[c.SOLID=0]="SOLID",c[c.DEADLY=1]="DEADLY",c[c.BOUNCY=2]="BOUNCY",c[c.PICKUP=3]="PICKUP",c[c.SPAWN=4]="SPAWN",c[c.FINISH=5]="FINISH",c[c.MOVER=6]="MOVER",c[c.PORTAL=7]="PORTAL",c))(G||{});const _t=["solid","deadly","bouncy","pickup","spawn","finish","mover","portal"];function mt(c,t,e,s,i){return c+t*s+e*i}class Ot{constructor(t,e,s,i){this._dirty=new Set,this.chunkSize=t,this._sx=Math.ceil(e/t),this._sy=Math.ceil(s/t),this._sz=Math.ceil(i/t),this._strideX=this._sx,this._strideY=this._sx*this._sy}markDirty(t,e,s){const i=Math.floor(t/this.chunkSize),o=Math.floor(e/this.chunkSize),n=Math.floor(s/this.chunkSize);i>=0&&i<this._sx&&o>=0&&o<this._sy&&n>=0&&n<this._sz&&this._dirty.add(mt(i,o,n,this._strideX,this._strideY))}markDirtyRegion(t,e,s,i,o,n){const a=Math.max(0,Math.floor(t/this.chunkSize)),l=Math.max(0,Math.floor(e/this.chunkSize)),d=Math.max(0,Math.floor(s/this.chunkSize)),h=Math.min(this._sx-1,Math.floor(i/this.chunkSize)),r=Math.min(this._sy-1,Math.floor(o/this.chunkSize)),u=Math.min(this._sz-1,Math.floor(n/this.chunkSize));for(let _=d;_<=u;_++)for(let p=l;p<=r;p++)for(let m=a;m<=h;m++)this._dirty.add(mt(m,p,_,this._strideX,this._strideY))}getDirtyChunkIds(){return this._dirty.size===0?null:Array.from(this._dirty)}clearDirty(){this._dirty.clear()}hasDirty(){return this._dirty.size>0}}const N=128,R=32,F=128,S=N,P=R,z=F,nt=S*P,Z=S*P*z,Nt=["","#4CAF50","#795548","#9E9E9E","#F44336","#2196F3","#FFEB3B","#FF9800","#9C27B0","#FFFFFF","#212121","#E91E63","#00BCD4","#8BC34A","#FF5722","#607D8B"];class Ft{constructor(){this.triggers=[],this.moverPaths={},this.portalTargets={},this.name="Untitled",this.chunkManager=null,this._spawnPos=[64,1,64],this.grid=new Uint8Array(Z),this.roles=new Uint8Array(Z),this.palette=[...Nt],this.chunkManager=new Ot(16,S,P,z),this.chunkManager.markDirtyRegion(0,0,0,S-1,P-1,z-1)}_idx(t,e,s){return t+e*S+s*nt}get(t,e,s){return t<0||t>=S||e<0||e>=P||s<0||s>=z?1:this.grid[this._idx(t,e,s)]}getRole(t,e,s){return t<0||t>=S||e<0||e>=P||s<0||s>=z?0:this.roles[this._idx(t,e,s)]}set(t,e,s,i,o=G.SOLID){var a;if(t<0||t>=S||e<0||e>=P||s<0||s>=z)return;const n=this._idx(t,e,s);this.grid[n]=i,this.roles[n]=o,o===G.SPAWN&&(this._spawnPos=[t,e+1,s]),(a=this.chunkManager)==null||a.markDirty(t,e,s)}clear(t,e,s){var o;if(t<0||t>=S||e<0||e>=P||s<0||s>=z)return;const i=this._idx(t,e,s);this.grid[i]=0,this.roles[i]=0,(o=this.chunkManager)==null||o.markDirty(t,e,s)}isSolid(t,e,s){return this.get(Math.floor(t),Math.floor(e),Math.floor(s))!==0}putBox(t,e,s,i,o,n,a){const l=Math.max(0,Math.floor(t)),d=Math.max(0,Math.floor(e)),h=Math.max(0,Math.floor(s)),r=Math.min(S,l+Math.max(0,Math.floor(i))),u=Math.min(P,d+Math.max(0,Math.floor(o))),_=Math.min(z,h+Math.max(0,Math.floor(n)));for(let p=l;p<r;p++)for(let m=d;m<u;m++)for(let f=h;f<_;f++)this.set(p,m,f,a)}putHollowBox(t,e,s,i,o,n,a){const l=Math.max(0,Math.floor(t)),d=Math.max(0,Math.floor(e)),h=Math.max(0,Math.floor(s)),r=Math.min(S,l+Math.max(0,Math.floor(i))),u=Math.min(P,d+Math.max(0,Math.floor(o))),_=Math.min(z,h+Math.max(0,Math.floor(n)));if(!(r<=l||u<=d||_<=h)){for(let p=l;p<r;p++)for(let m=h;m<_;m++)this.set(p,d,m,a),u-d>1&&this.set(p,u-1,m,a);for(let p=d;p<u;p++)for(let m=h;m<_;m++)this.set(l,p,m,a),r-l>1&&this.set(r-1,p,m,a);for(let p=l;p<r;p++)for(let m=d;m<u;m++)this.set(p,m,h,a),_-h>1&&this.set(p,m,_-1,a)}}putBush(t,e,s){const i=Math.floor(t),o=Math.floor(e),n=Math.floor(s);if(i<0||i>=S||o<0||o>=P||n<0||n>=z)return;const a=1,l=1;for(let d=0;d<=1&&o+d<P;d++)for(let h=-l;h<=l;h++)for(let r=-l;r<=l;r++)h*h+d*d+r*r<=l*l+.5&&this.set(i+h,o+d,n+r,a)}putTree(t,e,s,i){const o=Math.floor(t),n=Math.floor(e),a=Math.floor(s);if(o<0||o>=S||n<0||n>=P||a<0||a>=z)return;const l=Math.max(1,Math.floor(i*.5)),d=Math.max(1,Math.floor(i*.35)),h=2,r=1;for(let _=0;_<l&&n+_<P;_++)this.set(o,n+_,a,h);const u=Math.min(n+l,P-1);for(let _=0;_<=d&&u+_<P;_++)for(let p=-d;p<=d;p++)for(let m=-d;m<=d;m++){const f=o+p,g=a+m;if(f<0||f>=S||g<0||g>=z)continue;Math.sqrt(p*p+_*_+m*m)<=d+.5&&this.set(f,u+_,g,r)}}putSmallHouse(t,e,s){this.putHollowBox(t,e,s,3,3,4,3),this.set(t+1,e+1,s,0)}putBigHouse(t,e,s){this.putHollowBox(t,e,s,5,4,6,3),this.set(t+2,e+1,s,0)}putToilet(t,e,s){this.putBox(t,e,s,2,2,2,9)}putMan(t,e,s){const l=(d,h,r,u)=>this.set(t+d,e+h,s+r,u);l(0,0,1,10),l(1,0,1,10),l(0,1,0,10),l(1,1,0,10),l(0,1,1,3),l(1,1,1,3),l(0,1,2,10),l(1,1,2,10),l(0,2,1,3),l(1,2,1,3),l(0,3,1,7),l(1,3,1,7),l(0,4,1,7),l(1,4,1,7),l(0,5,1,9),l(1,5,1,9)}putWoman(t,e,s){const l=(d,h,r,u)=>this.set(t+d,e+h,s+r,u);l(0,0,1,10),l(1,0,1,10),l(0,1,0,10),l(1,1,0,10),l(0,1,1,11),l(1,1,1,11),l(0,1,2,10),l(1,1,2,10),l(0,2,1,11),l(1,2,1,11),l(0,3,1,7),l(1,3,1,7),l(0,4,1,7),l(1,4,1,7),l(0,5,1,9),l(1,5,1,9)}putCat(t,e,s){const n=(a,l,d,h)=>this.set(t+a,e+l,s+d,h);n(0,0,0,7),n(1,0,0,7),n(0,1,0,7),n(1,1,0,9),n(0,1,1,7),n(1,1,1,7)}putDog(t,e,s){const a=(l,d,h,r)=>this.set(t+l,e+d,s+h,r);a(0,0,0,2),a(1,0,0,2),a(2,0,0,2),a(0,1,0,2),a(1,1,0,9),a(2,1,0,2),a(1,1,1,7)}putUnicorn(t,e,s){const a=(l,d,h,r)=>this.set(t+l,e+d,s+h,r);a(0,0,0,9),a(1,0,0,9),a(0,1,0,9),a(1,1,0,9),a(0,1,1,11),a(0,2,0,9),a(1,2,0,9),a(0,2,1,6)}putHill(t,e,s){for(let n=2;n>=0;n--)for(let a=-n;a<=n;a++)for(let l=-n;l<=n;l++)a*a+l*l<=n*n+.5&&this.set(t+a,e+(2-n),s+l,n===0?1:2)}putField(t,e,s){this.putBox(t,e,s,4,1,4,1)}getGridForDisplay(t){if(!t)return this.grid;const e=new Uint8Array(this.grid.length);e.set(this.grid);for(let s=0;s<this.roles.length;s++)this.roles[s]===G.SPAWN&&(e[s]=0);return e}roleAt(t,e,s){return this.getRole(Math.floor(t),Math.floor(e),Math.floor(s))}get spawnPos(){return[...this._spawnPos]}findSpawn(){for(let t=0;t<Z;t++)if(this.roles[t]===G.SPAWN){const e=t%S,s=Math.floor(t/S)%P,i=Math.floor(t/nt);return[e,s+1,i]}return[64,1,64]}reset(){var t;this.grid.fill(0),this.roles.fill(0),this.triggers=[],this.moverPaths={},this.portalTargets={},this._spawnPos=[64,1,64],(t=this.chunkManager)==null||t.markDirtyRegion(0,0,0,S-1,P-1,z-1)}generateDefault(){this.reset();for(let i=0;i<S;i++)for(let o=0;o<z;o++)this.set(i,0,o,1),(i===0||i===S-1||o===0||o===z-1)&&this.set(i,0,o,3);const t=Math.floor(S/2),e=Math.floor(z/2);this.set(t,1,e-10,6,G.SPAWN);const s=Math.min(20,z-e+6);for(let i=e-10;i<e-10+s;i++)this.set(t,0,i,3),this.set(t+1,0,i,3);this._placeWheelchairPerson(t-3,1,e-3)}_placeWheelchairPerson(t,e,s){const r=(_,p,m,f)=>this.set(t+_,e+p,s+m,f),u=(_,p,m,f,g,y)=>{for(let k=_;k<=p;k++)for(let A=f;A<=g;A++)r(k,m,A,y)};r(0,0,1,10),r(0,0,2,10),r(0,0,3,10),r(0,0,4,10),r(5,0,1,10),r(5,0,2,10),r(5,0,3,10),r(5,0,4,10),r(2,0,5,10),r(3,0,5,10),r(0,1,0,10),r(0,1,5,10),r(5,1,0,10),r(5,1,5,10),u(1,4,1,3,3,3),r(1,1,4,3),r(1,1,5,3),r(4,1,4,3),r(4,1,5,3),r(0,2,0,10),r(0,2,5,10),r(5,2,0,10),r(5,2,5,10),u(1,4,2,1,4,3),r(0,3,1,10),r(0,3,2,10),r(0,3,3,10),r(0,3,4,10),r(5,3,1,10),r(5,3,2,10),r(5,3,3,10),r(5,3,4,10),u(1,4,3,1,4,4),r(2,4,2,15),r(2,4,3,15),r(2,4,4,15),r(3,4,2,15),r(3,4,3,15),r(3,4,4,15),r(2,4,5,10),r(3,4,5,10),u(1,4,4,0,0,3),r(0,4,1,3),r(0,4,2,3),r(0,4,3,3),r(5,4,1,3),r(5,4,2,3),r(5,4,3,3),u(1,4,5,0,0,3),r(1,5,1,5),r(2,5,1,5),r(3,5,1,5),r(4,5,1,5),u(1,4,6,0,0,3),u(1,4,6,1,1,5),r(0,6,2,7),r(5,6,2,7),u(1,4,7,1,2,5),r(0,7,1,7),r(5,7,1,7),r(2,8,1,7),r(3,8,1,7),u(1,4,9,0,2,7),r(2,9,2,9),r(3,9,2,9),u(1,4,10,0,2,7),u(1,4,10,0,0,10),u(1,4,11,0,1,10)}serialize(){return{v:1,size:[S,P,z],grid:ft(this.grid),roles:ft(this.roles),palette:this.palette,triggers:this.triggers,moverPaths:this.moverPaths,portalTargets:this.portalTargets,name:this.name}}deserialize(t){var n;this.reset();const[e,s,i]=Array.isArray(t.size)?t.size:[t.size,t.size,t.size],o=e*s*i;if(o===Z)J(t.grid,this.grid),J(t.roles,this.roles);else{const a=new Uint8Array(o),l=new Uint8Array(o);J(t.grid,a),J(t.roles,l);const d=Math.min(e,S)*Math.min(s,P)*Math.min(i,z);for(let h=0;h<d;h++){const r=h%e,u=Math.floor(h/e)%s,_=Math.floor(h/(e*s));if(r<S&&u<P&&_<z){const p=r+u*S+_*nt;this.grid[p]=a[h],this.roles[p]=l[h]}}}this.palette=t.palette||this.palette,this.triggers=t.triggers||[],this.moverPaths=t.moverPaths||{},this.portalTargets=t.portalTargets||{},this.name=t.name||"Untitled",this._spawnPos=this.findSpawn(),(n=this.chunkManager)==null||n.markDirtyRegion(0,0,0,S-1,P-1,z-1)}}function ft(c){const t=[];let e=0;for(;e<c.length;){const s=c[e];let i=1;for(;e+i<c.length&&c[e+i]===s&&i<255;)i++;t.push(i,s),e+=i}return t}function J(c,t){let e=0;for(let s=0;s<c.length;s+=2){const i=c[s],o=c[s+1];for(let n=0;n<i&&e<t.length;n++)t[e++]=o}}const qt=25,Wt=9,gt=6,at=1.6,It=.3;class Vt{constructor(t){this._pickedUp=new Set,this._world=t;const[e,s,i]=t.findSpawn();this.state={x:e+.5,y:s,z:i+.5,vx:0,vy:0,vz:0,yaw:0,grounded:!1,alive:!0,score:0,won:!1}}respawn(){const[t,e,s]=this._world.findSpawn();this.state.x=t+.5,this.state.y=e,this.state.z=s+.5,this.state.vx=0,this.state.vy=0,this.state.vz=0,this.state.grounded=!1,this.state.alive=!0,this.state.won=!1}move(t,e,s,i){if(!this.state.alive||this.state.won)return null;const o=this.state,n=Math.sin(o.yaw),a=Math.cos(o.yaw),l=(-t*n+e*a)*gt,d=(t*a+e*n)*gt;if(o.vx=l,o.vz=d,o.vy-=qt*i,s&&o.grounded)return o.vy=Wt,o.grounded=!1,"jump";let h=null;return h=this._integrate(i),h}_integrate(t){const e=this.state,s=this._world;let i=null;const o=e.x+e.vx*t;this._collidesAt(o,e.y,e.z)?e.vx=0:e.x=o;const n=e.z+e.vz*t;this._collidesAt(e.x,e.y,n)?e.vz=0:e.z=n;const a=e.y+e.vy*t;if(!this._collidesAt(e.x,a,e.z))e.y=a,e.grounded=!1;else{e.vy<0&&(e.y=Math.floor(e.y)+.001,e.grounded=!0);const p=e.vy<0?Math.floor(e.y-.1):Math.floor(e.y+at);s.roleAt(Math.floor(e.x),p,Math.floor(e.z))===G.BOUNCY?(e.vy=-e.vy*1.3,e.grounded=!1,i="jump"):e.vy=0}const l=Math.floor(e.x),d=Math.floor(e.y),h=Math.floor(e.z),r=s.roleAt(l,d,h),u=s.roleAt(l,d+1,h),_=r||u;if(_===G.DEADLY)e.alive=!1,i="hit";else if(_===G.PICKUP){const p=r===G.PICKUP?d:d+1,m=`${l},${p},${h}`;this._pickedUp.has(m)||(this._pickedUp.add(m),s.clear(l,p,h),e.score++,i="pickup")}else if(_===G.FINISH)e.won=!0,i="win";else if(_===G.PORTAL){const p=`${l},${d},${h}`,m=s.portalTargets[p];m&&(e.x=m[0]+.5,e.y=m[1],e.z=m[2]+.5,i="pickup")}return e.y<-5&&(e.alive=!1,i="hit"),i}_collidesAt(t,e,s){const i=this._world,o=It;for(let n=0;n<at;n+=.8){const a=e+n;if(i.isSolid(t-o,a,s-o)||i.isSolid(t+o,a,s-o)||i.isSolid(t-o,a,s+o)||i.isSolid(t+o,a,s+o))return!0}return!!i.isSolid(t,e+at,s)}}class Ht{constructor(){this._fired=new Set,this._timers=new Map}reset(){this._fired.clear(),this._timers.clear()}evaluate(t,e,s,i){const o=[];for(const n of t){if(this._fired.has(n.id))continue;let a=!1;switch(n.type){case"touch":if(n.target){const l=Math.floor(e.x),d=Math.floor(e.y),h=Math.floor(e.z),[r,u,_]=n.target;a=l===r&&(d===u||d+1===u)&&h===_}break;case"click":break;case"timer":{const l=(this._timers.get(n.id)??0)+i;this._timers.set(n.id,l),a=l>=(n.params.seconds??10);break}case"score_gte":a=e.score>=(n.params.score??1);break}if(a){this._fired.add(n.id);const l=this._executeAction(n,e,s);l&&o.push(l)}}return o}checkClick(t,e,s,i,o,n){const a=[];for(const l of t)if(!(l.type!=="click"||this._fired.has(l.id))&&l.target&&l.target[0]===e&&l.target[1]===s&&l.target[2]===i){this._fired.add(l.id);const d=this._executeAction(l,o,n);d&&a.push(d)}return a}_executeAction(t,e,s){switch(t.action){case"text":return{type:"text",text:t.params.text??""};case"sound":return{type:"sound",sound:t.params.sound??"pickup"};case"win":return e.won=!0,{type:"win"};case"lose":return e.alive=!1,{type:"lose"};case"teleport":return t.params.x!=null?(e.x=t.params.x+.5,e.y=t.params.y,e.z=t.params.z+.5,{type:"teleport",x:t.params.x,y:t.params.y,z:t.params.z}):null;case"destroy":return t.target&&s.clear(t.target[0],t.target[1],t.target[2]),{type:"sound",sound:"explode"};case"spawn_block":return t.params.x!=null&&s.set(t.params.x,t.params.y,t.params.z,t.params.blockId??1),{type:"sound",sound:"pickup"}}return null}}const Q=.055,U=180/Math.PI,rt=2.5,lt=5.5,Xt=28;class Ut{constructor(){this.enabled=!1,this._baseAlpha=0,this._baseBeta=Xt,this._baseGamma=0,this._targetYaw=0,this._targetPitch=0,this._steerValue=0,this._targetForward=0,this._hasPermission=!1,this._smoothYaw=0,this._smoothPitch=0,this._handler=null,this._handlerAbsolute=null,this._motionHandler=null,this._sensor=null,this._linearSensor=null,this._motionActive=!1,this._orientationActive=!1,this._lastAccelZ=0,this._zoomVelocity=0}isAvailable(){const t=window;return typeof DeviceOrientationEvent<"u"||typeof DeviceMotionEvent<"u"||typeof(t==null?void 0:t.AbsoluteOrientationSensor)=="function"}async requestPermission(){const t=DeviceOrientationEvent,e=DeviceMotionEvent;if(typeof t.requestPermission=="function"){try{const i=await t.requestPermission();if(this._hasPermission=i==="granted",this._hasPermission&&typeof e.requestPermission=="function")try{const o=await e.requestPermission();this._hasPermission=o==="granted"}catch{}}catch{this._hasPermission=!1}return this._hasPermission}if(typeof e.requestPermission=="function"){try{const i=await e.requestPermission();this._hasPermission=i==="granted"}catch{this._hasPermission=!0}return this._hasPermission}const s=window;if(typeof s.AbsoluteOrientationSensor=="function")try{const i=new s.AbsoluteOrientationSensor({frequency:30});await i.start(),i.stop()}catch{}return this._hasPermission=!0,!0}async toggle(){return this.enabled?(this.stop(),!1):!this._hasPermission&&!await this.requestPermission()?!1:(this.start(),!0)}_deadZone(t){return Math.abs(t)<rt?0:t>0?t-rt:t+rt}_onOrientation(t){if(t.alpha==null||t.beta==null)return;this._orientationActive=!0;const e=this._deadZone(t.alpha-this._baseAlpha),s=this._deadZone(t.beta-this._baseBeta),i=t.gamma!=null?this._deadZone(t.gamma-this._baseGamma):0;this._targetYaw=e*.4,this._targetPitch=s*.4,this._targetForward=Math.max(-1,Math.min(1,s*.025)),this._steerValue=Math.max(-1,Math.min(1,i/25))}_deadZoneMotion(t){return Math.abs(t)<lt?0:t>0?t-lt:t+lt}_onMotion(t){if(this._orientationActive)return;const e=t.acceleration;(e==null?void 0:e.z)!=null&&this.feedAccelZ(e.z);const s=t.accelerationIncludingGravity;if(!s||s.x==null||s.y==null||s.z==null)return;const i=s.x,o=s.y,n=s.z,a=Math.sqrt(i*i+o*o+n*n)||1,l=i/a,d=o/a,h=n/a,r=Math.atan2(-h,-d+1e-6)*U,u=Math.atan2(l,-d+1e-6)*U,_=this._deadZoneMotion(r-this._baseBeta),p=this._deadZoneMotion(u-this._baseGamma);this._motionActive=!0,this._targetPitch=_*.4,this._targetForward=Math.max(-1,Math.min(1,_*.025)),this._steerValue=Math.max(-1,Math.min(1,p/25)),this._targetYaw=p*.4}_onSensorReading(){const t=this._sensor;if(!t||!t.quaternion)return;this._orientationActive=!0;const[e,s,i,o]=t.quaternion,n=2*(o*i+e*s),a=1-2*(s*s+i*i),l=Math.atan2(n,a)*U,d=2*(o*s-i*e),h=Math.asin(Math.max(-1,Math.min(1,d)))*U,r=2*(o*e+s*i),u=1-2*(e*e+s*s),_=Math.atan2(r,u)*U,p=this._deadZone(l-this._baseAlpha),m=this._deadZone(h-this._baseBeta),f=this._deadZone(_-this._baseGamma);this._targetYaw=p*.4,this._targetPitch=m*.4,this._targetForward=Math.max(-1,Math.min(1,m*.025)),this._steerValue=Math.max(-1,Math.min(1,f/25))}start(){if(!this._hasPermission||this._handler!==null||this._sensor!==null||this._motionHandler!==null)return;this.enabled=!0,this._orientationActive=!1;const t=window;if(typeof t.AbsoluteOrientationSensor=="function")try{const e=new t.AbsoluteOrientationSensor({frequency:30});e.addEventListener("reading",()=>this._onSensorReading()),e.start(),this._sensor=e}catch{}if(this._sensor===null){this._handler=e=>this._onOrientation(e),window.addEventListener("deviceorientation",this._handler),this._handlerAbsolute=e=>this._onOrientation(e);try{window.addEventListener("deviceorientationabsolute",this._handlerAbsolute)}catch{}}if(this._motionHandler=e=>this._onMotion(e),window.addEventListener("devicemotion",this._motionHandler),typeof t.LinearAccelerationSensor=="function")try{const e=new t.LinearAccelerationSensor({frequency:30});e.addEventListener("reading",()=>{this.feedAccelZ(e.z??0)}),e.start(),this._linearSensor=e}catch{}}stop(){if(this.enabled=!1,this._steerValue=0,this._targetForward=0,this._motionActive=!1,this._smoothYaw=0,this._smoothPitch=0,this._handler&&(window.removeEventListener("deviceorientation",this._handler),this._handler=null),this._handlerAbsolute){try{window.removeEventListener("deviceorientationabsolute",this._handlerAbsolute)}catch{}this._handlerAbsolute=null}if(this._motionHandler&&(window.removeEventListener("devicemotion",this._motionHandler),this._motionHandler=null),this._sensor){try{this._sensor.stop()}catch{}this._sensor=null}if(this._linearSensor){try{this._linearSensor.stop()}catch{}this._linearSensor=null}}calibrate(){this._baseAlpha+=this._targetYaw/.4,this._baseBeta+=this._targetPitch/.4,this._baseGamma+=this._steerValue*25,this._targetYaw=0,this._targetPitch=0,this._steerValue=0,this._targetForward=0,this._smoothYaw=0,this._smoothPitch=0}resetAndCalibrate(t){if(this.calibrate(),t.mode==="fly"){t.state.rotationX=0,t.state.rotationY=0;return}t.state.rotationX=-30,t.state.rotationY=35}getMoveVector(){return this.enabled?{forward:this._targetForward,right:this._steerValue}:{forward:0,right:0}}getSteer(){return this.enabled?this._steerValue:0}update(t){this.enabled&&(this._smoothYaw+=(this._targetYaw-this._smoothYaw)*Q,this._smoothPitch+=(this._targetPitch-this._smoothPitch)*Q,t.state.rotationY+=(this._smoothYaw-t.state.rotationY)*Q,t.state.rotationX+=(Math.max(-89,Math.min(89,this._smoothPitch))-t.state.rotationX)*Q,this._zoomVelocity*=.9,Math.abs(this._zoomVelocity)>.5&&t.zoom(this._zoomVelocity*.15))}feedAccelZ(t){this._zoomVelocity+=t*.02,this._zoomVelocity=Math.max(-20,Math.min(20,this._zoomVelocity))}destroy(){this.stop()}}class jt{constructor(){this._toastTimer=0,this._moveState={u:!1,d:!1,l:!1,r:!1},this._zoomDelta=0,this._lastUpTap=0,this.el=document.createElement("div"),this.el.className="hud",this.el.innerHTML='<div class="hud-top"><span class="hud-score">0</span></div><div class="hud-msg"></div><div class="hud-toast"></div><div class="hud-dpad" style="display:none"><button class="dp dp-u" data-d="u" type="button">&#9650;</button><button class="dp dp-l" data-d="l" type="button">&#9664;</button><button class="dp dp-r" data-d="r" type="button">&#9654;</button><button class="dp dp-d" data-d="d" type="button">&#9660;</button></div><div class="hud-zoom" style="display:none"><button class="hz hz-in" type="button">+</button><button class="hz hz-out" type="button">‚àí</button></div>',this._msg=this.el.querySelector(".hud-msg"),this._toast=this.el.querySelector(".hud-toast"),this._dpad=this.el.querySelector(".hud-dpad"),this._zoomWrap=this.el.querySelector(".hud-zoom"),this._dpad.querySelectorAll(".dp").forEach(t=>{const e=t.dataset.d,s=o=>{var n;if(o.preventDefault(),e==="u"){const a=Date.now();if(a-this._lastUpTap<400){(n=this.onJump)==null||n.call(this),this._lastUpTap=0;return}this._lastUpTap=a}this._moveState[e]=!0},i=o=>{o.preventDefault(),this._moveState[e]=!1};t.addEventListener("touchstart",s,{passive:!1}),t.addEventListener("touchend",i,{passive:!1}),t.addEventListener("mousedown",s),t.addEventListener("mouseup",i),t.addEventListener("mouseleave",i)}),this._zoomWrap.querySelector(".hz-in").addEventListener("click",t=>{var e;t.preventDefault(),this._zoomDelta+=2,(e=this.onZoomIn)==null||e.call(this)}),this._zoomWrap.querySelector(".hz-out").addEventListener("click",t=>{var e;t.preventDefault(),this._zoomDelta-=2,(e=this.onZoomOut)==null||e.call(this)}),this._zoomWrap.querySelector(".hz-in").addEventListener("touchstart",t=>{var e;t.preventDefault(),this._zoomDelta+=2,(e=this.onZoomIn)==null||e.call(this)},{passive:!1}),this._zoomWrap.querySelector(".hz-out").addEventListener("touchstart",t=>{var e;t.preventDefault(),this._zoomDelta-=2,(e=this.onZoomOut)==null||e.call(this)},{passive:!1})}getMoveInput(){const t=this._moveState;return{forward:(t.u?1:0)-(t.d?1:0),right:(t.r?1:0)-(t.l?1:0)}}consumeZoomDelta(){const t=this._zoomDelta;return this._zoomDelta=0,t}showMessage(t){this._msg.textContent=t,this._msg.style.display=t?"block":"none"}toast(t,e=2e3){this._toast.textContent=t,this._toast.classList.add("show"),clearTimeout(this._toastTimer),this._toastTimer=window.setTimeout(()=>{this._toast.classList.remove("show")},e)}setDpadVisible(t){this._dpad.style.display=t?"flex":"none",this._zoomWrap.style.display=t?"flex":"none"}destroy(){this.el.remove()}}let j=null;function Kt(){return j||(j=new AudioContext),j.state==="suspended"&&j.resume(),j}function B(c){try{const t=Kt(),e=t.currentTime;switch(c){case"jump":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.setValueAtTime(250,e),s.frequency.linearRampToValueAtTime(600,e+.12),i.gain.setValueAtTime(.15,e),i.gain.linearRampToValueAtTime(0,e+.15),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.15);break}case"hit":{const s=t.createBuffer(1,t.sampleRate*.2|0,t.sampleRate),i=s.getChannelData(0);for(let a=0;a<i.length;a++)i[a]=(Math.random()*2-1)*(1-a/i.length);const o=t.createBufferSource(),n=t.createGain();o.buffer=s,n.gain.setValueAtTime(.2,e),n.gain.linearRampToValueAtTime(0,e+.2),o.connect(n).connect(t.destination),o.start(e);break}case"pickup":{const s=t.createOscillator(),i=t.createOscillator(),o=t.createGain();s.type="square",s.frequency.value=523,i.type="square",i.frequency.value=659,o.gain.setValueAtTime(.08,e),o.gain.linearRampToValueAtTime(0,e+.2),s.connect(o),i.connect(o),o.connect(t.destination),s.start(e),s.stop(e+.1),i.start(e+.08),i.stop(e+.2);break}case"explode":{const s=t.createBuffer(1,t.sampleRate*.4|0,t.sampleRate),i=s.getChannelData(0);for(let l=0;l<i.length;l++)i[l]=(Math.random()*2-1)*(1-l/i.length)**.5;const o=t.createBufferSource(),n=t.createGain(),a=t.createBiquadFilter();a.type="lowpass",a.frequency.value=400,o.buffer=s,n.gain.setValueAtTime(.3,e),n.gain.linearRampToValueAtTime(0,e+.4),o.connect(a).connect(n).connect(t.destination),o.start(e);break}case"win":{[523,659,784,1047].forEach((i,o)=>{const n=t.createOscillator(),a=t.createGain();n.type="square",n.frequency.value=i,a.gain.setValueAtTime(.08,e+o*.12),a.gain.linearRampToValueAtTime(0,e+o*.12+.15),n.connect(a).connect(t.destination),n.start(e+o*.12),n.stop(e+o*.12+.15)});break}case"lose":{const s=t.createOscillator(),i=t.createGain();s.type="sawtooth",s.frequency.setValueAtTime(400,e),s.frequency.linearRampToValueAtTime(100,e+.4),i.gain.setValueAtTime(.12,e),i.gain.linearRampToValueAtTime(0,e+.5),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.5);break}case"click":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.value=800,i.gain.setValueAtTime(.05,e),i.gain.linearRampToValueAtTime(0,e+.05),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.05);break}case"place":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.value=180,i.gain.setValueAtTime(.04,e),i.gain.linearRampToValueAtTime(0,e+.14),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.14);break}}}catch{}}class Zt{constructor(t){this._selected=1,this._role=G.SOLID,this._colors=t,this.el=document.createElement("div"),this.el.className="palette-bar edit-only",this._renderSwatches(),this.roleBar=document.createElement("div"),this.roleBar.className="role-bar edit-only",this._renderRoles()}get selectedColor(){return this._selected}get selectedRole(){return this._role}get colorHex(){return this._colors[this._selected]||"#ff00ff"}_renderSwatches(){this.el.innerHTML="";for(let t=1;t<this._colors.length;t++){const e=document.createElement("div");e.className="pal-swatch"+(t===this._selected?" active":""),e.style.background=this._colors[t],e.dataset.i=String(t),this.el.appendChild(e)}this.el.addEventListener("click",t=>{var s;const e=t.target.closest(".pal-swatch");e&&(this._selected=Number(e.dataset.i),this.el.querySelectorAll(".pal-swatch").forEach(i=>i.classList.toggle("active",i===e)),(s=this.onChange)==null||s.call(this,this._selected,this._role))})}_renderRoles(){this.roleBar.innerHTML="";for(let t=0;t<_t.length;t++){const e=document.createElement("button");e.className="role-btn"+(t===this._role?" active":""),e.textContent=_t[t],e.dataset.r=String(t),this.roleBar.appendChild(e)}this.roleBar.addEventListener("click",t=>{var s;const e=t.target.closest(".role-btn");e&&(this._role=Number(e.dataset.r),this.roleBar.querySelectorAll(".role-btn").forEach(i=>i.classList.toggle("active",i===e)),(s=this.onChange)==null||s.call(this,this._selected,this._role))})}showRoles(t){this.roleBar.classList.toggle("show",t)}destroy(){this.el.remove(),this.roleBar.remove()}}const tt=250,et=N,st=F;class Jt{constructor(t){this._layerY=0,this._selectedColor=1,this._selectedRole=0,this._cellW=0,this._cellH=0,this._ctx=null,this._world=t,this.el=document.createElement("div"),this.el.className="layer-grid edit-only";const e=document.createElement("div");e.className="layer-grid-header";const s=document.createElement("span");s.className="layer-grid-label";const i=document.createElement("button");i.type="button",i.className="layer-grid-btn",i.textContent="Up",i.addEventListener("click",()=>this._setLayer(Math.min(R-1,this._layerY+1)));const o=document.createElement("button");o.type="button",o.className="layer-grid-btn",o.textContent="Down",o.addEventListener("click",()=>this._setLayer(Math.max(0,this._layerY-1))),e.appendChild(o),e.appendChild(s),e.appendChild(i),this.canvas=document.createElement("canvas"),this.canvas.width=tt,this.canvas.height=tt,this.canvas.className="layer-grid-canvas",this.canvas.style.display="none",this.el.appendChild(e),this.el.appendChild(this.canvas),this._updateLabel=()=>{s.textContent=`Layer ${this._layerY+1} of ${R}`},this._ctx=this.canvas.getContext("2d"),this._cellW=tt/et,this._cellH=tt/st,this._bindPointer(),this._updateLabel(),this._draw()}setSelectedColor(t){this._selectedColor=t}setSelectedRole(t){this._selectedRole=t}setLayer(t){this._layerY=Math.max(0,Math.min(R-1,t)),this._updateLabel(),this._draw()}_setLayer(t){this._layerY=t,this._updateLabel(),this._draw()}refresh(){this._draw()}_draw(){const t=this._ctx;if(!t)return;const e=this.canvas.width,s=this.canvas.height,i=this._cellW,o=this._cellH,n=this._world.palette;t.fillStyle="#1a1a2e",t.fillRect(0,0,e,s);for(let a=0;a<st;a++)for(let l=0;l<et;l++){const d=this._world.get(l,this._layerY,a),h=d===0?"#0f3460":n[d]||"#ff00ff";t.fillStyle=h;const r=l*i,u=a*o;t.fillRect(r+.5,u+.5,Math.max(1,i-1),Math.max(1,o-1))}t.strokeStyle="rgba(255,255,255,0.08)",t.lineWidth=1;for(let a=0;a<=et;a++)t.beginPath(),t.moveTo(a*i,0),t.lineTo(a*i,s),t.stroke();for(let a=0;a<=st;a++)t.beginPath(),t.moveTo(0,a*o),t.lineTo(e,a*o),t.stroke()}_bindPointer(){const t=s=>{const i=this.canvas.getBoundingClientRect(),o=this.canvas.width/i.width,n=this.canvas.height/i.height,a=("clientX"in s,s.clientX),l=("clientY"in s,s.clientY),d=(a-i.left)*o,h=(l-i.top)*n,r=Math.floor(d/this._cellW),u=Math.floor(h/this._cellH);return r<0||r>=et||u<0||u>=st?null:{x:r,z:u}},e=s=>{var r,u;s.preventDefault();const i=s,o=(r=i.touches)==null?void 0:r[0],n=t(o||i);if(!n)return;const{x:a,z:l}=n,d=this._layerY;this._world.get(a,d,l)===0?this._world.set(a,d,l,this._selectedColor,this._selectedRole):this._world.clear(a,d,l),this._draw(),(u=this.onChange)==null||u.call(this)};this.canvas.addEventListener("mousedown",e),this.canvas.addEventListener("touchstart",e,{passive:!1})}destroy(){this.el.remove()}}const Qt=["touch","click","timer","score_gte"],te=["destroy","teleport","text","sound","win","lose","spawn_block"];class ee{constructor(){this._triggers=[],this._nextId=1,this.el=document.createElement("div"),this.el.className="trigger-panel",this.el.innerHTML='<button class="btn-close-panel">&times;</button><h3>Triggers</h3><div class="trigger-list"></div><button class="btn-add-trigger">+ Add Trigger</button>',this._list=this.el.querySelector(".trigger-list"),this.el.querySelector(".btn-close-panel").addEventListener("click",()=>this.hide()),this.el.querySelector(".btn-add-trigger").addEventListener("click",()=>this._addTrigger())}show(){this.el.classList.add("show")}hide(){this.el.classList.remove("show")}get visible(){return this.el.classList.contains("show")}load(t){this._triggers=[...t],this._nextId=t.reduce((e,s)=>Math.max(e,s.id+1),1),this._render()}_addTrigger(){this._triggers.push({id:this._nextId++,type:"touch",target:[0,0,0],action:"text",params:{text:"Hello!"}}),this._render(),this._emit()}_removeTrigger(t){this._triggers=this._triggers.filter(e=>e.id!==t),this._render(),this._emit()}_render(){this._list.innerHTML="";for(const t of this._triggers){const e=document.createElement("div");e.className="trigger-card",e.innerHTML=`<label>IF</label><select class="t-type">${Qt.map(i=>`<option value="${i}"${i===t.type?" selected":""}>${i}</option>`).join("")}</select><label>Target Block (x,y,z)</label><input class="t-target" value="${t.target?t.target.join(","):""}" placeholder="x,y,z"><label>THEN</label><select class="t-action">${te.map(i=>`<option value="${i}"${i===t.action?" selected":""}>${i}</option>`).join("")}</select><label>Params (JSON)</label><input class="t-params" value='${JSON.stringify(t.params)}'><button class="role-btn" style="margin-top:6px;color:#f44336">Delete</button>`;const s=t.id;e.querySelector(".t-type").addEventListener("change",i=>{t.type=i.target.value,this._emit()}),e.querySelector(".t-target").addEventListener("change",i=>{const o=i.target.value.split(",").map(Number);o.length===3&&o.every(n=>!isNaN(n))&&(t.target=o),this._emit()}),e.querySelector(".t-action").addEventListener("change",i=>{t.action=i.target.value,this._emit()}),e.querySelector(".t-params").addEventListener("change",i=>{try{t.params=JSON.parse(i.target.value)}catch{}this._emit()}),e.querySelector("button").addEventListener("click",()=>this._removeTrigger(s)),this._list.appendChild(e)}}_emit(){var t;(t=this.onChange)==null||t.call(this,this._triggers)}destroy(){this.el.remove()}}const se=[{id:"bush",label:"–ö—É—Å—Ç",icon:"üåø",place:(c,t,e,s)=>c.putBush(t,e,s)},{id:"tree",label:"–î–µ—Ä–µ–≤–æ",icon:"üå≥",place:(c,t,e,s)=>c.putTree(t,e,s,6)}],ie=[{id:"smallHouse",label:"–î–æ–º–∏–∫",icon:"üè†",place:(c,t,e,s)=>c.putSmallHouse(t,e,s)},{id:"bigHouse",label:"–ë–æ–ª—å—à–æ–π –¥–æ–º",icon:"üèòÔ∏è",place:(c,t,e,s)=>c.putBigHouse(t,e,s)},{id:"toilet",label:"–¢—É–∞–ª–µ—Ç",icon:"üöª",place:(c,t,e,s)=>c.putToilet(t,e,s)}],oe=[{id:"man",label:"–ú—É–∂—á–∏–Ω–∞",icon:"üßë",place:(c,t,e,s)=>c.putMan(t,e,s)},{id:"woman",label:"–ñ–µ–Ω—â–∏–Ω–∞",icon:"üë©",place:(c,t,e,s)=>c.putWoman(t,e,s)}],ne=[{id:"cat",label:"–ö–æ—à–∫–∞",icon:"üê±",place:(c,t,e,s)=>c.putCat(t,e,s)},{id:"dog",label:"–°–æ–±–∞–∫–∞",icon:"üêï",place:(c,t,e,s)=>c.putDog(t,e,s)},{id:"unicorn",label:"–ï–¥–∏–Ω–æ—Ä–æ–≥",icon:"ü¶Ñ",place:(c,t,e,s)=>c.putUnicorn(t,e,s)}],ae=[{id:"hill",label:"–•–æ–ª–º",icon:"‚õ∞Ô∏è",place:(c,t,e,s)=>c.putHill(t,e,s)},{id:"field",label:"–ü–æ–ª–µ",icon:"üåæ",place:(c,t,e,s)=>c.putField(t,e,s)}],yt=[{id:"tree",label:"–î–µ—Ä–µ–≤—å—è",icon:"üå≤",stamps:se},{id:"house",label:"–î–æ–º–∞",icon:"üè†",stamps:ie},{id:"person",label:"–õ—é–¥–∏",icon:"üßë",stamps:oe},{id:"animal",label:"–ñ–∏–≤–æ—Ç–Ω—ã–µ",icon:"üêæ",stamps:ne},{id:"landscape",label:"–õ–∞–Ω–¥—à–∞—Ñ—Ç—ã",icon:"üåç",stamps:ae}];class re{constructor(t){this._selected=null,this._expandedCategory=null,this._world=t,this.el=document.createElement("div"),this.el.className="stamp-panel edit-only",this.el.style.display="none",this._render()}_render(){var t;this.el.innerHTML="",this.el.className="stamp-panel edit-only";for(const e of yt){const s=document.createElement("div");s.className="stamp-cat";const i=document.createElement("button");if(i.type="button",i.className="stamp-cat-header"+(this._expandedCategory===e.id?" open":""),i.innerHTML=`<span class="stamp-cat-icon">${e.icon}</span><span>${e.label}</span>`,i.addEventListener("click",()=>{this._expandedCategory=this._expandedCategory===e.id?null:e.id,this._render()}),s.appendChild(i),this._expandedCategory===e.id){const o=document.createElement("div");o.className="stamp-grid";for(const n of e.stamps){const a=document.createElement("button");a.type="button",a.className="stamp-btn"+(((t=this._selected)==null?void 0:t.id)===n.id?" active":""),a.innerHTML=`<span class="stamp-btn-icon">${n.icon}</span><span class="stamp-btn-label">${n.label}</span>`,a.title=n.label,a.addEventListener("click",l=>{var d,h;l.stopPropagation(),this._selected=((d=this._selected)==null?void 0:d.id)===n.id?null:n,this.el.querySelectorAll(".stamp-btn").forEach(r=>r.classList.toggle("active",r===a)),(h=this.onSelect)==null||h.call(this,this._selected)}),o.appendChild(a)}s.appendChild(o)}this.el.appendChild(s)}}get selected(){return this._selected}clearSelection(){var t;this._selected=null,this.el.querySelectorAll(".stamp-btn").forEach(e=>e.classList.remove("active")),(t=this.onSelect)==null||t.call(this,null)}placeAt(t,e,s){return this._selected?(this._selected.place(this._world,t,e,s),!0):!1}show(t){this.el.style.display=t?"flex":"none",t&&!this._expandedCategory&&(this._expandedCategory=yt[0].id),t&&this._render()}destroy(){this.el.remove()}}var bt;const le=(bt=navigator.language)!=null&&bt.startsWith("ru")?1:0,vt=[{draw:"Draw",erase:"Erase",role:"Role",triggers:"Triggers",play:"Play",save:"Save",share:"Share",undo:"Undo",redo:"Redo",layer:"Layer",of:"of",you_died:"You Died!",you_win:"You Win!",tap_retry:"Tap to retry",score:"Score",saved:"Saved!",save_fail:"Failed",link_copied:"Link copied!",back:"Back",start:"Start",splash_tip:"Tilt phone to move",gyro:"Gyro",gyro_toggle:"Gyro on/off",gyro_unavailable:"Gyro unavailable"},{draw:"–†–∏—Å–æ–≤–∞—Ç—å",erase:"–°—Ç–µ—Ä–µ—Ç—å",role:"–†–æ–ª—å",triggers:"–¢—Ä–∏–≥–≥–µ—Ä—ã",play:"–ò–≥—Ä–∞—Ç—å",save:"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",share:"–ü–æ–¥–µ–ª–∏—Ç—å—Å—è",undo:"–û—Ç–º–µ–Ω–∏—Ç—å",redo:"–í–µ—Ä–Ω—É—Ç—å",layer:"–°–ª–æ–π",of:"–∏–∑",you_died:"–¢—ã –ø–æ–≥–∏–±!",you_win:"–ü–æ–±–µ–¥–∞!",tap_retry:"–ù–∞–∂–º–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞",score:"–°—á—ë—Ç",saved:"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!",save_fail:"–û—à–∏–±–∫–∞",link_copied:"–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!",back:"–í—ã–π—Ç–∏",start:"–°—Ç–∞—Ä—Ç",splash_tip:"–ù–∞–∫–ª–æ–Ω ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",gyro:"–ì–∏—Ä–æ",gyro_toggle:"–ì–∏—Ä–æ –≤–∫–ª/–≤—ã–∫–ª",gyro_unavailable:"–ì–∏—Ä–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"}],D=c=>{var t;return((t=vt[le])==null?void 0:t[c])??vt[0][c]??c},he={top:[0,1,0],bottom:[0,-1,0],front:[0,0,1],back:[0,0,-1],right:[1,0,0],left:[-1,0,0]},C=class C{constructor(t,e,s){this._tool="draw",this._undoStack=[],this._redoStack=[],this._dragDist=0,this._longPressTimer=0,this._stickForward=0,this._stickRight=0,this._editorZoomDelta=0,this._defaultCamDistance=80,this._defaultCamRotX=-30,this._defaultCamRotY=35,this._world=t,this._gyro=s,this._sidePanel=document.createElement("div"),this._sidePanel.className="side-panel edit-only",this._sidePanel.innerHTML='<button class="sp-btn sp-undo" title="Undo">&#8630;</button><button class="sp-btn sp-redo" title="Redo">&#8631;</button>',e.appendChild(this._sidePanel),this._undoBtn=this._sidePanel.querySelector(".sp-undo"),this._redoBtn=this._sidePanel.querySelector(".sp-redo"),this._undoBtn.addEventListener("click",()=>this._undo()),this._redoBtn.addEventListener("click",()=>this._redo()),this._editorWrap=document.createElement("div"),this._editorWrap.className="editor-3d edit-only",e.appendChild(this._editorWrap),this._cam=new wt("orbit"),this._cam.state.distance=this._defaultCamDistance,this._cam.state.rotationX=this._defaultCamRotX,this._cam.state.rotationY=this._defaultCamRotY,this._cam.state.target.set(N/2,R/4,F/2),this._renderer=new xt(this._editorWrap,this._cam,700,8),this._mesh=new St(8),this._renderer.world.appendChild(this._mesh.el),this._mesh.el.style.transformStyle="preserve-3d",this._bindEditorInput(),this.palette=new Zt(t.palette),e.appendChild(this.palette.el),e.appendChild(this.palette.roleBar),this.layerGrid=new Jt(t),this.layerGrid.setSelectedColor(this.palette.selectedColor),this.layerGrid.setSelectedRole(this.palette.selectedRole),this.layerGrid.onChange=()=>{this._refreshMesh(),B("place")},this.palette.onChange=(h,r)=>{this.layerGrid.setSelectedColor(h),this.layerGrid.setSelectedRole(r)},e.appendChild(this.layerGrid.el),this._buildEditorJoystick(e);const i=1.2,o=2;let n=this._cam.state.rotationX,a=this._cam.state.rotationY,l=this._cam.state.distance;const d=()=>{var _;(_=this._gyro)!=null&&_.enabled?(this._gyro.update(this._cam),this._joystickPanel.style.display="none"):(this._joystickPanel.style.display="flex",(this._stickForward||this._stickRight)&&this._cam.orbit(this._stickRight*i,this._stickForward*i),this._editorZoomDelta&&this._cam.zoom(this._editorZoomDelta*o),this._editorZoomDelta=0);const h=this._cam.state.rotationX,r=this._cam.state.rotationY,u=this._cam.state.distance;(h!==n||r!==a||u!==l)&&(n=h,a=r,l=u,this._renderer.render()),requestAnimationFrame(d)};requestAnimationFrame(d),this.triggerEditor=new ee,this.triggerEditor.onChange=h=>{t.triggers=h},this.triggerEditor.load(t.triggers),e.appendChild(this.triggerEditor.el),this.stampPanel=new re(t),e.appendChild(this.stampPanel.el),this.toolbar=document.createElement("div"),this.toolbar.className="toolbar edit-only",this._rebuildToolbar(),e.appendChild(this.toolbar),this._bindToolbar(),this._refreshMesh(),this._updateUndoButtons()}_buildEditorJoystick(t){const e=document.createElement("div");e.className="editor-joystick edit-only",e.style.display="none",e.innerHTML='<div class="ej-dpad"><button class="ej-dp ej-u" data-d="u" type="button">&#9650;</button><button class="ej-dp ej-l" data-d="l" type="button">&#9664;</button><button class="ej-dp ej-r" data-d="r" type="button">&#9654;</button><button class="ej-dp ej-d" data-d="d" type="button">&#9660;</button></div><div class="ej-zoom"><button class="ej-z ej-in" type="button">+</button><button class="ej-z ej-out" type="button">‚àí</button></div>';const s=(o,n)=>{o==="u"?this._stickForward=1:o==="d"?this._stickForward=-1:o==="l"?this._stickRight=-1:this._stickRight=1},i=o=>{o==="u"||o==="d"?this._stickForward=0:this._stickRight=0};e.querySelectorAll(".ej-dp").forEach(o=>{const n=o.dataset.d;o.addEventListener("touchstart",a=>{a.preventDefault(),s(n)},{passive:!1}),o.addEventListener("touchend",()=>i(n)),o.addEventListener("mousedown",a=>{a.preventDefault(),s(n)}),o.addEventListener("mouseup",()=>i(n)),o.addEventListener("mouseleave",()=>i(n))}),e.querySelector(".ej-in").addEventListener("click",o=>{o.preventDefault(),this._editorZoomDelta+=1}),e.querySelector(".ej-out").addEventListener("click",o=>{o.preventDefault(),this._editorZoomDelta-=1}),e.querySelector(".ej-in").addEventListener("touchstart",o=>{o.preventDefault(),this._editorZoomDelta+=1},{passive:!1}),e.querySelector(".ej-out").addEventListener("touchstart",o=>{o.preventDefault(),this._editorZoomDelta-=1},{passive:!1}),t.appendChild(e),this._joystickPanel=e}_bindEditorInput(){let t=!1,e=0,s=0,i=null,o=0,n=0;const a=(h,r,u)=>{t=!0,e=h,s=r,o=h,n=r,this._dragDist=0,i=u,this._longPressTimer=window.setTimeout(()=>{if(this._dragDist<5&&(i!=null&&i.dataset.n)){const _=+i.dataset.x,p=+i.dataset.y,m=+i.dataset.z;this._handleErase(_,p,m)}i=null},500)},l=(h,r)=>{if(!t)return;const u=h-e,_=r-s;this._dragDist+=Math.abs(u)+Math.abs(_),this._cam.orbit(u*.4,_*.4),e=h,s=r},d=()=>{clearTimeout(this._longPressTimer),t&&this._dragDist<5&&i&&this._handleClick(i,o,n),t=!1,i=null};this._editorWrap.addEventListener("mousedown",h=>{const r=h.target.closest("[data-n]");r&&a(h.clientX,h.clientY,r)}),window.addEventListener("mousemove",h=>l(h.clientX,h.clientY)),window.addEventListener("mouseup",()=>d()),this._editorWrap.addEventListener("touchstart",h=>{h.preventDefault();const r=h.target.closest("[data-n]");r&&a(h.touches[0].clientX,h.touches[0].clientY,r)},{passive:!1}),this._editorWrap.addEventListener("touchmove",h=>{h.touches.length===1&&l(h.touches[0].clientX,h.touches[0].clientY)},{passive:!0}),this._editorWrap.addEventListener("touchend",()=>d()),this._editorWrap.addEventListener("wheel",h=>{h.preventDefault(),this._cam.zoom(h.deltaY*.02)},{passive:!1}),this._editorWrap.addEventListener("contextmenu",h=>{h.preventDefault();const r=this._renderer.pickVoxel(h.clientX,h.clientY,this._world.grid,N,R,F);r&&this._handleErase(r.x,r.y,r.z)})}_handleClick(t,e,s){const i=e!=null&&s!=null?this._renderer.pickVoxel(e,s,this._world.grid,N,R,F):null;if(!i)return;const{x:o,y:n,z:a,face:l}=i,d=he[l];if(!d)return;const h=o+d[0],r=n+d[1],u=a+d[2];if(this._tool==="stamp"&&this.stampPanel.selected){this.stampPanel.placeAt(h,r,u)&&(this._refreshMesh(),B("place"));return}if(this._tool==="erase"){this._handleErase(o,n,a);return}if(this._tool==="role"){const m=this._world.get(o,n,a);if(m===0)return;const f=this._world.getRole(o,n,a),g=this.palette.selectedRole;if(f===g)return;this._world.set(o,n,a,m,g),this._pushUndo(o,n,a,m,f,m,g),this._refreshMesh(),B("click");return}if(h<0||h>=N||r<0||r>=R||u<0||u>=F||this._world.get(h,r,u)!==0)return;const _=this.palette.selectedColor,p=this.palette.selectedRole;this._world.set(h,r,u,_,p),this._pushUndo(h,r,u,0,0,_,p),this._refreshMesh(),B("place")}_handleErase(t,e,s){const i=this._world.get(t,e,s),o=this._world.getRole(t,e,s);i!==0&&(this._world.clear(t,e,s),this._pushUndo(t,e,s,i,o,0,0),this._refreshMesh(),B("click"))}_pushUndo(t,e,s,i,o,n,a){this._undoStack.push({x:t,y:e,z:s,oldBlock:i,oldRole:o,newBlock:n,newRole:a}),this._undoStack.length>200&&this._undoStack.shift(),this._redoStack.length=0,this._updateUndoButtons()}_undo(){const t=this._undoStack.pop();t&&(this._world.set(t.x,t.y,t.z,t.oldBlock,t.oldRole),this._redoStack.push(t),this._refreshMesh(),this._updateUndoButtons(),B("click"))}_redo(){const t=this._redoStack.pop();t&&(this._world.set(t.x,t.y,t.z,t.newBlock,t.newRole),this._undoStack.push(t),this._refreshMesh(),this._updateUndoButtons(),B("click"))}_updateUndoButtons(){this._undoBtn.classList.toggle("disabled",this._undoStack.length===0),this._redoBtn.classList.toggle("disabled",this._redoStack.length===0)}_rebuildToolbar(){this.toolbar.innerHTML=`<div class="tb-group"><button class="tb-btn active" data-tool="draw" title="${D("draw")}">${C._iconPencil}</button><button class="tb-btn" data-tool="erase" title="${D("erase")}">${C._iconEraser}</button><button class="tb-btn" data-tool="role" title="${D("role")}">${C._iconGear}</button></div><div class="tb-divider"></div><div class="tb-group"><button class="tb-btn" data-tool="stamp" title="–®—Ç–∞–º–ø—ã">${C._iconStamp}</button><button class="tb-btn tb-triggers" title="${D("triggers")}">${C._iconLightning}</button></div><div class="tb-spacer"></div><div class="tb-group"><button class="tb-btn tb-play" title="${D("play")}">${C._iconPlay}</button><button class="tb-btn tb-save" title="${D("save")}">${C._iconFloppy}</button><button class="tb-btn tb-share" title="${D("share")}">${C._iconShare}</button></div>`}_bindToolbar(){this.toolbar.addEventListener("click",t=>{var i,o,n;const e=t.target.closest("button");if(!e)return;const s=e.dataset.tool;if(s){this._tool=s,this.toolbar.querySelectorAll("[data-tool]").forEach(a=>a.classList.toggle("active",a===e)),this.palette.showRoles(s==="role"),this.stampPanel.show(s==="stamp"),s!=="stamp"&&this.stampPanel.clearSelection();return}e.classList.contains("tb-triggers")?this.triggerEditor.show():e.classList.contains("tb-play")?(i=this.onPlay)==null||i.call(this):e.classList.contains("tb-save")?(o=this.onSave)==null||o.call(this):e.classList.contains("tb-share")&&((n=this.onShare)==null||n.call(this))})}_refreshMesh(){var t;this._world.chunkManager&&!this._world.chunkManager.hasDirty()||(this._mesh.rebuildFromGrid(this._world.grid,this._world.palette,N,R,F),(t=this._world.chunkManager)==null||t.clearDirty())}refresh(){this._refreshMesh(),this.layerGrid.refresh(),this.triggerEditor.load(this._world.triggers)}resetCameraPose(){this._cam.state.rotationX=this._defaultCamRotX,this._cam.state.rotationY=this._defaultCamRotY,this._cam.state.distance=this._defaultCamDistance,this._cam.state.target.set(N/2,R/4,F/2),this._renderer.render()}setVisible(t){const e=t?"":"none";this._editorWrap.style.display=e,this.layerGrid.el.style.display=e,this.palette.el.style.display=e,this.palette.roleBar.style.display="none",this.toolbar.style.display=t?"flex":"none",this.stampPanel.show(t&&this._tool==="stamp"),this._sidePanel.style.display=t?"flex":"none",t&&this.triggerEditor.hide()}destroy(){var t;this.palette.destroy(),this.layerGrid.destroy(),this.triggerEditor.destroy(),this.stampPanel.destroy(),this.toolbar.remove(),this._editorWrap.remove(),this._renderer.destroy(),this._sidePanel.remove(),(t=this._joystickPanel)==null||t.remove()}};C._iconPencil='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 15.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>',C._iconEraser='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16a2 2 0 010-2.83L16 3a2 2 0 012.83 0l2.83 2.83a2 2 0 010 2.83L10 20"/><path d="M18 13l-4-4"/><path d="M14 17l-4-4"/></svg>',C._iconGear='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>',C._iconLightning='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',C._iconPlay='<svg class="tb-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>',C._iconFloppy='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>',C._iconShare='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.82 3.98M15.41 6.51l-6.82 3.98"/></svg>',C._iconStamp='<svg class="tb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>';let ct=C;const dt="voxeldom_save";function ce(c){var t;try{const e=JSON.stringify(c);localStorage.setItem(dt,e);const s=(t=window.Telegram)==null?void 0:t.WebApp;return s!=null&&s.CloudStorage&&s.CloudStorage.setItem(dt,e),!0}catch{return!1}}function de(){try{const c=localStorage.getItem(dt);if(!c)return null;const t=JSON.parse(c);return t.v!==1?null:t}catch{return null}}function ue(c){const t=JSON.stringify(c);return btoa(unescape(encodeURIComponent(t)))}function pe(c){try{const t=decodeURIComponent(escape(atob(c))),e=JSON.parse(t);return e.v===1?e:null}catch{return null}}function it(){var c;return((c=window.Telegram)==null?void 0:c.WebApp)??null}function _e(){const c=it();c&&(c.ready(),c.expand())}function K(c="light"){var t,e;(e=(t=it())==null?void 0:t.HapticFeedback)==null||e.impactOccurred(c)}function me(c){var e;const t=it();t?t.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(c)}`):(e=navigator.clipboard)==null||e.writeText(c)}function ht(c,t){const e=it();e&&(c?(e.BackButton.show(),t&&e.BackButton.onClick(t)):e.BackButton.hide())}class fe{constructor(t){this._player=null,this._mode="splash",this._jumpPressed=!1,this._health=3,this._maxHealth=3,this._damageCooldown=0,this._lastTapTime=0,this._splashEl=null,this._pendingUrlPlay=!1,this._perfEl=null,this._perfLastAt=0,_e();const e=document.querySelector(t);if(!e)throw new Error("Container not found");this._container=e,this._flashEl=document.createElement("div"),this._flashEl.className="flash",e.appendChild(this._flashEl),this._world=new Ft;const s=new URLSearchParams(location.search).get("g");if(s){const i=pe(s);i?this._world.deserialize(i):this._world.generateDefault()}else{const i=de();i?this._world.deserialize(i):this._world.generateDefault()}this._engine=new Dt({container:e,voxelSize:16,perspective:700}),this._engine.renderer.root.style.display="none",this._mesh=new St(16),this._engine.scene.add(this._mesh),this._triggers=new Ht,this._gyro=new Ut,this._hud=new jt,e.appendChild(this._hud.el),this._hud.el.style.display="none",this._hud.onJump=()=>{this._jumpPressed=!0},this._engine.onUpdate(i=>this._update(i)),this._engine.start(),this._engine.pause(),this._gyroBtn=document.createElement("button"),this._gyroBtn.className="gyro-btn off",this._gyroBtn.type="button",this._gyroBtn.setAttribute("aria-label","Gyro"),this._gyroBtn.title=D("gyro_toggle")||"–ì–∏—Ä–æ –≤–∫–ª/–≤—ã–∫–ª",this._gyroBtn.innerHTML='<span class="gyro-icon"></span>',this._gyroBtn.addEventListener("click",()=>this._onGyroToggle()),e.appendChild(this._gyroBtn),e.addEventListener("pointerdown",i=>{const o=Date.now();o-this._lastTapTime<400?(this._resetAndCalibrateActiveCamera(),this._lastTapTime=0,K("light")):this._lastTapTime=o}),this._exitPlayBtn=document.createElement("button"),this._exitPlayBtn.className="exit-play-btn",this._exitPlayBtn.type="button",this._exitPlayBtn.textContent="‚Üê "+(D("back")||"–í—ã–π—Ç–∏"),this._exitPlayBtn.addEventListener("click",()=>this.setMode("edit")),e.appendChild(this._exitPlayBtn),this._exitPlayBtn.style.display="none",this._pendingUrlPlay=!!s,this._showSplash(),this._initPerfBaseline(),ht(!1)}_initPerfBaseline(){}_showSplash(){this._mode="splash",this._container.className="mode-splash",this._splashEl=document.createElement("div"),this._splashEl.className="splash";const t=D("start")||"–°—Ç–∞—Ä—Ç";this._splashEl.innerHTML='<div class="splash-title">PEEP</div><div class="splash-sub">'+(D("splash_tip")||"–ù–∞–∫–ª–æ–Ω —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ")+'</div><button class="splash-start" type="button">'+t+"</button>",this._splashEl.querySelector(".splash-start").addEventListener("click",()=>this._onSplashStart()),this._container.appendChild(this._splashEl),this._gyroBtn.style.display="none"}async _onSplashStart(){if(!this._splashEl)return;B("click"),K("light");let t=!1;this._gyro.isAvailable()&&await this._gyro.requestPermission()&&(this._gyro.start(),t=this._gyro.enabled),this._splashEl.remove(),this._splashEl=null,this._gyroBtn.style.display="",this._gyroBtn.classList.toggle("on",t),this._gyroBtn.classList.toggle("off",!t),this._initEditor(),this._pendingUrlPlay?(this._pendingUrlPlay=!1,this.setMode("play")):this.setMode("edit")}_initEditor(){this._editor||(this._editor=new ct(this._world,this._container,this._gyro),this._editor.onPlay=()=>this._onPlayClick(),this._editor.onSave=()=>this._save(),this._editor.onShare=()=>this._share(),this._editor.setVisible(!1))}_onPlayClick(){B("click"),this._gyro.requestPermission().then(t=>{t&&this._gyro.isAvailable()&&this._gyro.start(),this.setMode("play")})}setMode(t){var e;if(this._mode=t,this._container.className=t==="edit"?"mode-edit":"mode-play",t==="edit")this._initEditor(),this._editor.setVisible(!0),this._editor.refresh(),this._hud.el.style.display="none",this._exitPlayBtn.style.display="none",this._player=null,this._engine.camera.mode="orbit",this._engine.renderer.root.style.display="none",this._engine.pause(),ht(!1);else{(e=this._editor)==null||e.setVisible(!1),this._hud.el.style.display="",this._exitPlayBtn.style.display="block",this._hud.setDpadVisible(!this._gyro.enabled),this._hud.showMessage(""),this._engine.renderer.root.style.display="",this._engine.resume(),this._player=new Vt(this._world),this._triggers.reset(),this._mesh.rebuildFromGrid(this._world.getGridForDisplay(!0),this._world.palette,N,R,F),this._health=this._maxHealth,this._damageCooldown=0,this._engine.camera.mode="fly",this._engine.camera.state.rotationX=0,this._engine.camera.state.rotationY=0;const s=this._world.findSpawn();this._engine.camera.state.position.set(s[0]+.5,s[1]+1.5,s[2]+.5),ht(!0,()=>this.setMode("edit"))}}_update(t){if(this._updatePerfPanel(),this._mode!=="play")return;const e=this._player;if(!e)return;let s,i;if(this._gyro.enabled){const _=this._gyro.getMoveVector();s=_.forward,i=_.right}else{const _=this._hud.getMoveInput(),p=this._engine.input.state.keys;s=_.forward||(p.has("KeyW")||p.has("ArrowUp")?1:0)-(p.has("KeyS")||p.has("ArrowDown")?1:0),i=_.right||(p.has("KeyD")||p.has("ArrowRight")?1:0)-(p.has("KeyA")||p.has("ArrowLeft")?1:0)}const o=this._jumpPressed||this._engine.input.state.keys.has("Space");this._jumpPressed=!1;const{pinchDelta:n,deltaX:a,deltaY:l}=this._engine.input.state;n&&this._engine.camera.zoom(n*2);const d=this._hud.consumeZoomDelta();d&&this._engine.camera.zoom(d*2),!this._gyro.enabled&&(a||l)&&this._engine.camera.orbit(a*.4,l*.4),this._engine.input.resetDeltas(),e.state.yaw=this._engine.camera.state.rotationY*(Math.PI/180),this._gyro.enabled&&this._gyro.update(this._engine.camera);const h=e.move(s,i,o,t);h&&(B(h),K(h==="hit"?"heavy":"light"));const r=this._triggers.evaluate(this._world.triggers,e.state,this._world,t);this._handleEvents(r);const u=this._engine.camera.state;u.position.x=e.state.x,u.position.y=e.state.y+1.5,u.position.z=e.state.z,this._damageCooldown>0&&(this._damageCooldown-=t),!e.state.alive&&this._health>0&&this._damageCooldown<=0&&(this._health--,this._damageCooldown=1,this._health>0&&(e.state.alive=!0,B("hit"),K("heavy"))),this._hud.el.querySelector(".hud-top").innerHTML=`<span class="hud-score">${e.state.score}</span> &nbsp; ${"&#9829;".repeat(this._health)}${"&#9825;".repeat(this._maxHealth-this._health)}`,!e.state.alive&&this._health<=0?(this._hud.showMessage(`${D("you_died")} ${D("tap_retry")}`),this._waitForTap(()=>{e.respawn(),this._health=this._maxHealth,this._hud.showMessage(""),this._mesh.rebuildFromGrid(this._world.getGridForDisplay(!0),this._world.palette,N,R,F)})):e.state.won&&(this._hud.showMessage(D("you_win")),this._waitForTap(()=>this.setMode("edit")))}_updatePerfPanel(){if(!this._perfEl)return;const t=performance.now();if(t-this._perfLastAt<500)return;this._perfLastAt=t;const e=zt(),s=Lt(),i=this._mesh.faceCount,o=e>=pt.FPS_MIN;this._perfEl.textContent=`FPS ${e} ${o?"OK":"LOW"} | DOM ${s} | faces ${i} | size gate < ${pt.BUNDLE_MAX_KB}KB raw/gzip`}_handleEvents(t){for(const e of t)e.type==="text"?this._hud.toast(e.text,3e3):e.type==="sound"?B(e.sound):e.type==="win"?B("win"):e.type==="lose"?B("lose"):e.type==="teleport"&&B("pickup");t.some(e=>e.type==="sound"&&e.sound==="explode")&&this._mesh.rebuildFromGrid(this._world.getGridForDisplay(!0),this._world.palette,N,R,F)}_waitForTap(t){const e=()=>{document.removeEventListener("pointerdown",e),t()};setTimeout(()=>document.addEventListener("pointerdown",e),500)}_resetAndCalibrateActiveCamera(){this._mode==="edit"&&this._editor?this._editor.resetCameraPose():this._mode==="play"&&(this._engine.camera.state.rotationX=0,this._engine.camera.state.rotationY=0),this._mode==="play"?this._gyro.resetAndCalibrate(this._engine.camera):this._gyro.calibrate()}async _onGyroToggle(){if(!this._gyro.isAvailable()){this._hud.toast(D("gyro_unavailable"),1200);return}const t=await this._gyro.toggle();this._gyroBtn.classList.toggle("on",t),this._gyroBtn.classList.toggle("off",!t),this._mode==="play"&&this._hud.setDpadVisible(!t),K("light")}_save(){const t=ce(this._world.serialize());this._hud.toast(D(t?"saved":"save_fail"),1500),B("pickup")}_share(){const t=ue(this._world.serialize()),e=`${location.origin}${location.pathname}?g=${t}`;me(e),this._hud.toast(D("link_copied"),1500)}}const ge=new fe("#app");window.voxelApp=ge;
