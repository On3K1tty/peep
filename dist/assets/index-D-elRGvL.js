(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class L{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return new L(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new L(this.x-t.x,this.y-t.y,this.z-t.z)}scale(t){return new L(this.x*t,this.y*t,this.z*t)}len(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){const t=this.len()||1;return new L(this.x/t,this.y/t,this.z/t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){return new L(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}clone(){return new L(this.x,this.y,this.z)}}class y{constructor(){this.m=new Float64Array(16),this.m[0]=this.m[5]=this.m[10]=this.m[15]=1}static identity(){return new y}static perspective(t,e,s,i){const n=new y,r=n.m,o=1/Math.tan(t/2),h=1/(s-i);return r.fill(0),r[0]=o/e,r[5]=o,r[10]=(i+s)*h,r[11]=-1,r[14]=2*i*s*h,n}static translation(t,e,s){const i=new y;return i.m[12]=t,i.m[13]=e,i.m[14]=s,i}static rotationX(t){const e=new y,s=Math.cos(t),i=Math.sin(t);return e.m[5]=s,e.m[6]=i,e.m[9]=-i,e.m[10]=s,e}static rotationY(t){const e=new y,s=Math.cos(t),i=Math.sin(t);return e.m[0]=s,e.m[2]=-i,e.m[8]=i,e.m[10]=s,e}static rotationZ(t){const e=new y,s=Math.cos(t),i=Math.sin(t);return e.m[0]=s,e.m[1]=i,e.m[4]=-i,e.m[5]=s,e}static scaling(t,e,s){const i=new y;return i.m[0]=t,i.m[5]=e,i.m[10]=s,i}multiply(t){const e=new y,s=this.m,i=t.m,n=e.m;for(let r=0;r<4;r++)for(let o=0;o<4;o++)n[o*4+r]=s[r]*i[o*4]+s[4+r]*i[o*4+1]+s[8+r]*i[o*4+2]+s[12+r]*i[o*4+3];return e}invert(){const t=this.m,e=new y,s=e.m,i=t[0],n=t[1],r=t[2],o=t[3],h=t[4],c=t[5],d=t[6],a=t[7],u=t[8],p=t[9],f=t[10],_=t[11],b=t[12],v=t[13],w=t[14],x=t[15],k=i*c-n*h,C=i*d-r*h,A=i*a-o*h,B=n*d-r*c,z=n*a-o*c,M=r*a-o*d,D=u*v-p*b,$=u*w-f*b,Y=u*x-_*b,G=p*w-f*v,R=p*x-_*v,N=f*x-_*w;let m=k*N-C*R+A*G+B*Y-z*$+M*D;return m&&(m=1/m,s[0]=(c*N-d*R+a*G)*m,s[1]=(r*R-n*N-o*G)*m,s[2]=(v*M-w*z+x*B)*m,s[3]=(f*z-p*M-_*B)*m,s[4]=(d*Y-h*N-a*$)*m,s[5]=(i*N-r*Y+o*$)*m,s[6]=(w*A-b*M-x*C)*m,s[7]=(u*M-f*A+_*C)*m,s[8]=(h*R-c*Y+a*D)*m,s[9]=(n*Y-i*R-o*D)*m,s[10]=(b*z-v*A+x*k)*m,s[11]=(p*A-u*z-_*k)*m,s[12]=(c*$-h*G-d*D)*m,s[13]=(i*G-n*$+r*D)*m,s[14]=(v*C-b*B-w*k)*m,s[15]=(u*B-p*C+f*k)*m),e}toCSS(){const t=this.m;return`matrix3d(${t[0]},${t[1]},${t[2]},${t[3]},${t[4]},${t[5]},${t[6]},${t[7]},${t[8]},${t[9]},${t[10]},${t[11]},${t[12]},${t[13]},${t[14]},${t[15]})`}transformPoint(t){const e=this.m,s=e[3]*t.x+e[7]*t.y+e[11]*t.z+e[15]||1;return new L((e[0]*t.x+e[4]*t.y+e[8]*t.z+e[12])/s,(e[1]*t.x+e[5]*t.y+e[9]*t.z+e[13])/s,(e[2]*t.x+e[6]*t.y+e[10]*t.z+e[14])/s)}}const P=Math.PI/180;class Q{constructor(t="orbit"){this._mode=t,this.state={position:new L(0,5,10),rotationX:-25,rotationY:45,distance:20,target:new L(0,0,0)}}get mode(){return this._mode}getViewMatrix(t=1){const e=t;if(this._mode==="orbit"){const r=y.rotationX(this.state.rotationX*P),o=y.rotationY(this.state.rotationY*P),h=y.translation(-this.state.target.x*e,this.state.target.y*e,-this.state.target.z*e);return y.translation(0,0,-this.state.distance*e).multiply(r).multiply(o).multiply(h)}const s=y.rotationX(-this.state.rotationX*P),i=y.rotationY(-this.state.rotationY*P),n=y.translation(-this.state.position.x*e,this.state.position.y*e,-this.state.position.z*e);return s.multiply(i).multiply(n)}orbit(t,e){this.state.rotationY+=t,this.state.rotationX=Math.max(-89,Math.min(89,this.state.rotationX+e))}zoom(t){this.state.distance=Math.max(2,Math.min(100,this.state.distance+t))}moveLocal(t,e,s){const i=this.state.rotationY*P,n=Math.sin(i),r=Math.cos(i);this.state.position.x+=e*r-t*n,this.state.position.y+=s,this.state.position.z+=e*n+t*r}}class tt{constructor(t,e,s=800,i=20){this.camera=e,this._perspectivePx=s,this._voxelSize=i,this.root=document.createElement("div"),this.root.className="voxel-world",Object.assign(this.root.style,{position:"relative",width:"100%",height:"100%",overflow:"hidden",contain:"strict",perspective:`${s}px`,perspectiveOrigin:"50% 50%"}),this.world=document.createElement("div"),Object.assign(this.world.style,{position:"absolute",left:"50%",top:"50%",transformStyle:"preserve-3d",willChange:"transform"}),this.root.appendChild(this.world),t.appendChild(this.root)}get voxelSize(){return this._voxelSize}get perspectivePx(){return this._perspectivePx}render(){const t=this.camera.getViewMatrix(this._voxelSize);this.world.style.transform=t.toCSS()}destroy(){this.root.remove()}}class it{constructor(t){this.state={keys:new Set,pointerDown:!1,pointerX:0,pointerY:0,deltaX:0,deltaY:0,pinchDelta:0},this._listeners=[],this._lastTouchDist=0,this._el=t,this._bind()}onVoxelClick(t){this._onVoxelClick=t}resetDeltas(){this.state.deltaX=0,this.state.deltaY=0,this.state.pinchDelta=0}_on(t,e,s,i){t.addEventListener(e,s,i),this._listeners.push([t,e,s])}_bind(){this._on(window,"keydown",t=>{this.state.keys.add(t.code)}),this._on(window,"keyup",t=>{this.state.keys.delete(t.code)}),this._on(this._el,"mousedown",t=>{this.state.pointerDown=!0;const e=t;this.state.pointerX=e.clientX,this.state.pointerY=e.clientY}),this._on(window,"mouseup",()=>{this.state.pointerDown=!1}),this._on(window,"mousemove",t=>{const e=t;this.state.pointerDown&&(this.state.deltaX+=e.clientX-this.state.pointerX,this.state.deltaY+=e.clientY-this.state.pointerY),this.state.pointerX=e.clientX,this.state.pointerY=e.clientY}),this._on(this._el,"wheel",t=>{t.preventDefault(),this.state.pinchDelta+=t.deltaY*.01},{passive:!1}),this._on(this._el,"touchstart",t=>{t.preventDefault();const e=t;e.touches.length===1&&(this.state.pointerDown=!0,this.state.pointerX=e.touches[0].clientX,this.state.pointerY=e.touches[0].clientY),e.touches.length===2&&(this._lastTouchDist=this._touchDist(e))},{passive:!1}),this._on(this._el,"touchmove",t=>{t.preventDefault();const e=t;if(e.touches.length===1&&this.state.pointerDown){const s=e.touches[0].clientX,i=e.touches[0].clientY;this.state.deltaX+=s-this.state.pointerX,this.state.deltaY+=i-this.state.pointerY,this.state.pointerX=s,this.state.pointerY=i}if(e.touches.length===2){const s=this._touchDist(e);this.state.pinchDelta+=(this._lastTouchDist-s)*.05,this._lastTouchDist=s}},{passive:!1}),this._on(this._el,"touchend",()=>{this.state.pointerDown=!1}),this._on(this._el,"click",t=>{const e=t.target;e.dataset.vx!==void 0&&this._onVoxelClick&&this._onVoxelClick({x:Number(e.dataset.vx),y:Number(e.dataset.vy),z:Number(e.dataset.vz),normal:e.dataset.normal||""})})}_touchDist(t){const e=t.touches[0].clientX-t.touches[1].clientX,s=t.touches[0].clientY-t.touches[1].clientY;return Math.sqrt(e*e+s*s)}destroy(){for(const[t,e,s]of this._listeners)t.removeEventListener(e,s);this._listeners.length=0}}class rt{constructor(t){this._nodes=[],this._worldEl=t}add(t){this._nodes.push(t),this._worldEl.appendChild(t.el),t.update()}remove(t){const e=this._nodes.indexOf(t);e>=0&&this._nodes.splice(e,1),t.destroy()}clear(){for(const t of this._nodes)t.destroy();this._nodes.length=0}update(){for(const t of this._nodes)t.update()}get nodes(){return this._nodes}}class nt{constructor(t){this._running=!1,this._paused=!1,this._rafId=0,this._lastTime=0,this._updateCbs=[],this._tick=s=>{if(!this._running)return;if(this._rafId=requestAnimationFrame(this._tick),this._paused){this._lastTime=s;return}const i=Math.min((s-this._lastTime)/1e3,.1);this._lastTime=s;for(const n of this._updateCbs)n(i);this.scene.update(),this.renderer.render(),this.input.resetDeltas()};const e=typeof t.container=="string"?document.querySelector(t.container):t.container;if(!e)throw new Error("VoxelDOM: container not found");this.camera=new Q("orbit"),this.renderer=new tt(e,this.camera,t.perspective??800,t.voxelSize??16),this.scene=new rt(this.renderer.world),this.input=new it(this.renderer.root)}get voxelSize(){return this.renderer.voxelSize}get running(){return this._running}get paused(){return this._paused}onUpdate(t){this._updateCbs.push(t)}clearCallbacks(){this._updateCbs.length=0}onVoxelClick(t){this.input.onVoxelClick(t)}start(){this._running||(this._running=!0,this._paused=!1,this._lastTime=performance.now(),this._tick(this._lastTime))}stop(){this._running=!1,cancelAnimationFrame(this._rafId)}pause(){this._paused=!0}resume(){this._paused=!1,this._lastTime=performance.now()}destroy(){this.stop(),this.scene.clear(),this.input.destroy(),this.renderer.destroy()}}const at=[{normal:"top",axis:1,u:0,v:2,dir:1},{normal:"bottom",axis:1,u:0,v:2,dir:-1},{normal:"right",axis:0,u:2,v:1,dir:1},{normal:"left",axis:0,u:2,v:1,dir:-1},{normal:"front",axis:2,u:0,v:1,dir:1},{normal:"back",axis:2,u:0,v:1,dir:-1}];function ot(l,t,e=32){const s=[],i=e*e;function n(c,d,a){return c+d*e+a*i}function r(c,d,a){return c<0||c>=e||d<0||d>=e||a<0||a>=e?!1:l[n(c,d,a)]!==0}function o(c,d,a){return c<0||c>=e||d<0||d>=e||a<0||a>=e?0:l[n(c,d,a)]}const h=new Int32Array(e*e);for(const c of at)for(let d=0;d<e;d++){h.fill(0);for(let a=0;a<e;a++)for(let u=0;u<e;u++){const p=[0,0,0];p[c.axis]=d,p[c.u]=u,p[c.v]=a;const f=o(p[0],p[1],p[2]);if(f===0)continue;const _=[0,0,0];_[c.axis]=d+c.dir,_[c.u]=u,_[c.v]=a,!r(_[0],_[1],_[2])&&(h[a*e+u]=f)}for(let a=0;a<e;a++)for(let u=0;u<e;){const p=h[a*e+u];if(p===0){u++;continue}let f=1;for(;u+f<e&&h[a*e+u+f]===p;)f++;let _=1,b=!1;for(;a+_<e&&!b;){for(let w=0;w<f;w++)if(h[(a+_)*e+u+w]!==p){b=!0;break}b||_++}for(let w=0;w<_;w++)for(let x=0;x<f;x++)h[(a+w)*e+u+x]=0;const v=[0,0,0];v[c.axis]=d,v[c.u]=u,v[c.v]=a,s.push({x:v[0],y:v[1],z:v[2],w:f,h:_,normal:c.normal,color:t[p]||"#ff00ff"}),u+=f}}return s}const lt={top:1,front:.85,back:.7,right:.8,left:.75,bottom:.6};class et{constructor(t=16){this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.scale={x:1,y:1,z:1},this._faceEls=[],this._faceCount=0,this._voxelSize=t,this.el=document.createElement("div"),this.el.style.position="absolute",this.el.style.transformStyle="preserve-3d",this.el.style.willChange="transform"}get faceCount(){return this._faceCount}rebuildFromGrid(t,e,s=32){const i=ot(t,e,s);this._faceCount=i.length;for(const r of this._faceEls)r.remove();this._faceEls.length=0;const n=this._voxelSize;for(const r of i){const o=document.createElement("div"),h=r.w*n,c=r.h*n;o.className="vf",o.style.cssText=`position:absolute;width:${h}px;height:${c}px;backface-visibility:hidden;transform-origin:0 0;image-rendering:pixelated;pointer-events:auto;background:${r.color};filter:brightness(${lt[r.normal]})`,o.style.transform=ht(r,n),o.dataset.n=r.normal,o.dataset.x=String(r.x),o.dataset.y=String(r.y),o.dataset.z=String(r.z),this.el.appendChild(o),this._faceEls.push(o)}}update(){const t=this._voxelSize,e=y.translation(this.position.x*t,-this.position.y*t,this.position.z*t),s=y.rotationY(this.rotation.y*P);this.el.style.transform=e.multiply(s).toCSS()}destroy(){for(const t of this._faceEls)t.remove();this._faceEls.length=0,this.el.remove()}}function ht(l,t){const e=l.x,s=l.y,i=l.z;switch(l.normal){case"top":return`translate3d(${e*t}px,${-(s+1)*t}px,${i*t}px) rotateX(90deg)`;case"bottom":return`translate3d(${e*t}px,${-s*t}px,${(i+l.h)*t}px) rotateX(-90deg)`;case"front":return`translate3d(${e*t}px,${-(s+l.h)*t}px,${(i+1)*t}px)`;case"back":return`translate3d(${(e+l.w)*t}px,${-(s+l.h)*t}px,${i*t}px) rotateY(180deg)`;case"right":return`translate3d(${(e+1)*t}px,${-(s+l.h)*t}px,${(i+l.w)*t}px) rotateY(90deg)`;case"left":return`translate3d(${e*t}px,${-(s+l.h)*t}px,${i*t}px) rotateY(-90deg)`}}var E=(l=>(l[l.SOLID=0]="SOLID",l[l.DEADLY=1]="DEADLY",l[l.BOUNCY=2]="BOUNCY",l[l.PICKUP=3]="PICKUP",l[l.SPAWN=4]="SPAWN",l[l.FINISH=5]="FINISH",l[l.MOVER=6]="MOVER",l[l.PORTAL=7]="PORTAL",l))(E||{});const W=["solid","deadly","bouncy","pickup","spawn","finish","mover","portal"],st=32,g=st,j=g*g,F=g*g*g,ct=["","#4CAF50","#795548","#9E9E9E","#F44336","#2196F3","#FFEB3B","#FF9800","#9C27B0","#FFFFFF","#212121","#E91E63","#00BCD4","#8BC34A","#FF5722","#607D8B"];class dt{constructor(){this.triggers=[],this.moverPaths={},this.portalTargets={},this.name="Untitled",this._spawnPos=[16,20,16],this.grid=new Uint8Array(F),this.roles=new Uint8Array(F),this.palette=[...ct]}_idx(t,e,s){return t+e*g+s*j}get(t,e,s){return t<0||t>=g||e<0||e>=g||s<0||s>=g?0:this.grid[this._idx(t,e,s)]}getRole(t,e,s){return t<0||t>=g||e<0||e>=g||s<0||s>=g?0:this.roles[this._idx(t,e,s)]}set(t,e,s,i,n=E.SOLID){if(t<0||t>=g||e<0||e>=g||s<0||s>=g)return;const r=this._idx(t,e,s);this.grid[r]=i,this.roles[r]=n,n===E.SPAWN&&(this._spawnPos=[t,e+1,s])}clear(t,e,s){if(t<0||t>=g||e<0||e>=g||s<0||s>=g)return;const i=this._idx(t,e,s);this.grid[i]=0,this.roles[i]=0}isSolid(t,e,s){return this.get(Math.floor(t),Math.floor(e),Math.floor(s))!==0}roleAt(t,e,s){return this.getRole(Math.floor(t),Math.floor(e),Math.floor(s))}get spawnPos(){return[...this._spawnPos]}findSpawn(){for(let t=0;t<F;t++)if(this.roles[t]===E.SPAWN){const e=t%g,s=Math.floor(t/g)%g,i=Math.floor(t/j);return[e,s+1,i]}return[16,20,16]}reset(){this.grid.fill(0),this.roles.fill(0),this.triggers=[],this.moverPaths={},this.portalTargets={},this._spawnPos=[16,20,16]}generateDefault(){this.reset();for(let t=0;t<g;t++)for(let e=0;e<g;e++)this.set(t,0,e,1),(t===0||t===g-1||e===0||e===g-1)&&this.set(t,0,e,3);this.set(4,1,4,6,E.SPAWN);for(let t=4;t<20;t++)this.set(4,0,t,3),this.set(5,0,t,3);this._placeWheelchairPerson(14,1,14)}_placeWheelchairPerson(t,e,s){const a=(p,f,_,b)=>this.set(t+p,e+f,s+_,b),u=(p,f,_,b,v,w)=>{for(let x=p;x<=f;x++)for(let k=b;k<=v;k++)a(x,_,k,w)};a(0,0,1,10),a(0,0,2,10),a(0,0,3,10),a(0,0,4,10),a(5,0,1,10),a(5,0,2,10),a(5,0,3,10),a(5,0,4,10),a(2,0,5,10),a(3,0,5,10),a(0,1,0,10),a(0,1,5,10),a(5,1,0,10),a(5,1,5,10),u(1,4,1,3,3,3),a(1,1,4,3),a(1,1,5,3),a(4,1,4,3),a(4,1,5,3),a(0,2,0,10),a(0,2,5,10),a(5,2,0,10),a(5,2,5,10),u(1,4,2,1,4,3),a(0,3,1,10),a(0,3,2,10),a(0,3,3,10),a(0,3,4,10),a(5,3,1,10),a(5,3,2,10),a(5,3,3,10),a(5,3,4,10),u(1,4,3,1,4,4),a(2,4,2,15),a(2,4,3,15),a(2,4,4,15),a(3,4,2,15),a(3,4,3,15),a(3,4,4,15),a(2,4,5,10),a(3,4,5,10),u(1,4,4,0,0,3),a(0,4,1,3),a(0,4,2,3),a(0,4,3,3),a(5,4,1,3),a(5,4,2,3),a(5,4,3,3),u(1,4,5,0,0,3),a(1,5,1,5),a(2,5,1,5),a(3,5,1,5),a(4,5,1,5),u(1,4,6,0,0,3),u(1,4,6,1,1,5),a(0,6,2,7),a(5,6,2,7),u(1,4,7,1,2,5),a(0,7,1,7),a(5,7,1,7),a(2,8,1,7),a(3,8,1,7),u(1,4,9,0,2,7),a(2,9,2,9),a(3,9,2,9),u(1,4,10,0,2,7),u(1,4,10,0,0,10),u(1,4,11,0,1,10)}serialize(){return{v:1,size:g,grid:H(this.grid),roles:H(this.roles),palette:this.palette,triggers:this.triggers,moverPaths:this.moverPaths,portalTargets:this.portalTargets,name:this.name}}deserialize(t){this.reset(),K(t.grid,this.grid),K(t.roles,this.roles),this.palette=t.palette,this.triggers=t.triggers||[],this.moverPaths=t.moverPaths||{},this.portalTargets=t.portalTargets||{},this.name=t.name||"Untitled",this._spawnPos=this.findSpawn()}}function H(l){const t=[];let e=0;for(;e<l.length;){const s=l[e];let i=1;for(;e+i<l.length&&l[e+i]===s&&i<255;)i++;t.push(i,s),e+=i}return t}function K(l,t){let e=0;for(let s=0;s<l.length;s+=2){const i=l[s],n=l[s+1];for(let r=0;r<i&&e<t.length;r++)t[e++]=n}}const ut=25,pt=9,J=6,U=1.6,_t=.3;class ft{constructor(t){this._pickedUp=new Set,this._world=t;const[e,s,i]=t.findSpawn();this.state={x:e+.5,y:s,z:i+.5,vx:0,vy:0,vz:0,yaw:0,grounded:!1,alive:!0,score:0,won:!1}}respawn(){const[t,e,s]=this._world.findSpawn();this.state.x=t+.5,this.state.y=e,this.state.z=s+.5,this.state.vx=0,this.state.vy=0,this.state.vz=0,this.state.grounded=!1,this.state.alive=!0,this.state.won=!1}move(t,e,s,i){if(!this.state.alive||this.state.won)return null;const n=this.state,r=Math.sin(n.yaw),o=Math.cos(n.yaw),h=(-t*r+e*o)*J,c=(t*o+e*r)*J;if(n.vx=h,n.vz=c,n.vy-=ut*i,s&&n.grounded)return n.vy=pt,n.grounded=!1,"jump";let d=null;return d=this._integrate(i),d}_integrate(t){const e=this.state,s=this._world;let i=null;const n=e.x+e.vx*t;this._collidesAt(n,e.y,e.z)?e.vx=0:e.x=n;const r=e.z+e.vz*t;this._collidesAt(e.x,e.y,r)?e.vz=0:e.z=r;const o=e.y+e.vy*t;if(!this._collidesAt(e.x,o,e.z))e.y=o,e.grounded=!1;else{e.vy<0&&(e.y=Math.floor(e.y)+.001,e.grounded=!0);const f=e.vy<0?Math.floor(e.y-.1):Math.floor(e.y+U);s.roleAt(Math.floor(e.x),f,Math.floor(e.z))===E.BOUNCY?(e.vy=-e.vy*1.3,e.grounded=!1,i="jump"):e.vy=0}const h=Math.floor(e.x),c=Math.floor(e.y),d=Math.floor(e.z),a=s.roleAt(h,c,d),u=s.roleAt(h,c+1,d),p=a||u;if(p===E.DEADLY)e.alive=!1,i="hit";else if(p===E.PICKUP){const f=a===E.PICKUP?c:c+1,_=`${h},${f},${d}`;this._pickedUp.has(_)||(this._pickedUp.add(_),s.clear(h,f,d),e.score++,i="pickup")}else if(p===E.FINISH)e.won=!0,i="win";else if(p===E.PORTAL){const f=`${h},${c},${d}`,_=s.portalTargets[f];_&&(e.x=_[0]+.5,e.y=_[1],e.z=_[2]+.5,i="pickup")}return e.y<-5&&(e.alive=!1,i="hit"),i}_collidesAt(t,e,s){const i=this._world,n=_t;for(let r=0;r<U;r+=.8){const o=e+r;if(i.isSolid(t-n,o,s-n)||i.isSolid(t+n,o,s-n)||i.isSolid(t-n,o,s+n)||i.isSolid(t+n,o,s+n))return!0}return!!i.isSolid(t,e+U,s)}}class gt{constructor(){this._fired=new Set,this._timers=new Map}reset(){this._fired.clear(),this._timers.clear()}evaluate(t,e,s,i){const n=[];for(const r of t){if(this._fired.has(r.id))continue;let o=!1;switch(r.type){case"touch":if(r.target){const h=Math.floor(e.x),c=Math.floor(e.y),d=Math.floor(e.z),[a,u,p]=r.target;o=h===a&&(c===u||c+1===u)&&d===p}break;case"click":break;case"timer":{const h=(this._timers.get(r.id)??0)+i;this._timers.set(r.id,h),o=h>=(r.params.seconds??10);break}case"score_gte":o=e.score>=(r.params.score??1);break}if(o){this._fired.add(r.id);const h=this._executeAction(r,e,s);h&&n.push(h)}}return n}checkClick(t,e,s,i,n,r){const o=[];for(const h of t)if(!(h.type!=="click"||this._fired.has(h.id))&&h.target&&h.target[0]===e&&h.target[1]===s&&h.target[2]===i){this._fired.add(h.id);const c=this._executeAction(h,n,r);c&&o.push(c)}return o}_executeAction(t,e,s){switch(t.action){case"text":return{type:"text",text:t.params.text??""};case"sound":return{type:"sound",sound:t.params.sound??"pickup"};case"win":return e.won=!0,{type:"win"};case"lose":return e.alive=!1,{type:"lose"};case"teleport":return t.params.x!=null?(e.x=t.params.x+.5,e.y=t.params.y,e.z=t.params.z+.5,{type:"teleport",x:t.params.x,y:t.params.y,z:t.params.z}):null;case"destroy":return t.target&&s.clear(t.target[0],t.target[1],t.target[2]),{type:"sound",sound:"explode"};case"spawn_block":return t.params.x!=null&&s.set(t.params.x,t.params.y,t.params.z,t.params.blockId??1),{type:"sound",sound:"pickup"}}return null}}const Z=.12;class mt{constructor(){this.enabled=!1,this._baseAlpha=0,this._baseBeta=0,this._targetYaw=0,this._targetPitch=0,this._hasPermission=!1,this._handler=null}async requestPermission(){const t=DeviceOrientationEvent;if(typeof t.requestPermission=="function")try{const e=await t.requestPermission();this._hasPermission=e==="granted"}catch{this._hasPermission=!1}else this._hasPermission=!0;return this._hasPermission}start(){!this._hasPermission||this._handler||(this.enabled=!0,this._handler=t=>{t.alpha==null||t.beta==null||(this._targetYaw=(t.alpha-this._baseAlpha)*.4,this._targetPitch=(t.beta-this._baseBeta)*.4)},window.addEventListener("deviceorientation",this._handler))}stop(){this.enabled=!1,this._handler&&(window.removeEventListener("deviceorientation",this._handler),this._handler=null)}calibrate(){this._baseAlpha+=this._targetYaw/.4,this._baseBeta+=this._targetPitch/.4,this._targetYaw=0,this._targetPitch=0}update(t){this.enabled&&(t.state.rotationY+=(this._targetYaw-t.state.rotationY)*Z,t.state.rotationX+=(Math.max(-89,Math.min(89,this._targetPitch))-t.state.rotationX)*Z)}destroy(){this.stop()}}class yt{constructor(){this._toastTimer=0,this._moveState={u:!1,d:!1,l:!1,r:!1},this.el=document.createElement("div"),this.el.className="hud",this.el.innerHTML='<div class="hud-top"><span class="hud-score">0</span></div><div class="hud-msg"></div><div class="hud-toast"></div><div class="hud-dpad"><button class="dp dp-u" data-d="u">&#9650;</button><button class="dp dp-l" data-d="l">&#9664;</button><button class="dp dp-r" data-d="r">&#9654;</button><button class="dp dp-d" data-d="d">&#9660;</button><button class="dp dp-j" data-d="j">&#8679;</button></div>',this._score=this.el.querySelector(".hud-score"),this._msg=this.el.querySelector(".hud-msg"),this._toast=this.el.querySelector(".hud-toast"),this._dpad=this.el.querySelector(".hud-dpad"),this._bindDpad()}_bindDpad(){const t=s=>{var n;s.preventDefault();const i=s.target.dataset.d;if(i){if(i==="j"){(n=this.onJump)==null||n.call(this);return}this._moveState[i]=!0}},e=s=>{s.preventDefault();const i=s.target.dataset.d;i&&i!=="j"&&(this._moveState[i]=!1)};this._dpad.addEventListener("touchstart",t,{passive:!1}),this._dpad.addEventListener("touchend",e,{passive:!1}),this._dpad.addEventListener("mousedown",t),this._dpad.addEventListener("mouseup",e),this._dpad.addEventListener("mouseleave",e)}getMoveInput(){const t=this._moveState;return{forward:(t.u?1:0)-(t.d?1:0),right:(t.r?1:0)-(t.l?1:0)}}setScore(t){this._score.textContent=String(t)}showMessage(t){this._msg.textContent=t,this._msg.style.display=t?"block":"none"}toast(t,e=2e3){this._toast.textContent=t,this._toast.classList.add("show"),clearTimeout(this._toastTimer),this._toastTimer=window.setTimeout(()=>{this._toast.classList.remove("show")},e)}setDpadVisible(t){this._dpad.style.display=t?"flex":"none"}destroy(){this.el.remove()}}let q=null;function wt(){return q||(q=new AudioContext),q.state==="suspended"&&q.resume(),q}function T(l){try{const t=wt(),e=t.currentTime;switch(l){case"jump":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.setValueAtTime(250,e),s.frequency.linearRampToValueAtTime(600,e+.12),i.gain.setValueAtTime(.15,e),i.gain.linearRampToValueAtTime(0,e+.15),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.15);break}case"hit":{const s=t.createBuffer(1,t.sampleRate*.2|0,t.sampleRate),i=s.getChannelData(0);for(let o=0;o<i.length;o++)i[o]=(Math.random()*2-1)*(1-o/i.length);const n=t.createBufferSource(),r=t.createGain();n.buffer=s,r.gain.setValueAtTime(.2,e),r.gain.linearRampToValueAtTime(0,e+.2),n.connect(r).connect(t.destination),n.start(e);break}case"pickup":{const s=t.createOscillator(),i=t.createOscillator(),n=t.createGain();s.type="square",s.frequency.value=523,i.type="square",i.frequency.value=659,n.gain.setValueAtTime(.08,e),n.gain.linearRampToValueAtTime(0,e+.2),s.connect(n),i.connect(n),n.connect(t.destination),s.start(e),s.stop(e+.1),i.start(e+.08),i.stop(e+.2);break}case"explode":{const s=t.createBuffer(1,t.sampleRate*.4|0,t.sampleRate),i=s.getChannelData(0);for(let h=0;h<i.length;h++)i[h]=(Math.random()*2-1)*(1-h/i.length)**.5;const n=t.createBufferSource(),r=t.createGain(),o=t.createBiquadFilter();o.type="lowpass",o.frequency.value=400,n.buffer=s,r.gain.setValueAtTime(.3,e),r.gain.linearRampToValueAtTime(0,e+.4),n.connect(o).connect(r).connect(t.destination),n.start(e);break}case"win":{[523,659,784,1047].forEach((i,n)=>{const r=t.createOscillator(),o=t.createGain();r.type="square",r.frequency.value=i,o.gain.setValueAtTime(.08,e+n*.12),o.gain.linearRampToValueAtTime(0,e+n*.12+.15),r.connect(o).connect(t.destination),r.start(e+n*.12),r.stop(e+n*.12+.15)});break}case"lose":{const s=t.createOscillator(),i=t.createGain();s.type="sawtooth",s.frequency.setValueAtTime(400,e),s.frequency.linearRampToValueAtTime(100,e+.4),i.gain.setValueAtTime(.12,e),i.gain.linearRampToValueAtTime(0,e+.5),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.5);break}case"click":{const s=t.createOscillator(),i=t.createGain();s.type="sine",s.frequency.value=800,i.gain.setValueAtTime(.05,e),i.gain.linearRampToValueAtTime(0,e+.05),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.05);break}case"place":{const s=t.createOscillator(),i=t.createGain();s.type="triangle",s.frequency.value=300,i.gain.setValueAtTime(.1,e),i.gain.linearRampToValueAtTime(0,e+.08),s.connect(i).connect(t.destination),s.start(e),s.stop(e+.08);break}}}catch{}}const S=st,I=10;class vt{constructor(t){this._layer=0,this._canvasSize=S*I,this._world=t,this.el=document.createElement("div"),this.el.className="layer-panel edit-only",this.el.innerHTML='<div class="layer-header"><button class="ly-dn">&darr;</button><span class="ly-label">Layer 0 / 31</span><button class="ly-up">&uarr;</button></div><div class="layer-canvas-wrap"><canvas></canvas></div>',this._layerLabel=this.el.querySelector(".ly-label"),this._canvas=this.el.querySelector("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvas.width=this._canvasSize,this._canvas.height=this._canvasSize,this._canvas.style.width="100%",this._canvas.style.height="100%",this._canvas.style.objectFit="contain",this._canvas.style.maxWidth="400px",this._canvas.style.maxHeight="100%",this.el.querySelector(".ly-up").addEventListener("click",()=>this.setLayer(this._layer+1)),this.el.querySelector(".ly-dn").addEventListener("click",()=>this.setLayer(this._layer-1)),this._bindCanvas(),this.draw()}get layer(){return this._layer}setLayer(t){this._layer=Math.max(0,Math.min(S-1,t)),this._layerLabel.textContent=`Layer ${this._layer} / ${S-1}`,this.draw()}draw(){const t=this._ctx,e=I,s=this._world,i=this._layer,n=s.palette;t.clearRect(0,0,this._canvasSize,this._canvasSize);for(let r=0;r<S;r++)for(let o=0;o<S;o++){const h=s.get(o,i,r);if(h>0){t.fillStyle=n[h]||"#ff00ff",t.fillRect(o*e,(S-1-r)*e,e,e);const c=s.getRole(o,i,r);if(c>0){t.fillStyle="rgba(255,255,255,0.7)",t.font=`${e*.6}px sans-serif`,t.textAlign="center",t.textBaseline="middle";const d=["","!","~","*","S","F","M","P"];t.fillText(d[c]||"",o*e+e/2,(S-1-r)*e+e/2)}}else t.fillStyle=(o+r)%2===0?"#1a1a28":"#1f1f30",t.fillRect(o*e,(S-1-r)*e,e,e)}t.strokeStyle="rgba(255,255,255,0.06)",t.lineWidth=.5;for(let r=0;r<=S;r++)t.beginPath(),t.moveTo(r*e,0),t.lineTo(r*e,this._canvasSize),t.moveTo(0,r*e),t.lineTo(this._canvasSize,r*e),t.stroke()}_bindCanvas(){const t=i=>{const n=this._canvas.getBoundingClientRect(),r=this._canvasSize/n.width,o=this._canvasSize/n.height,h=(i.clientX-n.left)*r,c=(i.clientY-n.top)*o,d=Math.floor(h/I),a=S-1-Math.floor(c/I);return d<0||d>=S||a<0||a>=S?null:[d,a]};let e=!1;const s=i=>{var o;i.preventDefault();const n="touches"in i?i.touches[0]:i;if(!n)return;const r=t(n);r&&((o=this.onCellTap)==null||o.call(this,r[0],r[1],this._layer))};this._canvas.addEventListener("mousedown",i=>{e=!0,s(i)}),this._canvas.addEventListener("mousemove",i=>{e&&s(i)}),window.addEventListener("mouseup",()=>{e=!1}),this._canvas.addEventListener("touchstart",i=>{e=!0,s(i)},{passive:!1}),this._canvas.addEventListener("touchmove",i=>{e&&s(i)},{passive:!1}),this._canvas.addEventListener("touchend",()=>{e=!1})}destroy(){this.el.remove()}}class bt{constructor(t){this._selected=1,this._role=E.SOLID,this._colors=t,this.el=document.createElement("div"),this.el.className="palette-bar edit-only",this._renderSwatches(),this.roleBar=document.createElement("div"),this.roleBar.className="role-bar edit-only",this._renderRoles()}get selectedColor(){return this._selected}get selectedRole(){return this._role}get colorHex(){return this._colors[this._selected]||"#ff00ff"}_renderSwatches(){this.el.innerHTML="";for(let t=1;t<this._colors.length;t++){const e=document.createElement("div");e.className="pal-swatch"+(t===this._selected?" active":""),e.style.background=this._colors[t],e.dataset.i=String(t),this.el.appendChild(e)}this.el.addEventListener("click",t=>{var s;const e=t.target.closest(".pal-swatch");e&&(this._selected=Number(e.dataset.i),this.el.querySelectorAll(".pal-swatch").forEach(i=>i.classList.toggle("active",i===e)),(s=this.onChange)==null||s.call(this,this._selected,this._role))})}_renderRoles(){this.roleBar.innerHTML="";for(let t=0;t<W.length;t++){const e=document.createElement("button");e.className="role-btn"+(t===this._role?" active":""),e.textContent=W[t],e.dataset.r=String(t),this.roleBar.appendChild(e)}this.roleBar.addEventListener("click",t=>{var s;const e=t.target.closest(".role-btn");e&&(this._role=Number(e.dataset.r),this.roleBar.querySelectorAll(".role-btn").forEach(i=>i.classList.toggle("active",i===e)),(s=this.onChange)==null||s.call(this,this._selected,this._role))})}showRoles(t){this.roleBar.classList.toggle("show",t)}destroy(){this.el.remove(),this.roleBar.remove()}}const xt=["touch","click","timer","score_gte"],St=["destroy","teleport","text","sound","win","lose","spawn_block"];class Et{constructor(){this._triggers=[],this._nextId=1,this.el=document.createElement("div"),this.el.className="trigger-panel",this.el.innerHTML='<button class="btn-close-panel">&times;</button><h3>Triggers</h3><div class="trigger-list"></div><button class="btn-add-trigger">+ Add Trigger</button>',this._list=this.el.querySelector(".trigger-list"),this.el.querySelector(".btn-close-panel").addEventListener("click",()=>this.hide()),this.el.querySelector(".btn-add-trigger").addEventListener("click",()=>this._addTrigger())}show(){this.el.classList.add("show")}hide(){this.el.classList.remove("show")}get visible(){return this.el.classList.contains("show")}load(t){this._triggers=[...t],this._nextId=t.reduce((e,s)=>Math.max(e,s.id+1),1),this._render()}_addTrigger(){this._triggers.push({id:this._nextId++,type:"touch",target:[0,0,0],action:"text",params:{text:"Hello!"}}),this._render(),this._emit()}_removeTrigger(t){this._triggers=this._triggers.filter(e=>e.id!==t),this._render(),this._emit()}_render(){this._list.innerHTML="";for(const t of this._triggers){const e=document.createElement("div");e.className="trigger-card",e.innerHTML=`<label>IF</label><select class="t-type">${xt.map(i=>`<option value="${i}"${i===t.type?" selected":""}>${i}</option>`).join("")}</select><label>Target Block (x,y,z)</label><input class="t-target" value="${t.target?t.target.join(","):""}" placeholder="x,y,z"><label>THEN</label><select class="t-action">${St.map(i=>`<option value="${i}"${i===t.action?" selected":""}>${i}</option>`).join("")}</select><label>Params (JSON)</label><input class="t-params" value='${JSON.stringify(t.params)}'><button class="role-btn" style="margin-top:6px;color:#f44336">Delete</button>`;const s=t.id;e.querySelector(".t-type").addEventListener("change",i=>{t.type=i.target.value,this._emit()}),e.querySelector(".t-target").addEventListener("change",i=>{const n=i.target.value.split(",").map(Number);n.length===3&&n.every(r=>!isNaN(r))&&(t.target=n),this._emit()}),e.querySelector(".t-action").addEventListener("change",i=>{t.action=i.target.value,this._emit()}),e.querySelector(".t-params").addEventListener("change",i=>{try{t.params=JSON.parse(i.target.value)}catch{}this._emit()}),e.querySelector("button").addEventListener("click",()=>this._removeTrigger(s)),this._list.appendChild(e)}}_emit(){var t;(t=this.onChange)==null||t.call(this,this._triggers)}destroy(){this.el.remove()}}class Tt{constructor(t,e){this._tool="draw",this._previewAngle=35,this._undoStack=[],this._redoStack=[],this._swapped=!1,this._world=t,this._sidePanel=document.createElement("div"),this._sidePanel.className="side-panel edit-only",this._sidePanel.innerHTML='<button class="sp-btn sp-undo" title="Undo">&#8630;</button><button class="sp-btn sp-redo" title="Redo">&#8631;</button>',e.appendChild(this._sidePanel),this._undoBtn=this._sidePanel.querySelector(".sp-undo"),this._redoBtn=this._sidePanel.querySelector(".sp-redo"),this._undoBtn.addEventListener("click",()=>this._undo()),this._redoBtn.addEventListener("click",()=>this._redo()),this._previewWrap=document.createElement("div"),this._previewWrap.className="preview-3d edit-only",e.appendChild(this._previewWrap),this._previewCam=new Q("orbit"),this._previewCam.state.distance=40,this._previewCam.state.rotationX=-30,this._previewCam.state.rotationY=35,this._previewCam.state.target.set(16,6,16),this._previewRenderer=new tt(this._previewWrap,this._previewCam,300,4),this._previewMesh=new et(4),this._previewRenderer.world.appendChild(this._previewMesh.el),this._previewMesh.el.style.transformStyle="preserve-3d";const s=()=>{this._previewAngle+=.15,this._previewCam.state.rotationY=this._previewAngle,this._previewRenderer.render(),requestAnimationFrame(s)};requestAnimationFrame(s),this._swapBtn=document.createElement("button"),this._swapBtn.className="swap-btn",this._swapBtn.innerHTML="&#8644;",this._swapBtn.title="Swap views",this._previewWrap.appendChild(this._swapBtn),this._swapBtn.addEventListener("click",()=>this._toggleSwap()),this.layerGrid=new vt(t),this.layerGrid.onCellTap=(i,n,r)=>this._onCellTap(i,n,r),e.appendChild(this.layerGrid.el),this.palette=new bt(t.palette),e.appendChild(this.palette.el),e.appendChild(this.palette.roleBar),this.triggerEditor=new Et,this.triggerEditor.onChange=i=>{t.triggers=i},this.triggerEditor.load(t.triggers),e.appendChild(this.triggerEditor.el),this.toolbar=document.createElement("div"),this.toolbar.className="toolbar edit-only",this.toolbar.innerHTML='<button class="tb-draw active" data-tool="draw">Draw</button><button class="tb-erase" data-tool="erase">Erase</button><button class="tb-role" data-tool="role">Role</button><button class="tb-triggers">Triggers</button><div class="tb-spacer"></div><button class="tb-play">Play</button><button class="tb-save">Save</button><button class="tb-share">Share</button>',e.appendChild(this.toolbar),this._bindToolbar(),this._refreshPreview(),this._updateUndoButtons()}_bindToolbar(){this.toolbar.addEventListener("click",t=>{var i,n,r;const e=t.target.closest("button");if(!e)return;const s=e.dataset.tool;if(s){this._tool=s,this.toolbar.querySelectorAll("[data-tool]").forEach(o=>o.classList.toggle("active",o===e)),this.palette.showRoles(s==="role");return}e.classList.contains("tb-triggers")?this.triggerEditor.show():e.classList.contains("tb-play")?(i=this.onPlay)==null||i.call(this):e.classList.contains("tb-save")?(n=this.onSave)==null||n.call(this):e.classList.contains("tb-share")&&((r=this.onShare)==null||r.call(this))})}_onCellTap(t,e,s){const i=this._world,n=i.get(t,s,e),r=i.getRole(t,s,e);switch(this._tool){case"draw":{const o=this.palette.selectedColor,h=this.palette.selectedRole;if(n===o&&r===h)return;i.set(t,s,e,o,h),this._pushUndo(t,s,e,n,r,o,h),T("place");break}case"erase":{if(n===0)return;i.clear(t,s,e),this._pushUndo(t,s,e,n,r,0,0),T("click");break}case"role":{if(n===0)return;const o=this.palette.selectedRole;if(r===o)return;i.set(t,s,e,n,o),this._pushUndo(t,s,e,n,r,n,o),T("click");break}case"pick":n>0&&T("click");break}this.layerGrid.draw(),this._refreshPreview()}_pushUndo(t,e,s,i,n,r,o){this._undoStack.push({x:t,y:e,z:s,oldBlock:i,oldRole:n,newBlock:r,newRole:o}),this._undoStack.length>200&&this._undoStack.shift(),this._redoStack.length=0,this._updateUndoButtons()}_undo(){const t=this._undoStack.pop();t&&(this._world.set(t.x,t.y,t.z,t.oldBlock,t.oldRole),this._redoStack.push(t),this.layerGrid.draw(),this._refreshPreview(),this._updateUndoButtons(),T("click"))}_redo(){const t=this._redoStack.pop();t&&(this._world.set(t.x,t.y,t.z,t.newBlock,t.newRole),this._undoStack.push(t),this.layerGrid.draw(),this._refreshPreview(),this._updateUndoButtons(),T("click"))}_updateUndoButtons(){this._undoBtn.classList.toggle("disabled",this._undoStack.length===0),this._redoBtn.classList.toggle("disabled",this._redoStack.length===0)}_toggleSwap(){this._swapped=!this._swapped,this._previewWrap.classList.toggle("swapped",this._swapped),this.layerGrid.el.classList.toggle("swapped",this._swapped)}_refreshPreview(){this._previewMesh.rebuildFromGrid(this._world.grid,this._world.palette)}refresh(){this.layerGrid.draw(),this._refreshPreview(),this.triggerEditor.load(this._world.triggers)}setVisible(t){const e=t?"":"none";this.layerGrid.el.style.display=e,this.palette.el.style.display=e,this.palette.roleBar.style.display="none",this.toolbar.style.display=t?"flex":"none",this._previewWrap.style.display=e,this._sidePanel.style.display=t?"flex":"none",t&&this.triggerEditor.hide()}destroy(){this.layerGrid.destroy(),this.palette.destroy(),this.triggerEditor.destroy(),this.toolbar.remove(),this._previewWrap.remove(),this._previewRenderer.destroy(),this._sidePanel.remove()}}const V="voxeldom_save";function Lt(l){var t;try{const e=JSON.stringify(l);localStorage.setItem(V,e);const s=(t=window.Telegram)==null?void 0:t.WebApp;return s!=null&&s.CloudStorage&&s.CloudStorage.setItem(V,e),!0}catch{return!1}}function kt(){try{const l=localStorage.getItem(V);if(!l)return null;const t=JSON.parse(l);return t.v!==1?null:t}catch{return null}}function Pt(l){const t=JSON.stringify(l);return btoa(unescape(encodeURIComponent(t)))}function Ct(l){try{const t=decodeURIComponent(escape(atob(l))),e=JSON.parse(t);return e.v===1?e:null}catch{return null}}function O(){var l;return((l=window.Telegram)==null?void 0:l.WebApp)??null}function At(){const l=O();l&&(l.ready(),l.expand())}function Bt(l="light"){var t,e;(e=(t=O())==null?void 0:t.HapticFeedback)==null||e.impactOccurred(l)}function zt(l){var e;const t=O();t?t.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(l)}`):(e=navigator.clipboard)==null||e.writeText(l)}function X(l,t){const e=O();e&&(l?(e.BackButton.show(),t&&e.BackButton.onClick(t)):e.BackButton.hide())}class Mt{constructor(t){this._player=null,this._mode="edit",this._jumpPressed=!1,At();const e=document.querySelector(t);if(!e)throw new Error("Container not found");this._container=e,this._world=new dt;const s=new URLSearchParams(location.search).get("g");if(s){const i=Ct(s);i?this._world.deserialize(i):this._world.generateDefault()}else{const i=kt();i?this._world.deserialize(i):this._world.generateDefault()}this._engine=new nt({container:e,voxelSize:16,perspective:700}),this._mesh=new et(16),this._engine.scene.add(this._mesh),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette),this._triggers=new gt,this._gyro=new mt,this._hud=new yt,e.appendChild(this._hud.el),this._editor=new Tt(this._world,e),this._editor.onPlay=()=>this.setMode("play"),this._editor.onSave=()=>this._save(),this._editor.onShare=()=>this._share(),this._hud.onJump=()=>{this._jumpPressed=!0},this._engine.onUpdate(i=>this._update(i)),this._engine.start(),this.setMode(s?"play":"edit"),X(!1)}setMode(t){this._mode=t,this._container.className=t==="edit"?"mode-edit":"mode-play",t==="edit"?(this._editor.setVisible(!0),this._editor.refresh(),this._hud.setDpadVisible(!1),this._hud.showMessage(""),this._hud.el.style.display="none",this._player=null,this._engine.renderer.root.style.display="none",this._engine.pause(),this._gyro.stop(),X(!1)):(this._editor.setVisible(!1),this._hud.el.style.display="",this._hud.setDpadVisible(!0),this._hud.showMessage(""),this._hud.setScore(0),this._engine.renderer.root.style.display="",this._engine.resume(),this._player=new ft(this._world),this._triggers.reset(),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette),this._engine.camera.state.distance=18,this._engine.camera.state.rotationX=-25,this._gyro.requestPermission().then(e=>{e&&this._gyro.start()}),X(!0,()=>this.setMode("edit")))}_update(t){if(this._mode==="edit"){this._processEditInput();return}const e=this._player;if(!e)return;const s=this._engine.input.state.keys,i=this._hud.getMoveInput();let n=i.forward,r=i.right;(s.has("KeyW")||s.has("ArrowUp"))&&(n+=1),(s.has("KeyS")||s.has("ArrowDown"))&&(n-=1),(s.has("KeyA")||s.has("ArrowLeft"))&&(r-=1),(s.has("KeyD")||s.has("ArrowRight"))&&(r+=1);const o=this._jumpPressed||s.has("Space");this._jumpPressed=!1;const{deltaX:h,deltaY:c,pinchDelta:d}=this._engine.input.state;h&&this._engine.camera.orbit(h*.3,0),c&&this._engine.camera.orbit(0,c*.3),d&&this._engine.camera.zoom(d*2),this._engine.input.resetDeltas(),e.state.yaw=this._engine.camera.state.rotationY*(Math.PI/180),this._gyro.update(this._engine.camera);const a=e.move(n,r,o,t);a&&(T(a),Bt(a==="hit"?"heavy":"light"));const u=this._triggers.evaluate(this._world.triggers,e.state,this._world,t);this._handleEvents(u);const p=this._engine.camera.state;p.target.x+=(e.state.x-p.target.x)*.1,p.target.y+=(e.state.y+1-p.target.y)*.1,p.target.z+=(e.state.z-p.target.z)*.1,this._hud.setScore(e.state.score),e.state.alive?e.state.won&&(this._hud.showMessage("You Win!"),this._waitForTap(()=>this.setMode("edit"))):(this._hud.showMessage("You Died! Tap to retry"),this._waitForTap(()=>{e.respawn(),this._hud.showMessage(""),this._mesh.rebuildFromGrid(this._world.grid,this._world.palette)}))}_processEditInput(){this._engine.input.resetDeltas()}_handleEvents(t){for(const e of t)switch(e.type){case"text":this._hud.toast(e.text,3e3);break;case"sound":T(e.sound);break;case"win":T("win");break;case"lose":T("lose");break;case"teleport":T("pickup");break}t.some(e=>e.type==="sound"&&e.sound==="explode")&&this._mesh.rebuildFromGrid(this._world.grid,this._world.palette)}_waitForTap(t){const e=()=>{document.removeEventListener("pointerdown",e),t()};setTimeout(()=>document.addEventListener("pointerdown",e),500)}_save(){const t=this._world.serialize(),e=Lt(t);this._hud.toast(e?"Saved!":"Save failed",1500),T("pickup")}_share(){const t=this._world.serialize(),e=Pt(t),s=`${location.origin}${location.pathname}?g=${e}`;zt(s),this._hud.toast("Link copied!",1500)}}const Dt=new Mt("#app");window.voxelApp=Dt;
