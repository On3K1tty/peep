*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; overflow: hidden; font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; touch-action: none; user-select: none; -webkit-user-select: none; }

#app { width: 100vw; height: 100vh; position: relative; }
.mode-edit .play-only, .mode-play .edit-only, .mode-splash .edit-only, .mode-splash .play-only { display: none !important; }
.mode-splash .gyro-btn { display: none !important; }

/* ── Загрузочный экран (кнопка Старт включает гироскоп) ── */
.splash { position: fixed; inset: 0; z-index: 500; background: #0a0a18; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
.splash-title { font-size: min(18vw, 90px); font-weight: 900; letter-spacing: 6px; color: #fff; text-shadow: 0 0 40px rgba(76,175,80,0.4); margin-bottom: 8px; }
.splash-sub { font-size: 14px; color: #888; text-align: center; margin-bottom: 32px; max-width: 280px; }
.splash-start { width: 200px; height: 56px; border: 2px solid rgba(76,175,80,0.6); border-radius: 12px; background: rgba(76,175,80,0.2); color: #4CAF50; font-size: 20px; font-weight: 700; cursor: pointer; letter-spacing: 2px; transition: background 0.2s, transform 0.1s; }
.splash-start:active { background: rgba(76,175,80,0.45); transform: scale(0.98); }

.exit-play-btn { position:fixed; top:12px; left:12px; z-index:150; padding:10px 16px; border:none; border-radius:8px; background:rgba(20,20,30,0.9); color:#fff; font-size:14px; cursor:pointer; border:1px solid rgba(255,255,255,0.15); }
.exit-play-btn:active { background:rgba(76,175,80,0.3); }
.hud-dpad { position:absolute; bottom:16px; left:64px; display:grid; grid-template-columns:48px 48px 48px; grid-template-rows:48px 48px; gap:4px; }
.hud-dpad .dp { width:48px; height:48px; border:none; border-radius:8px; background:rgba(255,255,255,0.12); color:#fff; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.hud-dpad .dp:active { background:rgba(255,255,255,0.25); }
.hud-dpad .dp-u { grid-column:2; grid-row:1; } .hud-dpad .dp-l { grid-column:1; grid-row:2; } .hud-dpad .dp-r { grid-column:3; grid-row:2; } .hud-dpad .dp-d { grid-column:2; grid-row:2; }
.hud-zoom { position:absolute; bottom:16px; right:16px; flex-direction:column; gap:4px; z-index:110; }
.hud-zoom .hz { width:48px; height:48px; border:none; border-radius:8px; background:rgba(255,255,255,0.12); color:#fff; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.hud-zoom .hz:active { background:rgba(255,255,255,0.25); }
.hud-zoom .hz-in { border-radius:8px 8px 0 0; } .hud-zoom .hz-out { border-radius:0 0 8px 8px; }

/* ── 3D World (single feTurbulence grain on .voxel-world, no per-face noise) ── */
.vf, .vf-proc { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
.vf-proc { isolation: isolate; }
.vf-base {
  position: absolute;
  width: var(--vf-w);
  height: var(--vf-h);
  background-color: var(--vf-color);
  background-image: linear-gradient(135deg, transparent 50%, rgba(0, 0, 0, 0.12) 100%), linear-gradient(225deg, transparent 50%, rgba(0, 0, 0, 0.08) 100%);
  filter: brightness(var(--vf-brightness, 1));
  backface-visibility: hidden;
  transform-origin: 0 0;
  image-rendering: pixelated;
  pointer-events: auto;
  background-size: 100% 100%, 100% 100%;
}
.vf-top { --vf-brightness: 1; }
.vf-front { --vf-brightness: 0.85; }
.vf-back { --vf-brightness: 0.7; }
.vf-right { --vf-brightness: 0.8; }
.vf-left { --vf-brightness: 0.75; }
.vf-bottom { --vf-brightness: 0.6; }
.voxel-world { background: linear-gradient(180deg, #0f3460 0%, #16213e 40%, #1a1a2e 100%); filter: url(#voxel-grain); }
.voxel-world::before { content:''; position:fixed; inset:0; pointer-events:none; z-index:1; background:linear-gradient(to bottom,transparent 20%,rgba(0,0,0,0.25) 100%); mix-blend-mode:multiply; }

/* ── HUD (z: control above work panels) ── */
.hud { position:fixed; inset:0; pointer-events:none; z-index:100; }
.hud > * { pointer-events:auto; }
.hud-top { position:absolute; top:8px; left:0; right:0; text-align:center; font-size:18px; font-weight:700; text-shadow:0 1px 4px rgba(0,0,0,0.7); }
.hud-score::before { content:'\2B50 '; }
.hud-msg { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.75); padding:16px 28px; border-radius:10px; font-size:20px; font-weight:700; display:none; text-align:center; }
.hud-toast { position:absolute; top:60px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); padding:6px 16px; border-radius:8px; font-size:13px; opacity:0; transition:opacity 0.3s; }
.hud-toast.show { opacity:1; }

/* ── D-Pad (control layer) ── */
.hud-dpad { position:absolute; bottom:16px; left:64px; display:grid; grid-template-columns:48px 48px 48px; grid-template-rows:48px 48px; gap:4px; z-index:110; }
.dp { width:48px; height:48px; border:none; border-radius:8px; background:rgba(255,255,255,0.12); color:#fff; font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
.dp:active { background:rgba(255,255,255,0.25); }
.dp-u { grid-column:2; grid-row:1; } .dp-l { grid-column:1; grid-row:2; } .dp-r { grid-column:3; grid-row:2; } .dp-d { grid-column:2; grid-row:2; }
.hud-crosshair { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:28px; color:rgba(255,255,255,0.6); pointer-events:none; text-shadow:0 0 4px rgba(0,0,0,0.8); display:none; font-weight:300; }
.hud-shoot { position:absolute; bottom:20px; right:20px; width:64px; height:64px; border-radius:50%; border:2px solid rgba(255,100,100,0.4); background:rgba(255,50,50,0.15); color:#ff6666; font-size:32px; display:none; align-items:center; justify-content:center; cursor:pointer; }
.hud-shoot:active { background:rgba(255,50,50,0.4); }

/* ── Toolbar (compact: tighter paddings, z below control) ── */
.toolbar { position:fixed; bottom:0; left:0; right:0; background:rgba(20,20,30,0.95); backdrop-filter:blur(6px); display:flex; align-items:center; gap:2px; padding:4px 4px; z-index:90; border-top:1px solid rgba(255,255,255,0.08); }
.toolbar .tb-btn {
  flex:0 0 36px; width:36px; height:36px; border:none; border-radius:6px; background:rgba(255,255,255,0.08); color:#fff;
  cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0;
}
.toolbar .tb-group { display:flex; align-items:center; gap:2px; }
.toolbar .tb-divider { width:1px; height:22px; background:rgba(255,255,255,0.15); margin:0 2px; }
.toolbar .tb-btn:active { background:rgba(255,255,255,0.2); }
.toolbar .tb-btn.active { background:rgba(76,175,80,0.35); }
.toolbar .tb-icon { width:20px; height:20px; }
.tb-spacer { flex:1 1 0; min-width:4px; }

/* ── Layer grid (work panel, below control) ── */
.layer-grid { position:fixed; top:8px; left:96px; z-index:85; display:flex; align-items:center; gap:4px; }
.layer-grid-header { display:flex; align-items:center; justify-content:center; gap:8px; font-size:12px; color:#aaa; }
.layer-grid-label { min-width:90px; text-align:center; }
.layer-grid-btn { width:36px; height:32px; border:none; border-radius:6px; background:rgba(255,255,255,0.1); color:#fff; font-size:11px; cursor:pointer; }
.layer-grid-btn:active { background:rgba(76,175,80,0.3); }
.layer-grid-canvas { display:none; }

/* ── Editor joystick (такой же как HUD: d-pad слева, zoom справа) ── */
.editor-joystick { display:flex; position:fixed; bottom:16px; left:0; right:0; z-index:90; justify-content:space-between; align-items:flex-end; pointer-events:none; }
.editor-joystick > * { pointer-events:auto; }
.editor-joystick .ej-dpad { margin-left:64px; display:grid; grid-template-columns:48px 48px 48px; grid-template-rows:48px 48px; gap:4px; }
.editor-joystick .ej-dp { width:48px; height:48px; border:none; border-radius:8px; background:rgba(255,255,255,0.12); color:#fff; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.editor-joystick .ej-dp:active { background:rgba(255,255,255,0.25); }
.editor-joystick .ej-dp.ej-u { grid-column:2; grid-row:1; } .editor-joystick .ej-dp.ej-l { grid-column:1; grid-row:2; } .editor-joystick .ej-dp.ej-r { grid-column:3; grid-row:2; } .editor-joystick .ej-dp.ej-d { grid-column:2; grid-row:2; }
.editor-joystick .ej-zoom { margin-right:16px; display:flex; flex-direction:column; gap:2px; }
.editor-joystick .ej-z { width:48px; height:48px; border:none; border-radius:8px; background:rgba(255,255,255,0.12); color:#fff; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.editor-joystick .ej-z:active { background:rgba(255,255,255,0.25); }

/* ── 3D Editor (FULL SCREEN, Minecraft-style) ── */
.editor-3d { position:fixed; top:0; left:0; right:0; bottom:86px; z-index:80; }
.editor-3d .voxel-world { background:linear-gradient(180deg,#0f3460 0%,#16213e 40%,#1a1a2e 100%); }

/* ── Undo/Redo Side Panel (work panel) ── */
.side-panel { position:fixed; top:8px; left:8px; display:flex; flex-direction:column; gap:2px; z-index:88; }
.sp-btn { width:38px; height:38px; border:none; border-radius:8px; background:rgba(20,20,30,0.85); color:#fff; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1); }
.sp-btn:active { background:rgba(76,175,80,0.3); }
.sp-btn.disabled { opacity:0.3; pointer-events:none; }

/* ── Stamp Panel (work panel) ── */
.stamp-panel { position:fixed; left:8px; right:8px; bottom:48px; z-index:86; background:rgba(20,20,30,0.96); border:1px solid rgba(255,255,255,0.1); border-radius:8px; padding:6px; display:flex; flex-direction:column; gap:4px; max-height:200px; overflow-y:auto; }
.stamp-cat { }
.stamp-cat-header { width:100%; display:flex; align-items:center; gap:8px; padding:8px 12px; border:none; border-radius:8px; background:rgba(255,255,255,0.06); color:#fff; font-size:14px; cursor:pointer; text-align:left; }
.stamp-cat-header:active, .stamp-cat-header.open { background:rgba(76,175,80,0.2); }
.stamp-cat-icon { font-size:20px; }
.stamp-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(64px, 1fr)); gap:4px; padding:6px 0 2px 8px; }
.stamp-btn { display:flex; flex-direction:column; align-items:center; gap:2px; padding:6px 4px; border:none; border-radius:8px; background:rgba(255,255,255,0.08); color:#fff; font-size:11px; cursor:pointer; }
.stamp-btn:active { background:rgba(255,255,255,0.2); }
.stamp-btn.active { background:rgba(76,175,80,0.35); }
.stamp-btn-icon { font-size:24px; line-height:1; }

/* ── Palette (work panel) ── */
.palette-bar { position:fixed; left:0; right:0; bottom:42px; background:rgba(20,20,30,0.92); padding:2px 4px; display:flex; gap:2px; overflow-x:auto; z-index:87; border-top:1px solid rgba(255,255,255,0.05); }
.pal-swatch { width:28px; height:28px; border-radius:5px; border:2px solid transparent; cursor:pointer; flex-shrink:0; }
.pal-swatch.active { border-color:#fff; box-shadow:0 0 0 1px rgba(0,0,0,0.5); }

/* ── Role Selector ── */
.role-bar { position:fixed; left:0; right:0; bottom:82px; background:rgba(20,20,30,0.92); padding:4px 6px; display:none; gap:3px; overflow-x:auto; z-index:95; }
.role-bar.show { display:flex; }
.role-btn { height:26px; padding:0 8px; border:none; border-radius:5px; background:rgba(255,255,255,0.08); color:#ccc; font-size:10px; cursor:pointer; flex-shrink:0; text-transform:uppercase; }
.role-btn.active { background:rgba(76,175,80,0.3); color:#fff; }

/* ── Trigger Editor Panel ── */
.trigger-panel { position:fixed; inset:0; background:rgba(10,10,20,0.95); z-index:200; display:none; flex-direction:column; overflow-y:auto; padding:12px; }
.trigger-panel.show { display:flex; }
.trigger-panel h3 { font-size:16px; margin-bottom:10px; }
.trigger-card { background:rgba(255,255,255,0.06); border-radius:10px; padding:10px; margin-bottom:8px; }
.trigger-card label { font-size:11px; color:#888; text-transform:uppercase; display:block; margin-bottom:4px; }
.trigger-card select, .trigger-card input { width:100%; height:32px; border:1px solid rgba(255,255,255,0.1); border-radius:6px; background:rgba(0,0,0,0.3); color:#fff; padding:0 8px; font-size:13px; margin-bottom:6px; }
.btn-add-trigger { height:36px; border:1px dashed rgba(255,255,255,0.2); border-radius:8px; background:transparent; color:#888; width:100%; cursor:pointer; font-size:13px; }
.btn-close-panel { position:absolute; top:10px; right:10px; width:32px; height:32px; border:none; border-radius:50%; background:rgba(255,255,255,0.1); color:#fff; font-size:18px; cursor:pointer; }

/* ── Gyro toggle (editor + play) — control layer above toolbar ── */
.gyro-btn { position:fixed; bottom:24px; left:12px; z-index:120; width:48px; height:48px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:background 0.2s; }
.gyro-btn.off .gyro-icon { background:#c62828; box-shadow:0 0 8px rgba(198,40,40,0.5); }
.gyro-btn.on .gyro-icon { background:#1b5e20; box-shadow:0 0 8px rgba(27,94,32,0.5); }
.gyro-btn:active .gyro-icon { filter:brightness(1.2); }
.gyro-icon { width:24px; height:24px; border-radius:50%; transition:background 0.2s; }

/* ── Race (2D canvas) ── */
.race-wrap { position:fixed; inset:0; z-index:250; }
.race-canvas { display:block; width:100%; height:100%; }

/* ── White flash transition ── */
.flash { position:fixed; inset:0; z-index:400; background:#fff; opacity:0; transition:opacity 0.8s; pointer-events:none; }
.flash.on { opacity:1; }
